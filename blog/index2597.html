<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?paged=14 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:10:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software  </title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
			<li id="linkcat-16" class="linkcat"><h2>Blogroll</h2>
	<ul>
<li><a href="http://ayende.com/Blog">Ayende Rahien</a></li>
<li><a href="http://www.softinsight.com/bnoyes/default.aspx">Brian Noyes</a></li>
<li><a href="http://chriskoenig.net/">Chris Koenig</a></li>
<li><a href="http://scienceblogs.com/goodmath/" title="MarkCC reveals the beauty in mathematics and exposes its misuse.">Good Math, Bad Math</a></li>
<li><a href="http://joshsmithonwpf.wordpress.com/">Josh Smith on WPF</a></li>
<li><a href="http://west-wind.com/Weblog/default.aspx">Rick Strahl</a></li>
<li><a href="http://www.udidahan.com/?blog=true">Udi Dahan</a></li>

	</ul>
</li>
<li id="linkcat-17" class="linkcat"><h2>Links</h2>
	<ul>
<li><a href="http://www.absg.com/" title="my day job">ABSG</a></li>
<li><a href="http://www.d20universe.com/" title="my friends boostrap">d20 Universe</a></li>
<li><a href="http://updatecontrols.net/" title="my open source project">Update Controls .NET</a></li>

	</ul>
</li>
<li id="linkcat-32" class="linkcat"><h2>Podroll</h2>
	<ul>
<li><a href="http://dotnetrocks.com/" title="Interviews with leaders in the .NET community.">.NET Rocks!</a></li>
<li><a href="http://hanselminutes.com/" title="News and interviews from all aspects of software, with an insider&#039;s view of Microsoft.">Hanselminutes</a></li>

	</ul>
</li>
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

	
		
			<div class="post" id="post-413">
				<h2><a href="index672e.html?p=413" rel="bookmark" title="Permanent Link to MVVM and Linq to SQL the easy way">MVVM and Linq to SQL the easy way</a></h2>
				<small>August 9th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Download the <a href="wp-content/uploads/2009/08/noteworthy.zip">source code</a> and follow along.</p>
<p>The biggest challenge implementing the MVVM pattern is the View Model responding to changes in the Data Model. Usually, the View Model needs to subscribe to the PropertyChanged events fired by the Data Model, update its internal state, and then fire its own PropertyChanged events for the View. That's the hard way.</p>
<p>The easy way is to use <a href="http://updatecontrols.net/">Update Controls</a>. With Update Controls, you just decorate the Data Model and wrap the View Model. The library takes care of everything in between.</p>
<p><strong>Decorate a Linq to SQL data model</strong><br />
You decorate the data model by adding <a href="http://updatecontrols.net/documentation/classDocumentation/vb/UpdateControls.Independent.do">Independent</a> sentries to every property. Whenever the property is accessed, call OnGet(). Whenever it is modified, call OnSet(). To decorate a Linq to SQL data model, we just need to inject these calls into the generated code. Unfortunately, the Linq to SQL code generator does not give you a way to easily tweak its output.</p>
<p>Damien Guard has solved that problem. His open source project <a href="http://l2st4.codeplex.com/">LINQ to SQL templates for T4</a> is incredibly easy to set up and start using. It drops straight into Visual Studio and replaces the build-in code generator with one that you control. With just a few edits to his provided T4 template, I replaced INotifyPropertyChanged with Independent sentries.</p>
<p>I added a sentry for each single-valued property, and called OnGet() inside of the getter and OnSet() in the setter. I also added a sentry for each collection. They require OnGet() in the getter, and OnSet() when something is added or removed. Finally, I added a sentry per table, to take care of the top-level queries. For these, I call OnSet() on any insert, update, and delete. The final T4 template is in the example source code.</p>
<p><strong>Wrap the view model for WPF</strong><br />
Wrapping the view model for the view is a one-liner.</p>
<pre><span style="color: blue">public</span> Window1()
{
    InitializeComponent();

    <span style="color: green">// Create a data model and a navigation model.</span>
    _blog = <span style="color: blue">new</span> Blog();
    BlogNavigationModel navigationModel = <span style="color: blue">new</span> BlogNavigationModel();

    <span style="color: green">// Put them both in a view model, then wrap it for the view.</span>
    <span style="color: blue">this</span>.DataContext = <strong>ForView.Wrap</strong>(<span style="color: blue">new</span> BlogViewModel(_blog, navigationModel));
}</pre>
<p>We create a view model based on the decorated data model and a similarly decorated navigation model (more on that later). Then we let Update Controls wrap it up before we give it to the view.</p>
<p><strong>View model per scope</strong><br />
<a href="wp-content/uploads/2009/08/noteworthy.png"><img src="wp-content/uploads/2009/08/noteworthy-thumb.png" style="border: 0px none " alt="Noteworthy" width="209" align="right" border="0" height="244" /></a>The example application -- Noteworthy -- is a blog editor. Different parts of the view focus on different granularities of data. The main view (shown in red) focuses on the blog as a whole. The article list items and detail pane (shown in blue) focus on a single article. And the tag list items (shown in green) focus on a single tag.</p>
<p>We define one view model class for each of these three scopes. Each one takes constructor parameters to put itself in context. So the BlogViewModel takes a Blog, the ArticleViewModel takes a Blog and an Article, and the TagViewModel takes a Blog and a Tag.</p>
<p>The DataContext property of a WPF control determines where it begins for data binding. If you don't set it, the control inherits it from its parent. If the control is an item in a list, then it is automatically set to an element of the ItemsSource. Finally, you can data bind to a property of its parent scope. Noteworthy uses all three techniques.</p>
<p><strong>Property per control attribute</strong><br />
WPF data binding connects control attributes to object properties. So within each view model, we define a property for each attribute of a control. The view model exists to serve of the view, so this one-to-one mapping is to be expected. The view model is an isolation layer designed to keep these view-specific concerns out of your data model.</p>
<p><strong>Navigation model per user context</strong><br />
The user of your application has a conceptual model of how controls should work together. Noteworthy is a single window program, so they expect all of the controls on that window to interact appropriately. If it had multiple child windows all within a parent, they would expect each window to be its own context, but participate within the context of the main window. And if it were a composite application, they would expect all of the components to work together.</p>
<p>Where the user draws their conceptual boundary, we create a navigation model. A navigation model records the user's point-of-view as they navigate through the application. It keeps track of their selection and temporary input.</p>
<p>All of the state in the navigation model is transient. Nothing is written to the database. Persistent state belongs in the data model. This keeps the view model completely stateless. The view model has only behavior, which depends upon the data model and the navigation model.</p>
<p>Because the navigation model is transient, we just write fields, select them, and hit Ctrl+D, G to generate the properties. For example, here's the property that records the selected article. The part that I wrote by hand is highlighted:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> BlogNavigationModel
{
<strong>    <span style="color: blue">private</span> Article _selectedArticle;
</strong>
    <span style="color: blue">#region</span> Independent properties
    <span style="color: green">// Generated by Update Controls --------------------------------</span>
    <span style="color: blue">private</span> Independent _indSelectedArticle = <span style="color: blue">new</span> Independent();

    <span style="color: gray">/// &lt;summary&gt;</span>
    <span style="color: gray">/// The article for which to display details.</span>
    <span style="color: gray">/// &lt;/summary&gt;</span>
    <span style="color: blue">public</span> Article SelectedArticle
    {
        <span style="color: blue">get</span> { _indSelectedArticle.OnGet(); <span style="color: blue">return</span> _selectedArticle; }
        <span style="color: blue">set</span> { _indSelectedArticle.OnSet(); _selectedArticle = value; }
    }
    <span style="color: green">// End generated code --------------------------------</span>
    <span style="color: blue">#endregion</span>
}</pre>
<p>The properties of the navigation model are always data model types, never view model types. The view model depends upon the navigation model, not vice-versa.</p>
<p><strong>Explore on your own</strong><br />
That's just enough to get you started. There are many interesting patterns that came together in the making of Noteworthy. Here are some that you might want to examine on your own:</p>
<ul>
<li>The BlogViewModel.Articles property is filtered by the selected tag.</li>
<li>The article detail pane is a Grid within a Grid. The outer grid binds IsEnabled, while the inner grid binds DataContext.</li>
<li>The TagListBoxStyle resource binds the ListBoxItem.IsSelected attribute to the TagViewModel.TagIsSelected property to support multiple selection.</li>
<li>The Blog data model class uses a Dependent sentry to cache Tags.</li>
<li>Every view model setter and command that affects the data model calls SubmitChanges.</li>
<li>The ArticleViewModel.AvailableTags property uses .Except() to get all tags not assigned to the article.</li>
<li>The BlogViewModel.SelectedArticle property wraps the data object from the navigation model in a view model, and then unwraps it on the way back.</li>
<li>The first tag in BlogViewModel.Filters is actually not a tag at all. It is a null to represent the lack of a filter.</li>
</ul>
<p>Expect future posts to return to this example and explore these points in more detail.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a>,  <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="index672e.html?p=413#comments" title="Comment on MVVM and Linq to SQL the easy way">1 Comment &#187;</a></p>
			</div>

		
			<div class="post" id="post-410">
				<h2><a href="index0ed6.html?p=410" rel="bookmark" title="Permanent Link to Math 101 for developers">Math 101 for developers</a></h2>
				<small>August 6th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>My development process is deeply mathematical. It is based on the work of Bertrand Meyer and other computer scientists. Math is severely under represented among today's TDD/YAGNI/Agile/anti-BDUF digerati. I like to think through the problem before putting hands to keyboard, and I don't like being told I'm wrong for doing so. So to fill the void, I will be presenting my own mathematically-based process.</p>
<p>When people hear "math", they get scared. They think about how they struggled through trig class, or how statistics kicked their butts. If your palms sweat when you think about geometry, please calm down and bear with me. The math that we are going to talk about is not hard. You just have to think things through logically.</p>
<p><strong>Null reference exceptions</strong><br />Even though my process begins away from the keyboard, I'll begin this discussion with code. We can work backwards from there.</p>
<p>Your first exercise is to prove that this code does not throw a null reference exception.</p>
<pre><span style="color: blue">class</span> DogLover
{
	<span style="color: blue">public</span> <span style="color: blue">void</span> BuyAPet(Store store)
	{
		Pet pet = store.BuyDog();

		<span style="color: blue">if</span> (pet == <span style="color: blue">null</span>)
			<span style="color: blue">throw</span> <span style="color: blue">new</span> Exception(<span style="color: maroon">"No dogs were available."</span>);
		<span style="color: blue">else</span>
			pet.Feed();
	}
}</pre>
<p>We don't know anything about the <strong>BuyDog()</strong> method. It may return null or it may not. We have to check the contract. Not many programming languages have a way to encode a contract (Eiffel and Spec# are the only two that come to mind), so we usually rely on comments if we write a contract at all. Here's the contract for <strong>BuyDog()</strong>:</p>
<pre><span style="color: gray">/// &lt;summary&gt;</span>
<span style="color: gray">/// Buy a dog from the pet store.</span>
<span style="color: gray">/// &lt;/summary&gt;</span>
<span style="color: gray">/// &lt;returns&gt;A dog if one is available, or null if they are out of stock.&lt;/returns&gt;</span>
<span style="color: blue">public</span> Pet BuyDog()
{
	<span style="color: green">// ...</span>
}</pre>
<p>So the contract tells us that <strong>BuyDog()</strong> could return null. That is its postcondition: the part of the contract that promises what will be true. Based on this postcondition, we cannot prove that <strong>pet</strong> is not null right after the call.</p>
<p>But we do have a check in the code. As you enter the "else", we know that the "if" condition is false. Therefore, <strong>pet != null</strong>. <strong>pet.Feed()</strong> does not throw a null reference exception.</p>
<p>That is the complexity of proof that I'm talking about. It's really easy to do. Much easier than anything you'll see in Euclid's Elements.</p>
<p><strong>Preconditions</strong><br />Go back and check the code again. There is a case that we did not consider. We proved that <strong>pet.Feed()</strong> will not throw, but we did not prove that <strong>store.BuyDog()</strong> is safe. There are two ways to do so: add a check, or add a precondition.</p>
<p>If we add a check before <strong>store.BuyDog()</strong>, then the same proof as above applies. This is known as "defensive programming". I personally do not like defensive programming because of all the noise it adds to code. I much prefer preconditions.</p>
<p>A precondition is part of the contract. It is a requirement that certain conditions must be true before you call a method. We add a precondition like so:</p>
<pre><span style="color: gray">/// &lt;summary&gt;</span>
<span style="color: gray">/// Buy a pet from a store.</span>
<span style="color: gray">/// &lt;/summary&gt;</span>
<span style="color: gray">/// &lt;param name="store"&gt;The store from which to buy the pet.</span>
<span style="color: gray">/// Must not be null.&lt;/param&gt;</span>
<span style="color: blue">public</span> <span style="color: blue">void</span> BuyAPet(Store store)
{
	<span style="color: green">// ...</span>
}</pre>
<p>Now the caller knows that he cannot pass null.</p>
<p>But this comment did nothing to change the behavior of the code! How does this solve the problem?</p>
<p>The problem is not what the code actually does. The problem is that you couldn't <em>prove</em> that the code worked. Now you can. The <strong>BuyAPet()</strong> method lives inside of a larger system. If there ever was a problem, you would know that the author of <strong>BuyAPet()</strong> proved his code; the caller did not. Therefore the bug is in the calling code.</p>
<p>Most compilers do not do this proof for you. Eiffel verifies contracts at run time, not at compile time. Spec# can do some simple proofs at compile time (including this one), but is not yet adopted for commercial use. Still, if dynamic languages can get away with not checking <em>types</em> until run time, I'm fine with not checking <em>contracts</em> until run time. That's what unit tests are for.</p>
<p><strong>Predicates</strong><br />Let's modify the code a bit.</p>
<pre><span style="color: gray">/// &lt;summary&gt;</span>
<span style="color: gray">/// Buy a pet from a store.</span>
<span style="color: gray">/// &lt;/summary&gt;</span>
<span style="color: gray">/// &lt;param name="store"&gt;The store from which to buy the pet.</span>
<span style="color: gray">/// Must not be null.&lt;/param&gt;</span>
<span style="color: blue">public</span> <span style="color: blue">void</span> BuyAPet(Store store)
{
<strong>	<span style="color: blue">if</span> (store.DogsInStock &lt; <span style="color: maroon">1</span>)
		<span style="color: blue">throw</span> <span style="color: blue">new</span> Exception(<span style="color: maroon">"No dogs were available."</span>);
</strong>
	Pet pet = store.BuyDog();
	pet.Feed();
}</pre>
<p>We've removed the check for <strong>pet == null</strong>. Can you prove that this code is safe?</p>
<p>You still can if you define a predicate on Store.</p>
<pre><span style="color: gray">/// &lt;summary&gt;</span>
<span style="color: gray">/// The number of dogs available for sale.</span>
<span style="color: gray">/// &lt;/summary&gt;</span>
<span style="color: blue">public</span> <span style="color: blue">int</span> DogsInStock { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

<span style="color: gray">/// &lt;summary&gt;</span>
<span style="color: gray">/// Buy a dog from the pet store.</span>
<span style="color: gray">/// &lt;/summary&gt;</span>
<span style="color: gray">/// &lt;returns&gt;A dog if DogsInStock &gt; 0, or null otherwise.&lt;/returns&gt;</span>
<span style="color: blue">public</span> Pet BuyDog()
{
	<span style="color: green">// ...</span>
	<span style="color: blue">return</span> <span style="color: blue">null</span>;
}</pre>
<p>The postcondition on <strong>BuyDog()</strong> now references the property <strong>DogsInStock</strong>. We can use that in our proof. Now the steps are:</p>
<ol>
<li>If we reached <strong>store.BuyDog()</strong>, then <strong>store.DogsInStock &lt; 1</strong> is false.</li>
<li><strong>store.DogsInStock &lt; 1</strong> is false implies <strong>store.DogsInStock &gt;= 1</strong> is true.</li>
<li><strong>store.DogsInStock &gt;= 1</strong> implies <strong>store.DogsInStock &gt; 0</strong> (since <strong>DogsInStock</strong> is an integer).</li>
<li>By the precondition of <strong>BuyDog()</strong>, <strong>DogsInStock &gt; 0</strong> implies that a non-null dog is returned.</li>
<li><strong>pet</strong> is not null.</li>
<li><strong>pet.Feed()</strong> does not throw.</li>
</ol>
<p>I would usually not spell out these steps so explicitly, but these are the thoughts that go through my mind as I read and write code.</p>
<p><strong>Concurrency</strong><br />There is one small detail that I conveniently ignored in the prior proof. If we allow for concurrent access of the <strong>Store</strong>, then the proof is invalid. We cannot rely on <strong>DogsInStock &gt; 0</strong> when we get to step 4, since that might be changed in a different thread.</p>
<p>Concurrency is the devil for proofs. Functional languages lend themselves better to proof specifically because they disallow concurrent modification of an object; all objects are immutable, so there is no way that another thread could modify it. But hope is not lost.</p>
<p>In my code, I explicitly call out the parts that could be used concurrently. If nothing is said, then the code is not assumed to be thread-safe. You are therefore not allowed to call it concurrently. Since <strong>BuyAPet()</strong> makes no promise of thread safety, it would be incorrect to call it on multiple threads without guaranteeing that no other thread is using the same <strong>DogLover</strong> or <strong>Store</strong>. It is an implied precondition, but it is still a precondition.</p>
<p>I limit the amount of multi-threaded code in my applications. By the time I get to business logic, I've isolated the object and all of its parameters. They are either immutable or owned by that thread by the time the method is called. This allows me to use proof even in the face of concurency. And I can do so without adding noise to the business code in the form of locks or explicit preconditions.</p>
<p>Proof is a valuable tool in software development. Take a look at the code you wrote today and see if you can prove that it does not reference null.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="index0ed6.html?p=410#respond" title="Comment on Math 101 for developers">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-409">
				<h2><a href="indexe145.html?p=409" rel="bookmark" title="Permanent Link to How to not implement INotifyPropertyChanged">How to not implement INotifyPropertyChanged</a></h2>
				<small>August 4th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>A quick search reveals that many people have tackled the problem of implementing INotifyPropertyChanged. Here are just a few:</p>
<ul>
<li><a href="http://karlshifflett.wordpress.com/2009/08/02/inotifypropertychanged-how-to-remove-the-property-name-string-code-smell/" title="http://karlshifflett.wordpress.com/2009/08/02/inotifypropertychanged-how-to-remove-the-property-name-string-code-smell/">Karl on WPF using stack frames</a></li>
<li><a href="http://mbrownchicago.spaces.live.com/blog/cns!2221DC39E0C749A4!1285.entry" title="http://mbrownchicago.spaces.live.com/blog/cns!2221DC39E0C749A4!1285.entry">Brownie Points using lambdas</a></li>
<li><a href="http://www.nablasoft.com/alkampfer/index.php/2008/08/14/how-to-implement-inotifypropertychanged-with-codedom/" title="http://www.nablasoft.com/alkampfer/index.php/2008/08/14/how-to-implement-inotifypropertychanged-with-codedom/">Alkampfer using CodeDom</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/ms743695.aspx" title="http://msdn.microsoft.com/en-us/library/ms743695.aspx">Microsoft's advice in MSDN</a></li>
<li><a href="http://www.codeproject.com/KB/cs/BindBetterINotifyProperty.aspx" title="http://www.codeproject.com/KB/cs/BindBetterINotifyProperty.aspx">PConverse with a basic example on Code Project</a></li>
<li><a href="http://compositeextensions.codeplex.com/Thread/View.aspx?ThreadId=53731" title="http://compositeextensions.codeplex.com/Thread/View.aspx?ThreadId=53731">Composite Extensions comparing techniques on Codeplex</a></li>
<li><a href="http://thetreeknowseverything.net/2009/01/21/auto-implement-inotifypropertychanged-with-aspects/" title="http://thetreeknowseverything.net/2009/01/21/auto-implement-inotifypropertychanged-with-aspects/">Mike Saunders using aspects</a></li>
<li><a href="http://danielvaughan.orpius.com/post/Property-Change-Notification-using-a-Weak-Referencing-Strategy.aspx" title="http://danielvaughan.orpius.com/post/Property-Change-Notification-using-a-Weak-Referencing-Strategy.aspx">Daniel Vaughan using a flow-through class for weak references</a></li>
<li><a href="http://ayende.com/Blog/archive/2009/08/07/nhibernate-amp-inotifypropertychanged.aspx">Ayende using dynamic proxy</a></li>
</ul>
<p>Here's my solution: DON'T!</p>
<p>You do not need to implement INotifyPropertyChanged in order to do data binding. <a href="http://updatecontrols.net/">Update Controls</a> will do it for you. It works in Winforms, in WPF, and in <a href="http://updatecontrolslight.codeplex.com/">Silverlight</a>.</p>
<p><strong>What's the problem, anyway?</strong><br />
The problem that most people see with this interface is the "magic string". You have to pass the name of the property in the event args. Many of these solutions use reflection to figure out the property name for you. That solves the magic string problem.</p>
<p><strong>But that's not the real problem!</strong></p>
<p>The real problem is that these techniques only work with independent properties. If one property depends upon another, then these techniques fail.</p>
<p>Take a closer look at <a href="http://www.codeproject.com/KB/cs/BindBetterINotifyProperty.aspx">PConverse's solution published in Code Project</a>. In his RegularPerson class, DisplayName depends upon both FirstName and LastName. It has no backing field. It has no setter. It is a dependent property.</p>
<p>Look at the extra work he has to do in NotifiablePerson to fire PropertyChanged for DisplayName. He has to explicitly write code in the setters of both FirstName and LastName. Both of these properties have to "know" that DisplayName depends upon them.</p>
<p>That's a backwards dependency. FirstName and LastName should not know about DisplayName; DisplayName knows about FirstName and LastName.</p>
<p>Compare that to the same code using Update Controls.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Person
{
    <span style="color: blue">private</span> <span style="color: blue">string</span> _firstName;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _lastName;

    <span style="color: blue">private</span> Independent _indFirstName = <span style="color: blue">new</span> Independent();
    <span style="color: blue">private</span> Independent _indLastName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> <span style="color: blue">string</span> FirstName
    {
        <span style="color: blue">get</span> { _indFirstName.OnGet(); <span style="color: blue">return</span> _firstName; }
        <span style="color: blue">set</span> { _indFirstName.OnSet(); _firstName = value; }
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> LastName
    {
        <span style="color: blue">get</span> { _indLastName.OnGet(); <span style="color: blue">return</span> _lastName; }
        <span style="color: blue">set</span> { _indLastName.OnSet(); _lastName = value; }
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> DisplayName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> FirstName + <span style="color: maroon">" "</span> + LastName; }
    }
}</pre>
<p>Niether FirstName nor LastName know about DisplayName. The dependencies are one-way and in the correct direction.</p>
<p><strong>Maintainability is the problem</strong><br />
The above example is small and manageable. But imagine what happens when this application grows. Backwards dependencies get out of hand. They cross class boundaries and cause tight coupling between objects. Pretty soon the application is nothing but dependency management.</p>
<p>So please, stop inventing better ways to implement INotifyPropertyChanged. It's like inventing a better way to turn the the crank on the front of a Model T. There is no good way. Just don't do it.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="indexe145.html?p=409#respond" title="Comment on How to not implement INotifyPropertyChanged">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-408">
				<h2><a href="index43fc.html?p=408" rel="bookmark" title="Permanent Link to Greg Young on a solution to CRUD">Greg Young on a solution to CRUD</a></h2>
				<small>July 30th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Greg Young gave a talk at QCon last year entitled <a title="http://www.infoq.com/presentations/greg-young-unshackle-qcon08" href="http://www.infoq.com/presentations/greg-young-unshackle-qcon08">Unshackle Your Domain</a>. In it, he offers a solution to <a href="index4efb.html?p=405">CRAPpy</a> -- sorry I mean CRUDdy -- services.</p>
<p>CRUD services expose a set of objects. A client gets an object (Read), makes changes to it, and puts it back (Update, or Alter). One big problem with CRUD is that it is not auditable. There is no record of the change. Sure, you can keep a parallel audit history, but if your system does not rely upon that history, how can you trust it?</p>
<p>Greg points out that accountants don't make changes to objects. They keep histories. They never Update (Alter) records, and they never Delete (Purge). Their work is completely auditable. Their legers have a running total, but that current state is always based on history. <strong>Changes, not objects, are the foundation of their domain.</strong></p>
<p><strong>Record changes, not state</strong><br />Greg proposes that a service can be modeled as a series of changes, rather than a collection of objects. In many domains, the set of changes is just as important as the set of objects. This is the only way to truly trust your audit log.</p>
<blockquote><p>State transitions are an important part of our problem space and should be modeled within our domain.<br /> - Greg Young</p>
</blockquote>
<p>In addition to making a system auditable, this solves a whole host of validation and consistency problems. For example, in a CRUD service, we would model a customer as:</p>
<pre><span style="color: blue">class</span> Customer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}</pre>
<p>As a domain object, it would have validation. For example, the City must be within the State. But what if the customer moves from Dallas, Texas to Tulsa, Oklahoma? There is no method to get us there in one step. We either have to transition through Tulsa, Texas or Dallas, Oklahoma. We have to allow our object to be in an invalid state.</p>
<p>More subtle is the FirstName/LastName pair. There is no validation here, but it is just as incorrect to change one without the other.</p>
<p>Now consider the CRUD operations:</p>
<pre>CreateCustomer(Customer c);
UpdateCustomer(Customer c);
DeleteCustomer(Customer c);
List&lt;Customer&gt; GetCustomersByCity(<span style="color: blue">string</span> city, <span style="color: blue">string</span> state);</pre>
<p>Suppose one client gets a customer and changes their name. At the same time, another client gets the same customer and changes their address. How does the server reconcile these two changes? There should be no conflict: the two clients performed two independent operations. But because we funnel all of the changes through UpdateCustomer, we cannot easily separate them.</p>
<p><strong>A change-oriented service model</strong><br />Greg proposes that the service should model the changes as first-class citizens. For example:</p>
<pre>change AddCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}

change RenameCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
}

change MoveCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}

change RemoveCustomer
{
  identity CustomerId;
}</pre>
<p>Each of these changes is a command object that is routed through the system. They are stored in a sequential log on the server. The current state of a customer is driven exclusively from this set of command objects. Since there is no other way to change a customer, the audit log can be trusted.</p>
<p><strong>Command/query separation</strong><br />A command changes the state of the system, and a query examines it.</p>
<p>Queries tend to be synchronous, since the server returns results. Some patterns such as AJAX perform queries asynchronously by providing a callback method to capture the results. Even so, the client is in a waiting state until the results are delivered, so the query is synchronous in essence if not in actual fact.</p>
<p>Commands tend to be asynchronous, since the server returns no results. The client only needs a guarantee that the server has received the command. Message queues are often used for commands.</p>
<p>A query can be retried with no ill effects. But this is not always true with a command. if a command is not idempotent, then we must ensure that it is executed once and only once.</p>
<p>Queries and commands are two very different things. Because they have different requirements, they should be handled with separate mechanisms. RPC-based systems, unfortunately, provide onlyl one mechanism for all messaging. There is no enforcement that queries have no side effects, or that commands return no results. As a consequence, queries and commands tend to be intermingled within a single RPC.</p>
<p>Greg proposes a different architecture. When commands are treated as first-class citizens, the separation between commands and queries is easy. Commands are sent to an audit log, and queries are processed out of a reporting database. Don't let the term <em>reporting database</em> confuse you; to Greg any query is a report.</p>
<p><a href="wp-content/uploads/2009/07/command-query.jpg"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="487" alt="command_query" src="wp-content/uploads/2009/07/command-query-thumb.jpg" width="596" border="0"></a> </p>
<p><strong>Eventual consistency</strong><br />The client workstation, the audit log, and the reporting database are three separate bounded contexts. Each has its own storage schema, its own transaction boundary, and its own interface. The three environments are isolated from one another. The only way for them to reach an agreement is for them to communicate.</p>
<p>Communication takes time. We must allow our distributed systems to be out-of-sync for that time. We cannot guarantee consistency across these bounded contexts at all times. The best we can do is to guarantee that they will become consistent eventually.</p>
<blockquote>
<p>Most bounded contexts can interact with relaxed consistency.<br /> - Greg Young</p>
</blockquote>
<p>It will take time for data to flow through the system. Sometimes that time is not important. But sometimes decisions must be made with the most up-to-date data possible. Only a domain expert can tell us the difference.</p>
<p>When we acknowledge the fact that communication takes time, we open up a whole new set of discussions with the domain experts. Now we can ask how long is too long. We can start defining service level agreements at the command level. And we can start measuring those times to see when the SLA is violated.</p>
<p>Don't take consistency as a given. Don't automatically define a CRUD service. Take the time to model the changes in your domain. Make those changes part of your discussion with the domain experts. Make them part of your solution.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index43fc.html?p=408#respond" title="Comment on Greg Young on a solution to CRUD">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-405">
				<h2><a href="index4efb.html?p=405" rel="bookmark" title="Permanent Link to Alter and Purge">Alter and Purge</a></h2>
				<small>July 28th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>You are aware of the CRUD operations:</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Update</li>
<li>Delete</li>
</ul>
<p>Two of these operations are perfectly safe. The other two are destructive.</p>
<p>When you update state, you destroy what used to be there. The old information is lost, overwritten with the new. An audit cannot see beyond the update into the past.</p>
<p>When you delete state, you destroy it outright. I'm referring to a hard delete. A soft delete does not destroy information. But a soft delete is not really a delete.</p>
<p><strong>Make things more explicit</strong><br />I propose new names for these last two operations, in order to emphasize their destructive nature. Instead of Update, let's call it <strong>Alter</strong>. An update sounds like your adding fresh data. What you are really doing is altering what was there.</p>
<p>Instead of Delete, let's call it <strong>Purge</strong>. When you purge something, it no longer exists. It's as if it never was. While you might confuse Delete with a soft delete, you cannot mistake the meaning of Purge.</p>
<p><strong>Auditability</strong><br />Armed with our new language, let's think about how to audit our systems. Can explain to your legal department how you are Altering records? Can you convince your IT staff that it's OK to Purge data? Don't use terms that sugar-coat the facts. Tell it like it is.</p>
<p><strong>Synchronization</strong><br />Discrete machines in a distributed system need to exchange information in order to keep each other up to date. If they have each Altered the same data, how do they know which is the correct version? How do they even know that there has been a conflict. The prior version upon which they both agreed is lost.</p>
<p>If one Purges data, should the other Purge it as well? Or should the first Create it again? How can they tell the difference?</p>
<p>Post an article in an RSS feed, then change it. See what happens to the feed aggregators. Create a contact in Outlook and then delete it from your iPhone. See if it goes away.</p>
<p>The data destroyed by Altering and Purging records is precisely the data required to synchronize discrete systems. Retain it.</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Alter</li>
<li>Purge</li>
</ul>
<p>I think that's more explicit.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index4efb.html?p=405#comments" title="Comment on Alter and Purge">2 Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-401">
				<h2><a href="indexfef8.html?p=401" rel="bookmark" title="Permanent Link to Update Controls for Silverlight 3">Update Controls for Silverlight 3</a></h2>
				<small>July 26th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Now that Silverlight 3 has been released, I have taken the Beta designation off of <a href="http://updatecontrols.codeplex.com/">Update Controls Light</a>.</p>
<p>Update Controls is data binding without INotifyPropertyChanged. You never have to implement it. And you never have to consume it. And now it works with Silverlight 3.</p>
<p>Just like with the Winforms and WPF versions, Update Controls Light requires you to identify independent properties. An independent property is one that can be changed. It's value does not depend upon anything else. For example, a Customer's name is independent, as well as their list of invoices. You indicate that these properties are independent by creating an Independent sentry and calling OnGet() and OnSet() whenever they are accessed or changed.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Customer
{
    <span style="color: blue">private</span> <span style="color: blue">string</span> _name;
    <span style="color: blue">private</span> List&lt;Invoice&gt; _invoices = <span style="color: blue">new</span> List&lt;Invoice&gt;();

    <span style="color: blue">private</span> Independent _indName = <span style="color: blue">new</span> Independent();
    <span style="color: blue">private</span> Independent _indInvoices = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span> { _indName.OnGet(); <span style="color: blue">return</span> _name; }
        <span style="color: blue">set</span> { _indName.OnSet(); _name = value; }
    }

    <span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; Invoices
    {
        <span style="color: blue">get</span> { _indInvoices.OnGet(); <span style="color: blue">return</span> _invoices; }
    }

    <span style="color: blue">public</span> Invoice NewInvoice(<span style="color: blue">string</span> number)
    {
        _indInvoices.OnSet();
        Invoice invoice = <span style="color: blue">new</span> Invoice(number);
        _invoices.Add(invoice);
        <span style="color: blue">return</span> invoice;
    }
}</pre>
<p>Properties that use those independent properties are dependent upon them. Update Controls recognizes those dependencies and fires PropertyChanged events for you.</p>
<p>Think about that. It isn't just firing PropertyChanged for the properties that you indicate as Independent. It's firing PropertyChanged for all the properties that <em>use</em> those properties.</p>
<p><strong>Two lists</strong><br />
Here's an example. This control has two lists: paid invoices and unpaid invoices.</p>
<div id="silverlightControlHost" style="height: 120px"><object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="100%" height="100%"></p>
<param name="source" value="/bin/UpdateControls.Light.Demo.xap"></param>
<param name="onError" value="onSilverlightError"></param>
<param name="background" value="white"></param>
<param name="minRuntimeVersion" value="3.0.40624.0"></param>
<param name="autoUpgrade" value="true"></param><a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=3.0.40624.0" style="text-decoration: none"><img src="http://go.microsoft.com/fwlink/?LinkId=108181" alt="Get Microsoft Silverlight" style="border-style: none" /></a><a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=3.0.40624.0" style="text-decoration: none"></a><iframe id="_sl_historyFrame" style="border: 0px none ; visibility: hidden; height: 0px; width: 0px"></iframe></object></div>
<p>In a typical program, you would handle the "Paid" and "Unpaid" buttons by removing selected invoices from one list and adding them to the other. But with Update Controls Light, you just change the data model. The two lists are dependent.</p>
<pre><span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; PaidInvoices
{
    <span style="color: blue">get</span> { <span style="color: blue">return</span> _payment.PaidInvoices; }
}

<span style="color: blue">public</span> IEnumerable&lt;Invoice&gt; UnpaidInvoices
{
    <span style="color: blue">get</span> { <span style="color: blue">return</span> _payment.Customer.Invoices.Except(_payment.PaidInvoices); }
}</pre>
<p>The body of the UnpaidInvoices property tells the whole story. When you add an invoice to the payment, it no longer appears in UnpaidInvoices. Update Controls Light can see this and fire the right notification events.</p>
<p>Dependent properties never have backing storage. They just reference independent properties in their getters and -- if two-way binding is required -- setters.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="indexfef8.html?p=401#respond" title="Comment on Update Controls for Silverlight 3">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-400">
				<h2><a href="index2d8c.html?p=400" rel="bookmark" title="Permanent Link to Update Controls and INotifyPropertyChanged: never the two shall meet (but if they have to, here&#8217;s how)">Update Controls and INotifyPropertyChanged: never the two shall meet (but if they have to, here&#8217;s how)</a></h2>
				<small>July 9th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>I recently corresponded with a new Update Controls user. He brought up some excellent points about INotifyPropertyChanged and Update Controls. The short answer is: don't mix them. Unfortunately, reality is not so cut and dried.</p>
<p>We started with some easy questions:</p>
<blockquote><p>Should my view model implement INotifyPropertyChanged [when I'm using Update Controls]?</p>
</blockquote>
<p>No, your view model should not implement INotifyPropertyChanged. When you call ForView.Wrap(), Update Controls implements it for you.</p>
<blockquote><p>So ForView.Wrap() completely replaces the "{u:Update}" syntax?</p>
</blockquote>
<p>Absolutely, it does. It is more Blend friendly.</p>
<blockquote><p>But do I still need to define my Independent's using Ctrl+D, G?</p>
</blockquote>
<p>Yes, the underlying dependency tracking is still exactly the same. It still requires Independent sentries, which Ctrl+D, G generates for you.</p>
<p>And then the hard questions began:</p>
<blockquote><p>If I exposed properties of an object that implements INotifyPropertyChanged (for example, CslaDataProvider.IsBusy) via my ViewModel, do I need to do anything special? Or would it be so simple as:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">bool</span> IsBusy
{
    <span style="color: blue">get</span> { <span style="color: blue">return</span> _dp.IsBusy; }
}</pre>
</blockquote>
<p>Unfortunately, ForView.Wrap() hides the INotifyPropertyChanged implementation of the root object or any of its properties. So simply passing through the property access would not be sufficient. Neither does the dependency tracking mechanism recognize INotifyPropertyChanged. So when the event is fired, Update Controls does not know to forward that along to the view.</p>
<p>If your class already implements INotifyPropertyChanged and you want to add Independent sentries too, that's fine.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Customer : INotifyPropertyChanged
{
    <span style="color: blue">public</span> <span style="color: blue">event</span> PropertyChangedEventHandler PropertyChanged;

    <span style="color: blue">private</span> <span style="color: blue">string</span> _name;
    <span style="color: blue">private</span> Independent _indName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span> { _indName.OnGet(); <span style="color: blue">return</span> _name; }
        <span style="color: blue">set</span> { _indName.OnSet(); _name = value; FirePropertyChanged(<span style="color: maroon">"Name"</span>); }
    }

    <span style="color: blue">private</span> <span style="color: blue">void</span> FirePropertyChanged(<span style="color: blue">string</span> name)
    {
        <span style="color: blue">if</span> (PropertyChanged != <span style="color: blue">null</span>)
            PropertyChanged.Invoke(<span style="color: blue">this</span>, <span style="color: blue">new</span> PropertyChangedEventArgs(name));
    }
}</pre>
<p>The INotifyPropertyChanged implementation will be completely ignored by Update Controls, and the Independent will be completely ignored by legacy code.</p>
<p>Or, if you have a legacy object and you completely control the access to its properties, you can wrap it.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CustomerWrapper
{
    <span style="color: blue">private</span> Customer _customer;
    <span style="color: blue">private</span> Independent _indCustomerName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> CustomerWrapper(Customer customer)
    {
        _customer = customer;
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span> { _indCustomerName.OnGet(); <span style="color: blue">return</span> _customer.Name; }
        <span style="color: blue">set</span> { _indCustomerName.OnSet(); _customer.Name = value; }
    }
}</pre>
<p>But if someone else could change the controlled property without going through your code, you have to handle INotifyPropertyChanged yourself.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CustomerWrapper
{
    <span style="color: blue">private</span> Customer _customer;
    <span style="color: blue">private</span> Independent _indCustomerName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> CustomerWrapper(Customer customer)
    {
        _customer = customer;
<strong>        _customer.PropertyChanged += (sender, e) =&gt;
        {
            <span style="color: blue">if</span> (e.PropertyName == <span style="color: maroon">"Name"</span>)
                _indCustomerName.OnSet();
        };
</strong>    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> Name
    {
        <span style="color: blue">get</span> { _indCustomerName.OnGet(); <span style="color: blue">return</span> _customer.Name; }
        <span style="color: blue">set</span> { <span style="color: green"><strong>/*_indCustomerName.OnSet(); Not needed anymore. */</strong></span> _customer.Name = value; }
    }
}</pre>
<p>When the event fires, you record that the property has been set. I'd love to generate a wrapper for you (something like ForViewModel.Wrap()), but I can't think of a way of doing that without hiding the underlying object properties. Maybe with some <a href="http://ayende.com/">Ayende</a> mojo I could pull it off, but I'm hoping that I never have to.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="index2d8c.html?p=400#respond" title="Comment on Update Controls and INotifyPropertyChanged: never the two shall meet (but if they have to, here&#8217;s how)">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-398">
				<h2><a href="index9d24.html?p=398" rel="bookmark" title="Permanent Link to Data bound menus">Data bound menus</a></h2>
				<small>July 3rd, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>I had a twitter conversation recently with <a href="http://twitter.com/edward_tanguay">Edward Tanguay</a> about his StackOverflow question on <a href="http://stackoverflow.com/questions/1067903/how-can-i-bind-an-observablecollection-of-viewmodels-to-a-menuitem">binding menus to an Observable Collection</a>. Naturally, I locked on to the ObservableCollection part and didn't get the true gist of his question. I took a step back, reread his question and the provided answers, and finally caught on to the problem. I wish I could upvote Kent Boogaart's answer more than once, because it set me on a trail of discovery.</p>
<p>This example uses <a href="http://updatecontrols.net/">Update Controls</a>. Download the example source code: <a href="wp-content/uploads/2009/07/databoundmenus.zip" title="databoundmenus.zip">databoundmenus.zip</a>.</p>
<p>There is not just one way to make a WPF menu work. There are several techniques that you have to combine. Much of an application's menu is static. Some of it is context sensitive, and only appears in certain conditions. And in a few places, the menu items are dynamic, like recently opened files or currently open windows. Update Controls can help with all of these things.</p>
<p><strong>Declarative menu structure</strong><br />
For the static menus, you want to declare the structure entirely in XAML. This gives you the greatest design/code separation, and the best tool support. Use <a href="index07ee.html?p=297">Command Binding</a> for all menu items.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">Menu</span> <span style="color: red">DockPanel.Dock</span>="<span style="color: blue">Top</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_File</span>"<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_New</span>" <span style="color: red">Command</span>="<span style="color: blue">{Binding FileNewCommand}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Open</span>" <span style="color: red">Command</span>="<span style="color: blue">{Binding FileOpenCommand}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Save</span>" <span style="color: red">Command</span>="<span style="color: blue">{Binding FileSaveCommand}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Close</span>" <span style="color: red">Command</span>="<span style="color: blue">{Binding FileCloseCommand}</span>"/<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">MenuItem</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">Menu</span><span style="color: blue">&gt;</span></pre>
<p>Use Update Controls MakeCommand to create all of the bindable ICommand properties. The When clause will enable and disable the menu item.</p>
<pre><span style="color: blue">public</span> ICommand FileSaveCommand
{
    <span style="color: blue">get</span>
    {
        <span style="color: green">// We can only save a file when one is open.</span>
        <span style="color: blue">return</span> MakeCommand
            .<strong>When</strong>(() =&gt; _dataModel.OpenFileName != <span style="color: blue">null</span>)
            .Do(() =&gt; _dataModel.LastAction = <span style="color: maroon">"Save"</span>);
    }
}</pre>
<p>Some of the menu items are not application actions, but window actions. These can be handled in code-behind.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">Separator/</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">E_xit</span>" <span style="color: red">Click</span>="<span style="color: blue">Exit_Click</span>"/<span style="color: blue">&gt;</span></pre>
<pre><span style="color: blue">private</span> <span style="color: blue">void</span> Exit_Click(<span style="color: blue">object</span> sender, RoutedEventArgs e)
{
    Close();
}</pre>
<p><strong>Context sensitive menus</strong><br />
You want context sensitive menus to appear under certain conditions. WPF has a mechanism for that: the <a href="http://msdn.microsoft.com/en-us/library/system.windows.datatrigger.aspx">DataTrigger</a>. A DataTrigger sets a control property when a data property is equal to a specific value. In this case, we want to set a MenuItem's Visibility property to Hidden when the data property IsFileOpen is False.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">Window.Resources</span><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">Style</span> <span style="color: red">x:Key</span>="<span style="color: blue">VisibleWhenFileIsOpen</span>" <span style="color: red">TargetType</span>="<span style="color: blue">MenuItem</span>"<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">Style.Triggers</span><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">DataTrigger</span> <span style="color: red">Binding</span>="<span style="color: blue">{Binding IsFileOpen}</span>" <span style="color: red">Value</span>="<span style="color: blue">False</span>"<span style="color: blue">&gt;</span>
                <span style="color: blue">&lt;</span><span style="color: maroon">Setter</span> <span style="color: red">Property</span>="<span style="color: blue">Visibility</span>" <span style="color: red">Value</span>="<span style="color: blue">Hidden</span>"/<span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span>/<span style="color: maroon">DataTrigger</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">Style.Triggers</span><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">Style</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">Window.Resources</span><span style="color: blue">&gt;</span></pre>
<p>We apply this style to any menu that is sensitive to this context.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Edit</span>" <span style="color: red">Style</span>="<span style="color: blue">{StaticResource VisibleWhenFileIsOpen}</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">Cu_t</span>"/<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Copy</span>"/<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Paste</span>"/<span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">MenuItem</span><span style="color: blue">&gt;</span></pre>
<p>DataTriggers automatically reset. When the IsFileOpen data property is no longer False, the Visibility control property will go back to the default Visible. There is no need to create another trigger for that rule.</p>
<p><strong>Dynamic menus</strong><br />
For recently opened files or currently open windows, you want each menu item to represent a data object. You want to bind the menu to a list.</p>
<p>If you bind to the raw data objects, you will have a hard time getting exactly the behavior that you want in the view. XAML is declarative, and is easiest to use when the data is already in the right format. That's where the View Model comes in.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> RecentFileViewModel
{
    <span style="color: blue">private</span> <span style="color: blue">int</span> _index;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _fileName;
    <span style="color: blue">private</span> IFileHandler _fileHandler;

    <span style="color: blue">public</span> RecentFileViewModel(<span style="color: blue">int</span> index, <span style="color: blue">string</span> fileName, IFileHandler fileHandler)
    {
        _index = index;
        _fileName = fileName;
        _fileHandler = fileHandler;
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> FileName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> <span style="color: blue">string</span>.Format(<span style="color: maroon">"_{0} - {1}"</span>, _index + <span style="color: maroon">1</span>, _fileName); }
    }

    <span style="color: blue">public</span> ICommand Open
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">return</span> MakeCommand
                .Do(() =&gt; _fileHandler.Open(_fileName));
        }
    }
}</pre>
<p>The recent file view model presents the file name in a format suitable for the menu item. It even adds the underscore to turn the 1-based index into a hot key.</p>
<p>The view model also provides the command to open the file. It doesn't actually perform the operation; it delegates to a file handler and provides the context.</p>
<p>We provide a list of these view models based on the list of recently opened files.</p>
<pre><span style="color: blue">public</span> IEnumerable&lt;RecentFileViewModel&gt; RecentFiles
{
    <span style="color: blue">get</span>
    {
        <span style="color: green">// Create a RecentFileViewModel for each recent file.</span>
        <span style="color: green">// The view model serves the menu item.</span>
        <span style="color: blue">return</span> _dataModel.RecentFiles
            .Select((fileName, index) =&gt;
                <span style="color: blue">new</span> RecentFileViewModel(index, fileName, <span style="color: blue">this</span>));
    }
}</pre>
<p>Please note that this pattern does not work with ObservableCollection. Once you call .Select() on an ObservableCollection, it is no longer observable. This pattern only works with Update Controls.</p>
<p>Now we need to bind MenuItems to this collection. My first instinct was to set the ItemTemplate of the parent MenuItem to a DataTemplate containing a child MenuItem. The problem with that is that a DataTemplate controls the <em>content</em> of the child item, not the child item itself. So instead of setting ItemTemplate, you need to set the ItemContainerStyle.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">MenuItem</span> <span style="color: red">Header</span>="<span style="color: blue">_Recent Files</span>" <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding RecentFiles}</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">MenuItem.ItemContainerStyle</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">Style</span><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">Setter</span> <span style="color: red">Property</span>="<span style="color: blue">MenuItem.Header</span>" <span style="color: red">Value</span>="<span style="color: blue">{Binding FileName}</span>"/<span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">Setter</span> <span style="color: red">Property</span>="<span style="color: blue">MenuItem.Command</span>" <span style="color: red">Value</span>="<span style="color: blue">{Binding Open}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">Style</span><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">MenuItem.ItemContainerStyle</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">MenuItem</span><span style="color: blue">&gt;</span></pre>
<p>A WPF menu should not be defined using just one technique. If you choose something to simple, you won't be able to handle the more interactive requirements. If you choose something too complex, you loose tool support and put too much of your design in code. With this combination of techniques, you can create interactive menus with ease.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a>,  <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="index9d24.html?p=398#comments" title="Comment on Data bound menus">1 Comment &#187;</a></p>
			</div>

		
			<div class="post" id="post-396">
				<h2><a href="index2e25.html?p=396" rel="bookmark" title="Permanent Link to INotifyPropertyChanged is Obsolete addendum">INotifyPropertyChanged is Obsolete addendum</a></h2>
				<small>June 24th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Please check you mailbox for the latest issue of <a href="http://code-magazine.com/">CoDe Magazine</a>. In it, you will find my article "<a href="http://www.code-magazine.com/Article.aspx?quickid=0907101">INotifyPropertyChanged is Obsolete</a>." A few things have changed since I penned those words, and now INotifyPropertyChanged is more obsolete than ever.</p>
<p>The article describes how to use <a href="http://updatecontrols.net/">Update Controls</a> to replace WPF data binding. Rather than using the built-in "{Binding}" XAML extension, it tells you to use my "{u:Update}" custom extension. While this custom markup extension is still supported, it is no longer the preferred way to use Update Controls.</p>
<p><strong>Blend-friendly updating</strong><br />
Thanks to some feedback from <a href="http://www.paulstovell.com/">Paul Stovell</a>, Microsoft MVP for Client Application Development, Update Controls now works <em>with</em> the "{Binding}" XAML extension. This makes it more Blend friendly. But before you give your object to the DataContext, you need to wrap it:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">partial</span> <span style="color: blue">class</span> Window1 : Window
{
    <span style="color: blue">public</span> Window1()
    {
        InitializeComponent();
        DataContext = <strong>ForView.Wrap</strong>(<span style="color: blue">new</span> PersonViewModel(<span style="color: blue">new</span> Person()));
    }
}</pre>
<p>The wrapper implements INotifyPropertyChanged for you. It infers dependencies from your code and figures out when to fire PropertyChanged events. To help it with that inference, you need to mark your independent properties.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Person
{
    <span style="color: blue">private</span> <span style="color: blue">string</span> _firstName;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _lastName;

    <span style="color: blue">#region</span> Independent properties
    <span style="color: green">// Generated by Update Controls --------------------------------</span>
    <span style="color: blue">private</span> Independent _indFirstName = <span style="color: blue">new</span> Independent();
    <span style="color: blue">private</span> Independent _indLastName = <span style="color: blue">new</span> Independent();

    <span style="color: blue">public</span> <span style="color: blue">string</span> FirstName
    {
        <span style="color: blue">get</span> { _<strong>indFirstName.OnGet();</strong> <span style="color: blue">return</span> _firstName; }
        <span style="color: blue">set</span> { <strong>_indFirstName.OnSet();</strong> _firstName = value; }
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> LastName
    {
        <span style="color: blue">get</span> { <strong>_indLastName.OnGet();</strong> <span style="color: blue">return</span> _lastName; }
        <span style="color: blue">set</span> { <strong>_indLastName.OnSet();</strong> _lastName = value; }
    }
    <span style="color: green">// End generated code --------------------------------</span>
    <span style="color: blue">#endregion</span>

    <span style="color: blue">public</span> <span style="color: blue">string</span> FullName
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">return</span> FirstName + <span style="color: maroon">" "</span> + LastName;
        }
    }
}</pre>
<p>The Ctrl+D, G shortcut still works. Select the fields and hit the shortcut to generate the independent properties.</p>
<p>Update Controls can see right through the intermediate view model. There is no bookkeeping code required. Even the dependency of Title upon FirstName and LastName is inferred.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> PersonViewModel
{
    <span style="color: blue">private</span> Person _person;

    <span style="color: blue">public</span> PersonViewModel(Person person)
    {
        _person = person;
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> FirstName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _person.FirstName; }
        <span style="color: blue">set</span> { _person.FirstName = value; }
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> LastName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _person.LastName; }
        <span style="color: blue">set</span> { _person.LastName = value; }
    }

    <span style="color: blue">public</span> <span style="color: blue">string</span> FullName
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _person.FullName; }
    }

<strong>    <span style="color: blue">public</span> <span style="color: blue">string</span> Title
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> <span style="color: maroon">"Person - "</span> + FullName; }
    }
</strong>}</pre>
<p><strong>Silverlight 3</strong><br />
I have also ported <a href="http://updatecontrolslight.codeplex.com/">Update Controls to Silverlight</a>. It only works with Silverlight 3, so it is in Beta until the official release. However, it is fully operational and works just as well as the WPF version. The "{u:Update}" custom extension is not supported in Silverlight, however. You have to use the new ForView.Wrap() mechanism.</p>
<p>I hope you find Update Controls to be as useful as I have. You can <a href="http://www.code-magazine.com/Article.aspx?quickid=0907101">download the source code</a> provided in the article from CoDe Magazine, or try some demos that I've created since then:</p>
<ul>
<li><a href="wp-content/uploads/2009/06/commuter.zip">Commuter</a> - Multi-threaded iTunes synchronization sample.</li>
<li><a href="wp-content/uploads/2009/03/quickwriter.zip">QuickWriter</a> - Data binding through linq queries. Uses the {u:Update} extension rather than the new ForView.Wrap().</li>
<li><a href="http://updatecontrols.codeplex.com/SourceControl/ListDownloadableCommits.aspx">UpdateControls.XAML.Test</a> - The test app bundled with the source code.</li>
<li><a href="wp-content/uploads/2009/06/addendumdemo.zip">Addendum Demo</a> - The code included above.</li>
</ul>
<p>Also be sure to watch the <a href="http://updatecontrols.net/vb/videos.shtml">videos</a> to see it in action.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="index2e25.html?p=396#respond" title="Comment on INotifyPropertyChanged is Obsolete addendum">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-395">
				<h2><a href="index0449.html?p=395" rel="bookmark" title="Permanent Link to Wet floor effect batch transform using WPF">Wet floor effect batch transform using WPF</a></h2>
				<small>June 13th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>My wife just took some new photos for <a href="http://myscraproom.net/">her scrapbooking website</a>. I have a coverflow effect on that page, so I needed to apply the wet floor transform to 64 images. Rather than do it all by hand, I wrote some WPF code to do it for me:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> WetFloor
{
    <span style="color: blue">public</span> <span style="color: blue">static</span> <span style="color: blue">void</span> Render(<span style="color: blue">string</span> source, <span style="color: blue">string</span> target, <span style="color: blue">int</span> targetWidth)
    {
        <span style="color: blue">using</span> (Stream input = File.OpenRead(source))
        {
            <span style="color: green">// Load the source jpg.</span>
            JpegBitmapDecoder sourceJpg = <span style="color: blue">new</span> JpegBitmapDecoder(input, BitmapCreateOptions.None, BitmapCacheOption.Default);
            <span style="color: blue">if</span> (sourceJpg.Frames.Count != <span style="color: maroon">1</span>)
                <span style="color: blue">throw</span> <span style="color: blue">new</span> Exception(String.Format(<span style="color: maroon">"I don't know how to handle {0} frames."</span>, sourceJpg.Frames.Count));
            BitmapFrame sourceBitmap = sourceJpg.Frames[<span style="color: maroon">0</span>];

            <span style="color: green">// Create a render target scaled to 400 pixels at 150% the aspect ratio.</span>
            <span style="color: blue">double</span> scale = (<span style="color: blue">double</span>)targetWidth / sourceBitmap.PixelWidth;
            RenderTargetBitmap renderTarget = <span style="color: blue">new</span> RenderTargetBitmap(
                targetWidth, (<span style="color: blue">int</span>)Math.Round(scale * (<span style="color: blue">float</span>)sourceBitmap.PixelHeight * <span style="color: maroon">1</span><span style="color: maroon">.5</span>),
                sourceBitmap.DpiX, sourceBitmap.DpiY,
                PixelFormats.Pbgra32);

            <span style="color: green">// Paint a rectangle with the source bitmap.</span>
            Rectangle original = <span style="color: blue">new</span> Rectangle()
            {
                Fill = <span style="color: blue">new</span> ImageBrush(sourceBitmap),
                Width = scale * sourceBitmap.Width,
                Height = scale * sourceBitmap.Height
            };

            original.Arrange(<span style="color: blue">new</span> Rect(<span style="color: blue">new</span> Size(scale * sourceBitmap.Width, scale * sourceBitmap.Height)));
            renderTarget.Render(original);

            <span style="color: green">// Paint a black rectangle.</span>
            Rectangle shade = <span style="color: blue">new</span> Rectangle()
            {
                Fill = <span style="color: blue">new</span> SolidColorBrush(Colors.Black),
                Width = scale * sourceBitmap.Width,
                Height = scale * sourceBitmap.Height
            };

            shade.Arrange(<span style="color: blue">new</span> Rect(<span style="color: blue">new</span> Point(<span style="color: maroon">0</span>, scale * sourceBitmap.Height), <span style="color: blue">new</span> Size(scale * sourceBitmap.Width, scale * sourceBitmap.Height)));
            renderTarget.Render(shade);

            <span style="color: green">// Paint an inverted rectangle with the source bitmap.</span>
            Border reflection = <span style="color: blue">new</span> Border()
            {
                Background = <span style="color: blue">new</span> ImageBrush(sourceBitmap),
                Width = scale * sourceBitmap.Width,
                Height = scale * sourceBitmap.Height,
                RenderTransform = <span style="color: blue">new</span> ScaleTransform(<span style="color: maroon">1</span><span style="color: maroon">.0f</span>, -<span style="color: maroon">1</span><span style="color: maroon">.0f</span>, scale * sourceBitmap.Width / <span style="color: maroon">2</span>, scale * sourceBitmap.Height / <span style="color: maroon">2</span>),
                OpacityMask = <span style="color: blue">new</span> LinearGradientBrush()
                {
                    StartPoint = <span style="color: blue">new</span> Point(<span style="color: maroon">0</span>, <span style="color: maroon">1</span>),
                    EndPoint = <span style="color: blue">new</span> Point(<span style="color: maroon">0</span>, <span style="color: maroon">0</span>),
                    GradientStops = <span style="color: blue">new</span> GradientStopCollection(<span style="color: blue">new</span> GradientStop[]
                    {
                        <span style="color: blue">new</span> GradientStop()
                        {
                            Offset = -<span style="color: maroon">0</span><span style="color: maroon">.3f</span>,
                            Color = Colors.Black
                        },
                        <span style="color: blue">new</span> GradientStop()
                        {
                            Offset = <span style="color: maroon">0</span><span style="color: maroon">.5f</span>,
                            Color = Colors.Transparent
                        }
                    })
                }
            };

            reflection.Arrange(<span style="color: blue">new</span> Rect(<span style="color: blue">new</span> Point(<span style="color: maroon">0</span>, scale * sourceBitmap.Height), <span style="color: blue">new</span> Size(scale * sourceBitmap.Width, scale * sourceBitmap.Height)));
            renderTarget.Render(reflection);

            <span style="color: green">// Render the final product.</span>
            JpegBitmapEncoder png = <span style="color: blue">new</span> JpegBitmapEncoder();
            png.Frames.Add(BitmapFrame.Create(renderTarget));
            <span style="color: blue">using</span> (Stream fs = File.Create(target))
            {
                png.Save(fs);
            }
        }
    }
}
</pre>
<p>Enjoy.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb31a.html?cat=1" title="View all posts in Uncategorized" rel="category">Uncategorized</a> |   <a href="index0449.html?p=395#respond" title="Comment on Wet floor effect batch transform using WPF">No Comments &#187;</a></p>
			</div>

		
		<div class="navigation">
			<div class="alignleft"><a href="index0cc2.html?paged=15">&laquo; Previous Entries</a></div>
			<div class="alignright"><a href="index7838.html?paged=13">Next Entries &raquo;</a></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 21 queries. 0.467 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?paged=14 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:10:30 GMT -->
</html>
