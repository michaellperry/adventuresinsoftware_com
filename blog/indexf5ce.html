<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?paged=11 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:10:21 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software  </title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
			<li id="linkcat-16" class="linkcat"><h2>Blogroll</h2>
	<ul>
<li><a href="http://ayende.com/Blog">Ayende Rahien</a></li>
<li><a href="http://www.softinsight.com/bnoyes/default.aspx">Brian Noyes</a></li>
<li><a href="http://chriskoenig.net/">Chris Koenig</a></li>
<li><a href="http://scienceblogs.com/goodmath/" title="MarkCC reveals the beauty in mathematics and exposes its misuse.">Good Math, Bad Math</a></li>
<li><a href="http://joshsmithonwpf.wordpress.com/">Josh Smith on WPF</a></li>
<li><a href="http://west-wind.com/Weblog/default.aspx">Rick Strahl</a></li>
<li><a href="http://www.udidahan.com/?blog=true">Udi Dahan</a></li>

	</ul>
</li>
<li id="linkcat-17" class="linkcat"><h2>Links</h2>
	<ul>
<li><a href="http://www.absg.com/" title="my day job">ABSG</a></li>
<li><a href="http://www.d20universe.com/" title="my friends boostrap">d20 Universe</a></li>
<li><a href="http://updatecontrols.net/" title="my open source project">Update Controls .NET</a></li>

	</ul>
</li>
<li id="linkcat-32" class="linkcat"><h2>Podroll</h2>
	<ul>
<li><a href="http://dotnetrocks.com/" title="Interviews with leaders in the .NET community.">.NET Rocks!</a></li>
<li><a href="http://hanselminutes.com/" title="News and interviews from all aspects of software, with an insider&#039;s view of Microsoft.">Hanselminutes</a></li>

	</ul>
</li>
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

	
		
			<div class="post" id="post-454">
				<h2><a href="index6353.html?p=454" rel="bookmark" title="Permanent Link to Don&#8217;t abdicate the ubiquitous language">Don&#8217;t abdicate the ubiquitous language</a></h2>
				<small>October 16th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>The Ubiquitous Language of Domain Driven Design is a call for developers and domain experts to communicate openly, instead of erecting false barriers of obfuscation. It admonishes developers not to put pattern names or technical terms into the domain model.</p>
<p>Yet it also does not suggest that developers should abdicate the language to the domain experts. Imprecise language cannot be tolerated. When a domain expert uses it, it is the developers' duty to correct it.</p>
<p>The following four-letter words are indicators of imprecise language:</p>
<ul>
<li>Type</li>
<li>State/Status</li>
<li>Code</li>
<li>Text</li>
</ul>
<p><strong>Type</strong><br />When a domain expert uses the term "type", they are trying to classify objects in a meaningful way. Work items, for example, can either be bugs or enhancements. Orders can be purchase orders, quotes, or returns.</p>
<p>Domain experts will often model type as an attribute of a single entity. The behavior of that entity is sometimes dependent upon this "type" attribute. Entities of one type are treated differently than entities of another type, but only in certain situations. Pricing is run on purchase orders and quotes, for example, but not on returns.</p>
<p>When a developer sees the word "type", they immediately attach some assumptions to it. An entity can only be an instance of one concrete type. Its type is determined at the time of creation and cannot change during its lifetime. Type determines the attributes and behaviors of the object. These are not the assumptions that the domain expert means to imply. A work item may be entered as a bug, but later determined to be an enhancement. The work item type can change. If we modeled this domain using a static type system, such a change would be impossible.</p>
<p>It would be more useful to identify the reason that objects have different "types". A work item is either a bug or an enhancement because of the feature set it affects: existing features or new features. Orders are purchase orders, quotes, or returns because of their intent. Let's use the more precise terms "feature set" and "intent", and not the overloaded term "type" to represent these attributes of an entity.</p>
<p><strong>State and Status</strong><br />When a domain expert uses the term "state" or "status", they are trying to express a workflow. A work item is in the "new", "fixed", or "closed" state. An order status can be "received", "processed", or "shipped".</p>
<p>State and status are modeled as attributes of an entity. But they are in truth events in the workflow. As an entity moves through a workflow, the intent is not so much to modify that entity. Rather, it is to gather information <em>about</em> the entity. This is a concept discussed by Greg Young in <a href="http://www.infoq.com/presentations/greg-young-unshackle-qcon08">Unshackle Your Domain</a>. The events should themselves be part of the domain model.</p>
<p>States are only meaningful within a context. But entities are often found at the intersection of several contexts. An entity can be in several states simultaneously, depending upon what question is being asked. But if "state" is an attribute of an entity, it can have only one value. This can lead to a combinatorial explosion of states that attempt to simultaneously represent two or more contexts.</p>
<p>It would be more useful to identify the events that can occur within a workflow, and ask questions in terms of that history.</p>
<p><strong>Code</strong><br />When a domain expert uses the term "code", they are usually calling out an implementation detail about how a problem is currently solved. Our ordering system currently has a "signal code" attached to a product. This three-letter code is used to signal the system that special processing needs to take place.</p>
<p>For example, one signal code indicates that the product is a controlled substance, and therefore requires DEA license validation. Another signal code indicates that the product is drop shipped, so different inventory behavior is applied.</p>
<p>The problem with codes is that they are already entrenched. It is hard to convince a domain expert that there is a problem. Telling them that codes represent different dimensions is too abstract. But if you give them a concrete example, they already have an answer for it.</p>
<p>"What if a product is both a controlled substance and drop shipped?"</p>
<p>"Are you crazy! We don't drop ship controlled substances!"</p>
<p>It would be more useful to identify the dimensions along which entities vary and make those independent attributes. A product has licensing requirements, and also has an inventory strategy. Interactions among those various dimensions can be captured as business rules.</p>
<p><strong>Text</strong><br />Unless the domain is specifically about books, the term "text" is often used to represent a note to be displayed in a specific place. A customer service representative can enter "footer text" when placing an order, which appears on the footer of the invoice.</p>
<p>These notes are important to capture, as the primary purpose of any system is to facilitate communication among its users. But the notes should be named according to their purpose, not according to where they appear. Formats change over time, and are not an appropriate concept for the domain model. Our "footer text" for example no longer appears on the footer of the invoice. It would be more useful to call it "invoice instructions".</p>
<p>The four-letter words listed here are just the most egregious examples of imprecise language. There are many other examples that could be cited. As a developer, it is your job to ask questions when you see them. You need more information about what these terms mean in context. If you have to ask a domain expert to elaborate, then they have not chosen a precise term. Once they do elaborate, suggest that they use that term instead.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index9591.html?cat=37" title="View all posts in DDD" rel="category">DDD</a> |   <a href="index6353.html?p=454#respond" title="Comment on Don&#8217;t abdicate the ubiquitous language">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-453">
				<h2><a href="index06d3.html?p=453" rel="bookmark" title="Permanent Link to Merit vs. Credit">Merit vs. Credit</a></h2>
				<small>October 15th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Domain Driven Design (DDD) advocates for a ubiquitous language. This is more than just a fancy way of saying that developers and domain experts should use the same words. It's more than a glossary or a dictionary.</p>
<p>I've fallen victim to the hubris of making up my own language that is "better" than the business'. It's a personality flaw that I fight constantly. The worst example occurred when I designed a frequent diner program for a prior employer. The business called points earned "credit". I insisted that the correct term was "merit". "Credit" is for accounting systems (like our gift card program). "Merit" is something you accrue for which you are eventually rewarded.</p>
<p>I debated the issue at length with the business analyst. She understood my position, but informed me that our users use the term "credit". She performed an experiment in which some potential customers were shown specs with "credit" and others with "merit". The "credit" group had fewer misunderstandings than the "merit" group. Even in the face of scientific evidence, I stood my ground. "Merit" was right, and they just needed to be educated.</p>
<p>The debate continued. People lined up behind The Architect claiming that "merit" was technically correct and semantically concise. Other people lined up behind The Business Analyst claiming that "credit" made more sense and did not conflict with other definitions in other contexts.</p>
<p>In the end, we resolved that all of the functional specifications and end user documentation would use the term "credit", while all of the technical documentation and code would use "merit". The user interface code was a mess, since it had to display "credit" but read the value from the "merit" property. For years afterward, I received questions from new developers about what was "merit" and what was "credit" and what they had to do with each other.</p>
<p>In this, I was wrong. My continued insistence on imposing my own language added no value. I created a situation which only bred confusion. I was correct only in proposing a new term and in soliciting additional feedback. But once the term "credit" was corroborated by our customers, I should have ended my crusade for the sake of ubiquitous language.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index9591.html?cat=37" title="View all posts in DDD" rel="category">DDD</a> |   <a href="index06d3.html?p=453#respond" title="Comment on Merit vs. Credit">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-452">
				<h2><a href="index20a4.html?p=452" rel="bookmark" title="Permanent Link to Topic specific sites">Topic specific sites</a></h2>
				<small>October 10th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>I now have three sites for topic-specific content.</p>
<ul>
<li><a href="http://historicmodeling.com/">Historic Modeling</a>
<li><a href="http://updatecontrols.net/doc">Update Controls</a>
<li><a href="http://qedcode.com/">Q.E.D. Code</a></li>
</ul>
<p>I have seeded these sites with articles from Adventures in Software. But from now on, articles specific to those topics will go on those sites. Please subscribe to those RSS feeds as well as this one.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a>,  <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a>,  <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="index20a4.html?p=452#respond" title="Comment on Topic specific sites">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-451">
				<h2><a href="indexc31c.html?p=451" rel="bookmark" title="Permanent Link to A provable Socket API">A provable Socket API</a></h2>
				<small>October 8th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Two weeks ago, I assigned <a href="indexe982.html?p=440">homework</a>. Rewrite the .NET Socket API so that you can prove the following assertions:</p>
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue.
<li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed.
<li>You must call Bind before you can call the Listen method.
<li>You must call Listen before calling Accept.
<li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6.
<li>Connect cannot be called if Listen has been called.
<li>You have to either call Connect or Accept before Sending and Receiving data.
<li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection.</li>
</ul>
<p>These assertions are prominently listed in the MSDN documentation. Why not roll them into the API itself? Let the compiler prove that we are using sockets correctly.</p>
<p>Last week, I gave you a <a href="index0ecd.html?p=445">hint</a>. I moved the Send and Receive methods out to a different class so that we can prove that you've called Accept or Connect prior to Send or Receive. Both Accept and Connect became factory methods. You must call the factory before you get the object, and you must get the object before you call its methods. Q.E.D.</p>
<p>Let's start from there and prove the rest of the assertions.</p>
<p><strong>Starting point</strong></p>
<ul>
<li>You have to either call Connect or Accept before Sending and Receiving data.</li>
</ul>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ConnectedSocket
{
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Socket : IDisposable
{
    <span style="color: blue">public</span> Socket(SocketInformation socketInformation);
    <span style="color: blue">public</span> Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> ConnectedSocket Accept();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Bind(EndPoint localEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Listen(<span style="color: blue">int</span> backlog);
}</pre>
<p>Looking through the list of assertions, we find that this one is already taken care of by the first change:</p>
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue.</li>
</ul>
<p>The ConnectedSocket class doesn't have an Accept method, so you can't call it. Q.E.D.</p>
<p><strong>Other prerequisites</strong><br />There are three other prerequisite assertions that we can prove in exactly the same way:</p>
<ul>
<li>You must call Bind before you can call the Listen method.
<li>You must call Listen before calling Accept.
<li>Connect cannot be called if Listen has been called.</li>
</ul>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Socket : IDisposable
{
    <span style="color: blue">public</span> Socket(SocketInformation socketInformation);
    <span style="color: blue">public</span> Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> <strong>BoundSocket</strong> Bind(EndPoint localEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
}

<span style="color: blue">public</span> <span style="color: blue">class</span> BoundSocket
{
    <span style="color: blue">public</span> ListeningSocket Listen(<span style="color: blue">int</span> backlog);
<span style="color: blue"><font color="#000000">    </font>public</span> ConnectedSocket Connect(EndPoint remoteEP);
<span style="color: blue"><font color="#000000">    </font>public</span> ConnectedSocket Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
}

<span style="color: blue">public</span> <span style="color: blue">class</span> ListeningSocket
{
    <span style="color: blue">public</span> ConnectedSocket Accept();
}</pre>
<p>Bind becomes a factory for the class that gives you Listen. Bind does not take away your ability to call Connect. Listen does.</p>
<p><strong>Factory and product</strong><br />Factories are great prerequisites. Now that it is becoming more obvious that we are using that pattern, let's rename Socket and move IDisposable to the product.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> <strong>SocketFactory</strong>
{
    <span style="color: blue">public</span> SocketFactory(SocketInformation socketInformation);
    <span style="color: blue">public</span> SocketFactory(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> BoundSocket Bind(EndPoint localEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> ConnectedSocket Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
}

<span style="color: blue">public</span> <span style="color: blue">class</span> ConnectedSocket : <strong>IDisposable</strong>
{
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
}</pre>
<p>The ConnectedSocket is the ultimate product. That's the socket that needs to be closed. And what do you know, this change proves another of our assertions:</p>
<ul>
<li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection.</li>
</ul>
<p>It is impossible to call Connect on a socket that has been disposed, since they aren't the same object anymore.</p>
<p><strong>Dispose once</strong><br />Now that the Dispose method is where it belongs, let's focus on the assertion most concerned with its use:</p>
<ul>
<li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed.</li>
</ul>
<p>Accept, Bind, Connect, and Listen have already been taken care of, since they have become factory methods. To handle Send and Receive, we turn every ConnectedSocket factory into a callback:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ConnectedSocket
{
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
}

<span style="color: blue">public</span> <span style="color: blue"><strong>void</strong></span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port, <strong>Action&lt;ConnectedSocket&gt;</strong> action);</pre>
<p>We have taken away the capability of disposing a socket. The factory does it on the consumer's behalf. Since there is no way for the consumer to call Dispose, and since the callback returns before Dispose is called, there is no way to call Send or Receive after Dispose. Q.E.D.</p>
<p><strong>Specialized factory</strong><br />Which leaves us with one final assertion:</p>
<ul>
<li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6.</li>
</ul>
<p>Again, we want to move the restricted method into its own special class. But now, we want to enforce that certain values are provided, not that certain methods are called. We'll limit this by creating our own smaller enumeration.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> IPSocketFactory : SocketFactory
{
    <span style="color: blue">public</span> <span style="color: blue">enum</span> Version { V4, V6 }
    <span style="color: blue">public</span> IPSocketFactory(<strong>Version version</strong>, SocketType socketType, ProtocolType protocolType)
        : <span style="color: blue">base</span>(
            version == Version.V4 ? AddressFamily.InterNetwork : AddressFamily.InterNetworkV6,
            socketType,
            protocolType) { }

    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port, Action&lt;ConnectedSocket&gt; action);
}</pre>
<p>If you want to call the Connect overload with two parameters, you have to use the limited enumeration to get the right factory. I didn't mess with the overloaded constructor, because it complicates things.</p>
<p>One slight wrinkle. In a previous change we created a copy of the Connect method, since it can be called after Bind(). So we make the same change there:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> IPBoundSocket : BoundSocket
{
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port, Action&lt;ConnectedSocket&gt; action);
}

<span style="color: blue">public</span> <span style="color: blue">class</span> IPSocketFactory : SocketFactory
{
    <span style="color: blue">public</span> <span style="color: blue">enum</span> Version { V4, V6 }
    <span style="color: blue">public</span> IPSocketFactory(Version version, SocketType socketType, ProtocolType protocolType)
        : <span style="color: blue">base</span>(
            version == Version.V4 ? AddressFamily.InterNetwork : AddressFamily.InterNetworkV6,
            socketType,
            protocolType) { }

    <span style="color: blue">public</span> <strong>IPBoundSocket</strong> Bind(EndPoint localEP);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port, Action&lt;ConnectedSocket&gt; action);
}</pre>
<p>The only way to get an IPBoundSocket is to use the IPSocketFactory. Therefore, you must have selected one of the Internet protocols. By the way, this is taking advantage of a little-used feature of C# called covarience. This is the one part of the proof that might not work in other languages.</p>
<p>So there you have it. A provably correct Socket API. There is no way to use it incorrectly. The compiler enforces all of the assertions that we would otherwise have to read the documentation to discover.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="indexc31c.html?p=451#respond" title="Comment on A provable Socket API">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-450">
				<h2><a href="index9e0f.html?p=450" rel="bookmark" title="Permanent Link to A new example of historic modeling">A new example of historic modeling</a></h2>
				<small>October 7th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>I wrote up an example historic model that illustrates very succinctly some of the major points of the theory. It is a simple <a href="http://historicmodeling.com/book/examples/workitemtracker">work item tracker</a>.</p>
<p>So far, the example model can assign developers to projects. The next step is to allow developers to move work items between folders to track progress.</p>
<p>Currently, the model is only in text form. Soon, I will render it in source code using <a href="http://correspondence.codeplex.com/">Correspondence</a>. Eventually, it will integrate with TFS and HP Quality Center to act as a front end and perhaps a conduit between those systems.</p>
<p>If you would like to see a simple and reliable way of writing distributed smart clients, please follow along.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index9e0f.html?p=450#respond" title="Comment on A new example of historic modeling">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-449">
				<h2><a href="indexb47e.html?p=449" rel="bookmark" title="Permanent Link to Clean URLs in Drupal with Apache and Tomcat">Clean URLs in Drupal with Apache and Tomcat</a></h2>
				<small>October 6th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>I've just returned from the land of jar -xzf. I've installed a couple of new Drupal sites (details to follow). One of those sites takes over the whole domain. The other is just a subset. I ran into trouble with the infamous "Clean URLs" feature, and only found the solution after hours of fruitless Googling.</p>
<p>Drupal is a PHP content management system. In PHP, the URL addresses the program, and any parameters must be supplied in the query string. Drupal URLs therefore look something like this: <a href="http://drupal.org/index.php?q=node/1">http://drupal.org/index.php?q=node/1</a>.</p>
<p>There are a few things we can do to make the URL prettier. First, we can configure the web server to serve index.php by default. Most web servers are initially configured to do just that, so the URL could be written like this: <a href="http://drupal.org/?q=node/1">http://drupal.org/?q=node/1</a>.</p>
<p>That's better, but SEO is harmed by the question mark. So we turn on mod_rewrite to change that URL to this: <a href="http://drupal.org/node/1" title="http://drupal.org/node/1">http://drupal.org/node/1</a>.</p>
<p><strong>A tale of two sites</strong><br />
This was all well and good. I followed the directions found on blogs too numerous to mention for configuring mod_rewrite. These instructions worked fine for one of my sites, but not the other.</p>
<p>What's the difference? On the site that worked, Drupal was installed in a subdirectory. On the site that failed, Drupal was installed in the root. The problem has something to do with the lack of a subdirectory in the URL.</p>
<p>In the course of troubleshooting, I tried removing the "?=q" from various URLs. It worked for content pages, but failed for admin pages. So, I reasoned, the problem is with "/admin" as the top folder.</p>
<p><strong>Tomcat</strong><br />
What was most telling is what happened when I entered a URL with just "/admin". The Tomcat administration page appeared. I have Tomcat installed on my server, but I'm not using it on the full Drupal site. Drupal is PHP, not Java, and this site has no other content. So why is Tomcat showing up?</p>
<p>My host (<a href="http://eapps.com/">eApps</a>) defines a default configuration for any new site I create. This configuration includes Tomcat, because I typically host Java applications rather than PHP applications. The configuration includes this line in httpd.conf (located in /etc/httpd/conf):</p>
<blockquote><p>JkMount /admin* ajp13</p></blockquote>
<p>This directs the "/admin" URL to Tomcat through mod_jk. I just removed this line from this site's configuration, and I was able to turn on clean URLs.</p>
<p>Every site is different. The solutions that you find on blogs (including this one) won't necessarily work for you. It is best to hone your troubleshooting skills and attack the problem systematically than to Google for the error message. I mean, what are the odds that your environment is exactly like mine?</p>
				</div>

				<p class="postmetadata">Posted in <a href="index81ea.html?cat=3" title="View all posts in Error messages" rel="category">Error messages</a> |   <a href="indexb47e.html?p=449#respond" title="Comment on Clean URLs in Drupal with Apache and Tomcat">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-448">
				<h2><a href="indexc79d.html?p=448" rel="bookmark" title="Permanent Link to Non-recursive WPF TreeView controls">Non-recursive WPF TreeView controls</a></h2>
				<small>October 2nd, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>A WPF TreeView control can display data in any tree structure. There are essentially two kinds of tree structures: recursive and non-recursive. Non-recursive trees are simpler.</p>
<p><a href="wp-content/uploads/2009/10/surveydatamodel.jpg"><img src="wp-content/uploads/2009/10/surveydatamodel-thumb.jpg" style="border-width: 0px" alt="SurveyDataModel" align="right" border="0" height="172" width="451" /></a>Items in a recursive tree can have children of the same type. Items in a non-recursive tree cannot. A non-recursive tree has a fixed depth, and every item on the same depth is the same type as its siblings. This makes it particularly easy to model in WPF.</p>
<p>Pictured here is a non-recursive tree structure for a survey game. A Game has Surveys, which in turn have Answers. It's a very simple tree structure with no recursion. The depth of this tree from the Game to the Answers will always be 3.</p>
<p><strong>Binding the TreeView</strong><br />
Let's start with a TreeView control that displays the surveys. We'll bind the collection to the ItemsSource of the TreeView.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">TreeView</span> <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Surveys}</span>"<span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView</span><span style="color: blue">&gt;</span></pre>
<p>The TreeView control creates a TreeViewItem for each element in the collection. We need to tell the container how to populate those TreeViewItems. We do this with a DataTemplate.</p>
<p>A DataTemplate defines the contents of an item in a container control. DataTemplates are used for things like list boxes, menus, and tree controls. A DataTemplate does not define the item itself -- the container determines that. ListBox controls have ListBoxItems. TreeView controls have TreeViewItems. The DataTemplate just defines what goes <em>into</em> that item.</p>
<p>We want each TreeViewItem to contain a TextBlock bound to the survey question. So we set the ItemTemplate property to an instance of the DataTemplate class. This DataTemplate contains a TextBox with the right binding.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">TreeView</span> <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Surveys}</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><strong><span style="color: maroon">DataTemplate</span></strong><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">TextBlock</span> <span style="color: red">Text</span>="<span style="color: blue">{Binding Question}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<strong><span style="color: maroon">DataTemplate</span></strong><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView</span><span style="color: blue">&gt;</span></pre>
<p>We want each TreeViewItem to have child items. The child items are not <em>contained</em> within the parent item. They are just a <em>property</em> of the parent item. We can't use a DataTemplate to set properties. So we switch to a special DataTemplate: HierarchicalDataTemplate.</p>
<p><strong>HierarchicalDataTemplate</strong><br />
A HierarchicalDataTemplate is a DataTemplate with an additional property: ItemsSource. This property is bound to a child collection. The template sets this property on the TreeViewItem itself.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">TreeView</span> <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Surveys}</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><strong><span style="color: maroon">HierarchicalDataTemplate</span> </strong><span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Answers}</span>"<span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">TextBlock</span> <span style="color: red">Text</span>="<span style="color: blue">{Binding Question}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<strong><span style="color: maroon">HierarchicalDataTemplate</span></strong><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView</span><span style="color: blue">&gt;</span></pre>
<p>This template will set the ItemsSource of each Survey TreeViewItem to the bound collection of Answers. But, as before, we need to tell the control what to put into those TreeViewItems. We do this by setting the ItemTemplate property of the HierarchicalDataTemplate.</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">TreeView</span> <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Surveys}</span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">HierarchicalDataTemplate</span> <span style="color: red">ItemsSource</span>="<span style="color: blue">{Binding Answers}</span>"<span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">TextBlock</span> <span style="color: red">Text</span>="<span style="color: blue">{Binding Question}</span>"/<span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">HierarchicalDataTemplate.ItemTemplate</span><span style="color: blue">&gt;</span>
                <span style="color: blue">&lt;</span><strong><span style="color: maroon">DataTemplate</span></strong><span style="color: blue">&gt;</span>
                    <span style="color: blue">&lt;</span><span style="color: maroon">TextBlock</span> <span style="color: red">Text</span>="<span style="color: blue">{Binding Response}</span>"/<span style="color: blue">&gt;</span>
                <span style="color: blue">&lt;</span>/<strong><span style="color: maroon">DataTemplate</span></strong><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span>/<span style="color: maroon">HierarchicalDataTemplate.ItemTemplate</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">HierarchicalDataTemplate</span><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView.ItemTemplate</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">TreeView</span><span style="color: blue">&gt;</span></pre>
<p>Because the Answer TreeViewItem does not need to have children, there is no need to use a HierarchicalDataTemplate at this level.</p>
<p>A non-recursive tree structure is easy to model. Since an item does not have children of its own type, there are no self-referential templates. When the tree structure can be recursive, however, things are a bit tricker. That's coming up.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="indexc79d.html?p=448#respond" title="Comment on Non-recursive WPF TreeView controls">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-445">
				<h2><a href="index0ecd.html?p=445" rel="bookmark" title="Permanent Link to Hint on socket homework">Hint on socket homework</a></h2>
				<small>October 1st, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Your homework is extended for another week, but let me give you a hint what I'm looking for. The problem was to <a href="indexe982.html?p=440">Fix the Socket API</a>. Rewrite the .NET Socket interface so that the assertions made in the MSDN documentation can be proven.</p>
<p>To give you an example of what I'm looking for, take the following assertion:</p>
<ul>
<li>You have to either call Connect or Accept before Sending and Receiving data.</li>
</ul>
<p>This is a prerequisite assertion. We must first call Connect or Accept, then we can call Send or Receive. To prove this assertion, I'll use factory methods. Here's the original Socket class:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Socket : IDisposable
{
    <span style="color: blue">public</span> Socket(SocketInformation socketInformation);
    <span style="color: blue">public</span> Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> Socket Accept();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Bind(EndPoint localEP);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Listen(<span style="color: blue">int</span> backlog);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
}</pre>
<p>Move the Send and Receive methods out of this class. We cannot call them yet. Move them into a new class called ConnectedSocket.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ConnectedSocket
{
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
}</pre>
<p>To prove that we have to call Connect or Accept before any of the ConnectedSocket methods, we make Connect and Accept factory methods:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Socket : IDisposable
{
    <span style="color: blue">public</span> Socket(SocketInformation socketInformation);
    <span style="color: blue">public</span> Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> <strong>ConnectedSocket</strong> Accept();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Bind(EndPoint localEP);
    <span style="color: blue">public</span> <strong>ConnectedSocket</strong> Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> <strong>ConnectedSocket</strong> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Listen(<span style="color: blue">int</span> backlog);
}</pre>
<p>This API proves one of the assertions in the MSDN documentation. Try the others on your own. Answers will be posted next week.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="index0ecd.html?p=445#respond" title="Comment on Hint on socket homework">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-443">
				<h2><a href="indexe0b1.html?p=443" rel="bookmark" title="Permanent Link to Table as queue">Table as queue</a></h2>
				<small>September 30th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>To play along at home, please download the <a href="wp-content/uploads/2009/09/queues.mp3" title="queues.sql">script</a> for SQL Server 2005. It may work on earlier versions, but I haven't tried it.</p>
<p>Yesterday I said that <a href="index6c6e.html?p=442">the data is the queue</a>. It is a mistake to separate the processing of data from the data itself. I proposed an architecture in which there is no workflow orchestration, there are only autonomous worker processes. These processes pick up work based on attributes of the objects on which they act, not based on any external queue.</p>
<p>There are a small number of database patterns that make this possible. One that I often use is Table as Queue.</p>
<p><strong>Setup a test environment</strong><br />
I created a test database called "Queues" to test this pattern. You can find the script attached. As it is now, this script is incorrect. We will correct it as we go along.</p>
<p>The database has two tables. The Order table holds orders that we want to process. If the order hasn't been processed, it has no confirmation number. If it has, it does. The Log table holds a log of all the steps the order processor has gone through. This will help us see how well we are doing.</p>
<p>There are three stored procedures that we'll use. The InsertLoop stored procedure generates some test data. Run this one first. The ProcessLoop stored procedure simulates the ERP process. You'll want to open two query windows and enter "EXEC ProcessLoop" in both of them. Finally, the ViewLog procedure lets us see how we did.</p>
<p><strong>Anatomy of a queue procedure</strong><br />
The ProcessLoop stored procedure begins by selecting one order to process. It returns only the ID of this order.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order]
	WHERE ConfirmationNumber IS NULL)</pre>
<p>This ID has to be the primary key of the table. This is necessary for correct queuing behavior. If it is not the primary key, we will not get the correct locks later.</p>
<p>To process the order, other details about that record will be required. These should be fetched separately by the returned ID. Do not try to combine these steps.</p>
<p><strong>Default isolation level</strong><br />
Right now, the ProcessLoop stored procedure uses the default transaction isolation level (read committed). It starts a transaction, gets an order from the queue, processes it, and updates the confirmation number.</p>
<p>Hit F5 on both of your ProcessLoop query windows. While this is running, run ViewLog. You'll see something like this:</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">89</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 12:51:18.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:18.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
</table>
<p>Both of the SPIDs are processing all of the orders. This is clearly not what we want. We want only one SPID to process each order.</p>
<p><strong>Higher isolation level</strong><br />
The other process is able to sneak in between the SELECT and the UPDATE and perform an UPDATE of its own. We want to ensure that the row that the process UPDATEs is the same version it SELECTed. The way to do this is to raise the isolation level to REPEATABLE READ. As the name implies, it ensures that two SELECTs within the same transaction will read the same data. What it also means is that an UPDATE in the same transaction will update the same version of the row. No intermediate UPDATEs will be allowed.</p>
<p>Make the following change to the ProcessLoop procedure:</p>
<pre>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ</pre>
<p>Then start the two ProcessLoops again. Before long you will get the error "Transaction (Process ID 53) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction." The other process will still be running.</p>
<p>Kill the remaining process. Close the window so that you can commit the transactions that got left open. Then open a new window and type "EXEC ProcessLoop" again to prepare for the next step.</p>
<p>If you look at the log, you'll see only one of the SPIDs represented. The logs from the other one were rolled back with its transaction.</p>
<p>What happened is that both SPIDs SELECTed the same record. The first one UPDATEd it, which prevented the second from doing so. When it tried to UPDATE, SQL recognized the deadlock and rolled it back.</p>
<p><strong>Update lock</strong><br />
What we want to do is lock the record so that the first one to SELECT it is the one to process it. We'll do this by escalating our read lock to an update lock.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] <strong>WITH (UPDLOCK)</strong>
	WHERE ConfirmationNumber IS NULL)</pre>
<p>Now run the two processes and see what happens.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">138</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 14:05:26.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.377</td>
</tr>
</table>
<p>At first glance this looks good. Each order is processed by just one SPID. But look closely at the times. The two processes are taking turns. Each one enters SELECT, but then waits for the other one to commit its transaction before SELECT returns.</p>
<p>Since we've requested an update lock, the higher transaction isolation level makes no difference. We can turn it back down to the default.</p>
<p><strong>Read past</strong><br />
We want each process to skip over locked rows. We do this by specifying the READPAST query hint.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] WITH (UPDLOCK, <strong>READPAST</strong>)
	WHERE ConfirmationNumber IS NULL)</pre>
<p>With this hint in place, we get some good behavior.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="39" height="20">583</td>
<td class="xl65" style="width: 66pt" width="88">Processing</td>
<td class="xl65" style="width: 31pt" width="41">53</td>
<td class="xl65" style="width: 132pt" width="176">2009-09-29 14:37:21.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:22.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
</table>
<p>Now the two processes are running concurrently. Each order is handled by only one process. There are no deadlocks.</p>
<p>With this pattern, the data itself can be used as a queue. But you have to remember the details:</p>
<ul>
<li>SELECT TOP 1 just the primary key of the queue table.</li>
<li>Use both the UPDLOCK and READPAST query hints on the SELECT.</li>
<li>Fetch additional information by ID in a separate query.</li>
<li>After operating on the data, update the record to exclude it from the original WHERE clause.</li>
<li>Perform both the SELECT and the UPDATE within the same transaction.</li>
</ul>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="indexe0b1.html?p=443#respond" title="Comment on Table as queue">No Comments &#187;</a></p>
			</div>

		
			<div class="post" id="post-442">
				<h2><a href="index6c6e.html?p=442" rel="bookmark" title="Permanent Link to The data is the queue">The data is the queue</a></h2>
				<small>September 29th, 2009 <!-- by Michael L Perry --></small>

				<div class="entry">
					<p>Our eCommerce system uses BizTalk to process orders. The BizTalk orchestration keeps track of the status of the order. Queues keep track of communications between BizTalk and external systems, like the ERP. The database is updated at all points in the process so the web site reflects the current order status.</p>
<p>This system is fragile.</p>
<p><strong>Problem 1: Diagnostics are scattered</strong><br />When something goes wrong, there are different ways of observing the system. The customer observes it from the web. They call support to report a problem. Support looks at the system in the Business Activity Monitor (BAM). They call ops. Ops observes the system through Health and Activity Tracking (HAT). If an activity is waiting on the receipt of a message, they will then inspect the appropriate queue. Each of these places holds part of the story.</p>
<p><strong>Problem 2: Things get out of sync</strong><br />In order to fix a problem, ops needs to take action at some level. They might cancel an orchestration. They might delete a message from a queue. They might manually enter an order into the ERP. When they do, the other parts of the system don't know about the change.</p>
<p><strong>Problem 3: Blocking</strong><br />One process is querying by status; another is updating it. One process is working on a request; another needs to skip it and go to the next. The workflow problem seems to attract blocking behaviors.</p>
<p><strong>Problem 4: Distributed transactions</strong><br />When the orchestration moves from one step to another, it needs to update the order status. Before it can wait on the receive queue, it must push to the send queue. It would be disastrous to perform one of these operations without also performing the other. So the BizTalk message box, the order database, and the outgoing and incoming message queues must be accessed within the same transaction. This brings the Distributed Transaction Coordinator into the picture, increasing fragility and exacerbating blocking behaviors.</p>
<p><strong>Here's my solution</strong><br />There is no need to manage workflow separate from data. This is the fundamental flaw in all workflow systems: BizTalk, WF, MSMQ, Service Broker, just to name a few. They all have their own data storage separate from the subject of the workflow.</p>
<p>If we relied upon the Order table instead of using BizTalk and external queues, we would have a more consistent system. We could diagnose the entire workflow from the database. Having one shared system of record, services would never get out of sync. Certain patterns could be used to eliminate unnecessary blocking. And all transactions would be local.</p>
<p>Broken down in this way, the system no longer has an overarching orchestration. You cannot open a designer and see the workflow. Instead, it has a number of autonomous processes that each move a unit of work further along the pipeline. Each process does its work in the same database.</p>
<p>There is one cardinal rule that makes this possible. <strong>The action that a process performs must also remove it from its queue.</strong></p>
<p>A process runs a query to get a work item. It then performs some action on that work item. The outcome of that action is going to be a single database command. That command, whatever it is, must render the work item ineligible for the query.</p>
<p>It is tempting to perform two database commands in the same transaction: record the results of the action and update the work item status. Avoid this pattern. This allows work items to become out of sync. Instead, design one database command that both records the result and disqualifies the work item from the query.</p>
<p><strong>Confirmation number</strong><br />Let's look at one unit of the order processing orchestration. Take the part of the system that submits the order to the ERP system. This process sends an order to a web service, and receives a confirmation number. So what if we designed this process to use the following query?</p>
<pre>SELECT TOP 1 OrderId, OrderDetails FROM [Order] WHERE ConfirmationNumber IS NULL</pre>
<p>And then recording the results of the action was:</p>
<pre>UPDATE [Order] SET ConfirmationNumber ? WHERE OrderId = ?</pre>
<p>This single UPDATE statement disqualifies the order from the SELECT statement. That means that the process will move the unit of work forward, but it can never be out of sync.</p>
<p>Unfortunately, this SELECT ... UPDATE pattern is prone to blocking. We'll look at some patterns that satisfy this cardinal rule without blocking in future posts.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="index6c6e.html?p=442#respond" title="Comment on The data is the queue">No Comments &#187;</a></p>
			</div>

		
		<div class="navigation">
			<div class="alignleft"><a href="index128d.html?paged=12">&laquo; Previous Entries</a></div>
			<div class="alignright"><a href="indexe43e.html?paged=10">Next Entries &raquo;</a></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 21 queries. 0.451 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?paged=11 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:10:21 GMT -->
</html>
