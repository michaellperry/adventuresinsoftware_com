<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?cat=39 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software   &raquo; Entity Framework</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

		
		 		<h2 class="pagetitle">Archive for the &#8216;Entity Framework&#8217; Category</h2>

 	  

		<div class="navigation">
			<div class="alignleft"></div>
			<div class="alignright"></div>
		</div>

				<div class="post">
				<h3 id="post-558"><a href="index193e.html?p=558" rel="bookmark" title="Permanent Link to Linq to SQL and the Repository Pattern">Linq to SQL and the Repository Pattern</a></h3>
				<small>Monday, September 27th, 2010</small>

				<div class="entry">
					<p>Earlier this month, I posted <a href="indexa165.html?p=550">Entity Framework and the Repository Pattern</a>. Mickey <a href="http://github.com/mickeyvip/RepositoryPattern">posted</a> that code on GitHub, along with his own Linq to SQL implementation.</p>
<p>For those new to Git, here’s how you can get Mickey’s repository:</p>
<ul>
<li>Install <a href="http://code.google.com/p/msysgit/">msysgit</a> (if you are on Windows).</li>
<li>Create a folder for the project.</li>
<li>Right-click and choose “Git Bash Here”.</li>
<li>git init</li>
<li>git remote add origin <a href="http://github.com/mickeyvip/RepositoryPattern.git">http://github.com/mickeyvip/RepositoryPattern.git</a></li>
<li>git pull origin master</li>
<li>Open RepositoryPattern.sln.</li>
</ul>
<p>Mickey took the time to complete the story for me. I posted only enough code to make my point (which was, BTW, that the Repository Pattern takes more work than you might expect). Mikey reverse engineered the database that I used for my example, and even populated it with data from this blog. Wow!</p>
<p>Now let’s review his work.</p>
<h3>Tests</h3>
<p><a href="wp-content/uploads/2010/09/image.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; margin-left: 0px; border-top: 0px; margin-right: 0px; border-right: 0px" title="image" border="0" alt="image" align="right" src="wp-content/uploads/2010/09/image-thumb.png" width="244" height="184" /></a> Mickey not only includes unit test (the motivation for my original post), but also integration tests. Just open the solution and hit Ctrl+R, A to run all tests. If you find that the tests don’t deploy the database file, double-click the Local.testsettings file and add the dbf to the Deployment section. I found that the tests passed before I turned on code coverage, but then I had to make this change.</p>
<p>I enabled code coverage and found that he achieves 92%-100% in all modules except for the generated code. The reason that it is not 100% is mostly due to the fact that my original tests didn’t add anything to the repository.</p>
<h3>Two sets of data types</h3>
<p>The goal of the original post was not persistence ignorance, it was testing. But persistence ignorance is often a reason for using the Repository Pattern. Mickey’s solution is not persistence ignorant, either.</p>
<p>If you look in the Data project, you will see NoteworthyEntitiesL2SModel.dbml <em>and</em> NoteworthyEntitiesEFModel.edmx. That is, he used both EF and L2S to generate models from the database. This created two separate sets of data types.</p>
<p>This division necessarily permeates the solution, since those generated data types are exposed from the repository. As a result, he has a separate memory provider for each data access technology. The EF memory provider expects ObjectContext and ObjectQuery. The L2S memory provider replaces those with DataContext and Table.</p>
<p>Both of the memory providers have unit tests. They distinguish between the two by namespace. EF and L2S use different strategies for naming associative tables, but other than that the code looks the same.</p>
<p>In practice, you will typically choose one data access technology, so this lack of persistence ignorance is not a problem. But if it bothers you, please look into POCO support for EF and L2S to see if there’s a way to remove the dependency upon the data access technology.</p>
<h3>Thank you, Mickey</h3>
<p>I am quite impressed with the effort that Mickey put into packaging this example and making it available to us. He took code that only worked on my machine and filled in the missing components so that we can all run the tests. And he took what was working for Entity Framework and ported it to Linq to SQL so that you have the choice. Now, either way you go, you can test your data services.</p>
<p>Thanks, man.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index9591.html?cat=37" title="View all posts in DDD" rel="category">DDD</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a>,  <a href="index3f7b.html?cat=2" title="View all posts in Unit testing" rel="category">Unit testing</a> |   <a href="index193e.html?p=558#respond" title="Comment on Linq to SQL and the Repository Pattern">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-550"><a href="indexa165.html?p=550" rel="bookmark" title="Permanent Link to Entity Framework and the Repository Pattern">Entity Framework and the Repository Pattern</a></h3>
				<small>Thursday, September 9th, 2010</small>

				<div class="entry">
					<p>When I’ve asked <a href="http://stackoverflow.com/questions/575190/is-there-an-in-memory-provider-for-entity-framework">how to unit test Entity Framework</a>, the best answer was “use the Repository pattern to encapsulate your EF code” (thanks <a href="http://andrewpeters.net/">Andrew Peters</a>). I recently asked the same thing about RIA Services. <a href="http://azurecoding.net/blogs/brownie/">Mike Brown</a> responded with the same advice, even going so far as to spend a couple of hours with me on Live Meeting.</p>
<p>Since <strong>all you gotta do is</strong> implement the Repository Pattern, it should be easy, right? Let’s take a look at a minimalist implementation.</p>
<h3>Inject the implementation</h3>
<p>To support unit testing, we need to be able to swap out our implementation. At the top level, the consumer of a repository begins a unit of work. So we’ll inject a unit of work factory.</p>
<pre class="code"><span style="color: blue">public interface </span><span style="color: #2b91af">IUnitOfWorkFactory
</span>{
    <span style="color: #2b91af">IUnitOfWork </span>Begin();
}</pre>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">NoteworthyService
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">IUnitOfWorkFactory </span>_unitOfWorkFactory;

    <span style="color: blue">public </span>NoteworthyService(<span style="color: #2b91af">IUnitOfWorkFactory </span>unitOfWorkFactory)
    {
        _unitOfWorkFactory = unitOfWorkFactory;
    }
}</pre>
<h3>Identify the repository</h3>
<p>In DDD we create one repository per aggregate root, which is the entity from which you begin the query. In EF, entities exist in a container. So we’ll take two steps to get the repository via the container.</p>
<pre class="code"><span style="color: blue">public interface </span><span style="color: #2b91af">IUnitOfWork </span>: <span style="color: #2b91af">IDisposable
</span>{
    <span style="color: #2b91af">IContainer</span>&lt;TContainer&gt; UsingContainer&lt;TContainer&gt;()
        <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>();
}

<span style="color: blue">public interface </span><span style="color: #2b91af">IContainer</span>&lt;TContainer&gt; : <span style="color: #2b91af">IDisposable
</span>{
    <span style="color: #2b91af">IRepository</span>&lt;TEntity&gt; GetRepository&lt;TEntity&gt;(<span style="color: #2b91af">Func</span>&lt;TContainer, <span style="color: #2b91af">ObjectQuery</span>&lt;TEntity&gt;&gt; repositorySelector)
        <span style="color: blue">where </span>TEntity : <span style="color: #2b91af">EntityObject</span>;
}</pre>
<h3>Provide a specification</h3>
<p>The second half of the Repository Pattern is the Specification. A specification identifies which entities to pull from the repository. In Linq, we use lambdas for that. So a repository should be able to give you back some entities when given a lambda.</p>
<pre class="code"><span style="color: blue">public interface </span><span style="color: #2b91af">IRepository</span>&lt;TEntity&gt;
{
    <span style="color: #2b91af">IQueryable</span>&lt;TEntity&gt; GetSatisfying(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;TEntity, <span style="color: blue">bool</span>&gt;&gt; specification);
    <span style="color: blue">void </span>Add(TEntity entity);
}</pre>
<h3>Query the repository</h3>
<p>With those interfaces in place, here’s what a query looks like.</p>
<pre class="code"><span style="color: blue">public </span><span style="color: #2b91af">List</span>&lt;<span style="color: #2b91af">Article</span>&gt; GetArticlesByTopic(<span style="color: blue">string </span>topicName)
{
    <span style="color: blue">using </span>(<span style="color: blue">var </span>unitOfWork = _unitOfWorkFactory.Begin())
    {
        <span style="color: blue">return </span>unitOfWork.UsingContainer&lt;<span style="color: #2b91af">NoteworthyEntities</span>&gt;().GetRepository(container =&gt; container.Articles)
            .GetSatisfying(article =&gt; article.Topics.Any(topic =&gt; topic.TopicName == topicName))
            .ToList();
    }
}</pre>
<h3>Implement in memory</h3>
<p>For unit testing, we implement the repository interfaces using in-memory lists.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">MemoryUnitOfWorkFactory </span>: <span style="color: #2b91af">IUnitOfWorkFactory
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">MemoryUnitOfWork </span>_unitOfWork = <span style="color: blue">new </span><span style="color: #2b91af">MemoryUnitOfWork</span>();

    <span style="color: blue">public </span><span style="color: #2b91af">IUnitOfWork </span>Begin()
    {
        <span style="color: blue">return </span>_unitOfWork;
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">MemoryUnitOfWork </span>: <span style="color: #2b91af">IUnitOfWork
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: blue">object</span>&gt; _containerByType = <span style="color: blue">new </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: blue">object</span>&gt;();

    <span style="color: blue">public </span><span style="color: #2b91af">IContainer</span>&lt;TContainer&gt; UsingContainer&lt;TContainer&gt;()
        <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>()
    {
        <span style="color: blue">object </span>container;
        <span style="color: blue">if </span>(!_containerByType.TryGetValue(<span style="color: blue">typeof</span>(TContainer), <span style="color: blue">out </span>container))
        {
            container = <span style="color: blue">new </span><span style="color: #2b91af">MemoryContainer</span>&lt;TContainer&gt;();
            _containerByType.Add(<span style="color: blue">typeof</span>(TContainer), container);
        }
        <span style="color: blue">return </span>(<span style="color: #2b91af">IContainer</span>&lt;TContainer&gt;)container;
    }

    <span style="color: blue">public void </span>Dispose()
    {
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">MemoryContainer</span>&lt;TContainer&gt; : <span style="color: #2b91af">IContainer</span>&lt;TContainer&gt;
    <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>()
{
    <span style="color: blue">private </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: blue">object</span>&gt; _containerByType = <span style="color: blue">new </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: blue">object</span>&gt;();

    <span style="color: blue">public </span><span style="color: #2b91af">IRepository</span>&lt;TEntity&gt; GetRepository&lt;TEntity&gt;(<span style="color: #2b91af">Func</span>&lt;TContainer, <span style="color: #2b91af">ObjectQuery</span>&lt;TEntity&gt;&gt; repositorySelector)
        <span style="color: blue">where </span>TEntity : <span style="color: #2b91af">EntityObject
    </span>{
        <span style="color: blue">object </span>container;
        <span style="color: blue">if </span>(!_containerByType.TryGetValue(<span style="color: blue">typeof</span>(TEntity), <span style="color: blue">out </span>container))
        {
            container = <span style="color: blue">new </span><span style="color: #2b91af">MemoryRepository</span>&lt;TEntity&gt;();
            _containerByType.Add(<span style="color: blue">typeof</span>(TEntity), container);
        }
        <span style="color: blue">return </span>(<span style="color: #2b91af">IRepository</span>&lt;TEntity&gt;)container;
    }

    <span style="color: blue">public void </span>Dispose()
    {
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">MemoryRepository</span>&lt;TEntity&gt; : <span style="color: #2b91af">IRepository</span>&lt;TEntity&gt;
    <span style="color: blue">where </span>TEntity : <span style="color: #2b91af">EntityObject
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">List</span>&lt;TEntity&gt; _entities = <span style="color: blue">new </span><span style="color: #2b91af">List</span>&lt;TEntity&gt;();

    <span style="color: blue">public </span><span style="color: #2b91af">IQueryable</span>&lt;TEntity&gt; GetSatisfying(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;TEntity, <span style="color: blue">bool</span>&gt;&gt; specification)
    {
        <span style="color: blue">return </span>_entities.Where(specification.Compile()).AsQueryable();
    }

    <span style="color: blue">public void </span>Add(TEntity entity)
    {
        _entities.Add(entity);
    }
}</pre>
<p>And here’s what a unit test looks like.</p>
<pre class="code">[<span style="color: #2b91af">TestClass</span>]
<span style="color: blue">public class </span><span style="color: #2b91af">NoteworthyServiceTest
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">NoteworthyService </span>_noteworthyService;

    [<span style="color: #2b91af">TestInitialize</span>]
    <span style="color: blue">public void </span>Initialize()
    {
        <span style="color: #2b91af">IUnitOfWorkFactory </span>memory = <span style="color: blue">new </span><span style="color: #2b91af">MemoryUnitOfWorkFactory</span>();

        <span style="color: #2b91af">IRepository</span>&lt;<span style="color: #2b91af">Article</span>&gt; articlesRepository = memory.Begin()
            .UsingContainer&lt;<span style="color: #2b91af">NoteworthyEntities</span>&gt;()
            .GetRepository(container =&gt; container.Articles);
        <span style="color: #2b91af">Topic </span>ddd = <span style="color: blue">new </span><span style="color: #2b91af">Topic</span>()
        {
            TopicName = <span style="color: #a31515">&quot;ddd&quot;
        </span>};
        <span style="color: #2b91af">Topic </span>corresopndence = <span style="color: blue">new </span><span style="color: #2b91af">Topic</span>()
        {
            TopicName = <span style="color: #a31515">&quot;correspondence&quot;
        </span>};
        <span style="color: #2b91af">Article </span>efRepository = <span style="color: blue">new </span><span style="color: #2b91af">Article</span>()
        {
            Title = <span style="color: #a31515">&quot;Entity Framework and the Repository Pattern&quot;
        </span>};
        efRepository.Topics.Add(ddd);
        <span style="color: #2b91af">Article </span>correspondenceLaunch = <span style="color: blue">new </span><span style="color: #2b91af">Article</span>()
        {
            Title = <span style="color: #a31515">&quot;Correspondence Launch&quot;
        </span>};
        correspondenceLaunch.Topics.Add(corresopndence);
        <span style="color: #2b91af">Article </span>correspondenceDDD = <span style="color: blue">new </span><span style="color: #2b91af">Article</span>()
        {
            Title = <span style="color: #a31515">&quot;Correspondence and DDD&quot;
        </span>};
        correspondenceDDD.Topics.Add(ddd);
        correspondenceDDD.Topics.Add(corresopndence);

        articlesRepository.Add(efRepository);
        articlesRepository.Add(correspondenceLaunch);
        articlesRepository.Add(correspondenceDDD);

        _noteworthyService = <span style="color: blue">new </span><span style="color: #2b91af">NoteworthyService</span>(memory);
    }

    [<span style="color: #2b91af">TestMethod</span>]
    <span style="color: blue">public void </span>QueryReturnsArticles()
    {
        <span style="color: blue">var </span>articles = _noteworthyService.GetArticlesByTopic(<span style="color: #a31515">&quot;ddd&quot;</span>).ToArray();

        <span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: #a31515">&quot;Entity Framework and the Repository Pattern&quot;</span>, articles[0].Title);
        <span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: #a31515">&quot;Correspondence and DDD&quot;</span>, articles[1].Title);
    }
}</pre>
<h3>Implement with Entity Framework</h3>
<p>Finally, we implement the real thing using Entity Framework.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">EntityFrameworkUnitOfWorkFactory </span>: <span style="color: #2b91af">IUnitOfWorkFactory
</span>{
    <span style="color: blue">public </span><span style="color: #2b91af">IUnitOfWork </span>Begin()
    {
        <span style="color: blue">return new </span><span style="color: #2b91af">EntityFrameworkUnitOfWork</span>();
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">EntityFrameworkUnitOfWork </span>: <span style="color: #2b91af">IUnitOfWork
</span>{
    <span style="color: blue">private </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: #2b91af">IDisposable</span>&gt; _containerByType = <span style="color: blue">new </span><span style="color: #2b91af">Dictionary</span>&lt;<span style="color: #2b91af">Type</span>, <span style="color: #2b91af">IDisposable</span>&gt;();

    <span style="color: blue">public </span><span style="color: #2b91af">IContainer</span>&lt;TContainer&gt; UsingContainer&lt;TContainer&gt;()
        <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>()
    {
        <span style="color: #2b91af">IDisposable </span>container;
        <span style="color: blue">if </span>(!_containerByType.TryGetValue(<span style="color: blue">typeof</span>(TContainer), <span style="color: blue">out </span>container))
        {
            container = <span style="color: blue">new </span><span style="color: #2b91af">EntityFrameworkContainer</span>&lt;TContainer&gt;();
            _containerByType.Add(<span style="color: blue">typeof</span>(TContainer), container);
        }
        <span style="color: blue">return </span>(<span style="color: #2b91af">IContainer</span>&lt;TContainer&gt;)container;
    }

    <span style="color: blue">public void </span>Dispose()
    {
        <span style="color: blue">foreach </span>(<span style="color: blue">var </span>container <span style="color: blue">in </span>_containerByType.Values)
            container.Dispose();
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">EntityFrameworkContainer</span>&lt;TContainer&gt; : <span style="color: #2b91af">IContainer</span>&lt;TContainer&gt;
    <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>()
{
    <span style="color: blue">private </span>TContainer _container;

    <span style="color: blue">public </span>EntityFrameworkContainer()
    {
        _container = <span style="color: blue">new </span>TContainer();
    }

    <span style="color: blue">public </span><span style="color: #2b91af">IRepository</span>&lt;TEntity&gt; GetRepository&lt;TEntity&gt;(<span style="color: #2b91af">Func</span>&lt;TContainer, <span style="color: #2b91af">ObjectQuery</span>&lt;TEntity&gt;&gt; repositorySelector)
        <span style="color: blue">where </span>TEntity : <span style="color: #2b91af">EntityObject
    </span>{
        <span style="color: blue">return new </span><span style="color: #2b91af">EntityFrameworkRepository</span>&lt;TContainer, TEntity&gt;(_container, repositorySelector(_container));
    }

    <span style="color: blue">public void </span>Dispose()
    {
        _container.Dispose();
    }
}

<span style="color: blue">public class </span><span style="color: #2b91af">EntityFrameworkRepository</span>&lt;TContainer, TEntity&gt; : <span style="color: #2b91af">IRepository</span>&lt;TEntity&gt;
    <span style="color: blue">where </span>TContainer : <span style="color: #2b91af">ObjectContext</span>, <span style="color: blue">new</span>()
    <span style="color: blue">where </span>TEntity : <span style="color: #2b91af">EntityObject
</span>{
    <span style="color: blue">private </span>TContainer _container;
    <span style="color: blue">private </span><span style="color: #2b91af">ObjectQuery</span>&lt;TEntity&gt; _objectQuery;

    <span style="color: blue">public </span>EntityFrameworkRepository(TContainer container, <span style="color: #2b91af">ObjectQuery</span>&lt;TEntity&gt; objectQuery)
    {
        _container = container;
        _objectQuery = objectQuery;
    }

    <span style="color: blue">public </span><span style="color: #2b91af">IQueryable</span>&lt;TEntity&gt; GetSatisfying(<span style="color: #2b91af">Expression</span>&lt;<span style="color: #2b91af">Func</span>&lt;TEntity, <span style="color: blue">bool</span>&gt;&gt; specification)
    {
        <span style="color: blue">return </span>_objectQuery.Where(specification);
    }

    <span style="color: blue">public void </span>Add(TEntity entity)
    {
        _container.AddObject(_objectQuery.Name, entity);
    }
}</pre>
<h3>Analysis</h3>
<p>This is the smallest implementation of the Repository pattern that I could come up with. It is obviously not feature complete. For example, it does not implement Delete, nor does it allow you to specify eager loading with Include. There are <a href="http://www.codeproject.com/KB/database/ImplRepositoryPatternEF.aspx">other implementations that are bigger</a>, but I doubt that there could be one smaller. Even at this size, this doesn’t qualify as “all you need to do is”.</p>
<p>One benefit of the Repository pattern is supposed to be that it abstracts the persistence mechanism. But this implementation returns EntityObjects, which are a distinctly Entity Framework-ish data type. I could try for a POCO compliant implementation to solve that problem.</p>
<p>Because this implementation requires EntityObjects, it could never work with RIA Services. I would have to write a different Repository implementation to unit test my client code.</p>
<p>And finally, Entity Framework does some things that the in-memory repository does not. My unit tests can’t verify that I’m using EF correctly. For example, Entity Framework does eager loading if I explicitly request it. The in-memory implementation always has all navigation properties populated. Because of this difference, I can’t verify with a unit test that I have included all of the required navigations.</p>
<h3>Conclusion</h3>
<p>All of this leads me to conclude that the Repository pattern is not the best way to add testability to an untestable framework. The framework needs to be testable from the beginning. If Entity Framework had provided an in-memory implementation for testing, then I could test <em>my use of</em> EF, including eager loading.</p>
<p>By the way, <a href="http://correspondence.codeplex.com/">Correspondence</a> does in fact provide an in-memory implementation for unit testing. Please go through the lessons to see what I think a testable framework should look like.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index9591.html?cat=37" title="View all posts in DDD" rel="category">DDD</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a>,  <a href="index3f7b.html?cat=2" title="View all posts in Unit testing" rel="category">Unit testing</a> |   <a href="indexa165.html?p=550#comments" title="Comment on Entity Framework and the Repository Pattern">6 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-478"><a href="index50ba.html?p=478" rel="bookmark" title="Permanent Link to Entity Framework exception from Sum over an empty set">Entity Framework exception from Sum over an empty set</a></h3>
				<small>Monday, January 18th, 2010</small>

				<div class="entry">
					<p>The sum of an empty set is zero. This is a well-known mathematical truth that the .NET Framework understands.</p>
<pre><span style="color: blue">int</span> sum = <span style="color: #2b91af">Enumerable</span>.Empty&lt;<span style="color: blue">int</span>&gt;().Sum();
<span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: maroon">0</span>, sum);</pre>
<p>Entity Framework 1.0, however, doesn’t work like that. If you try to sum an empty set, it will throw an exception.</p>
<pre><span style="color: #2b91af">OrderEntities</span> entities = <span style="color: blue">new</span> <span style="color: #2b91af">OrderEntities</span>();
<span style="color: blue">int</span> totalQuantity = entities.OrderLine
    .Where(orderLine =&gt; <span style="color: maroon">false</span>)
    .Sum(orderLine =&gt; orderLine.Quantity);
<span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: maroon">0</span>, totalQuantity);</pre>
<blockquote>
<p>System.InvalidOperationException: The cast to value type 'Int32' failed because the materialized value is null. Either the result type's generic parameter or the query must use a nullable type.</p>
</blockquote>
<p><strong>Here’s my solution</strong> </p>
<p>Let Sum return a nullable integer. Then, if it is null, coerce it back to zero.</p>
<pre><span style="color: #2b91af">OrderEntities</span> entities = <span style="color: blue">new</span> <span style="color: #2b91af">OrderEntities</span>();
<span style="color: blue">int</span> totalQuantity = entities.OrderLine
    .Where(orderLine =&gt; <span style="color: maroon">false</span>)
    .Sum(orderLine =&gt; <strong>(<span style="color: blue">int?</span>)</strong>orderLine.Quantity)<strong> ?? <span style="color: maroon">0</span></strong>;
<span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: maroon">0</span>, totalQuantity);</pre>
<p>You know that Quantity cannot be null. I know that Quantity cannot be null. But we have to trick Entity Framework into thinking that it could be null. By casting the integer to int?, you select the Sum overload that allows for a null. Since Entity Framework doesn’t do the right thing with that null, then we’ll do it ourselves.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="index50ba.html?p=478#comments" title="Comment on Entity Framework exception from Sum over an empty set">4 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-306"><a href="indexf167.html?p=306" rel="bookmark" title="Permanent Link to Lookup tables should not be modeled as related entities in Entity Framework">Lookup tables should not be modeled as related entities in Entity Framework</a></h3>
				<small>Monday, March 16th, 2009</small>

				<div class="entry">
					<p><a href="wp-content/uploads/2009/03/orderstatusedmx.png"><img src="wp-content/uploads/2009/03/orderstatusedmx-thumb.png" style="border: 0px none " alt="OrderStatusEDMX" align="right" border="0" width="244" height="134" /></a> I am tracking the status of an order in an eCommerce system. In the database, I have a table called OrderStatus that lists all of the statuses that an order can be in. Lookup table like this are useful for populating combo-boxes and running reports. And a foreign key constraint on the status column ensures the status of each order is within the set.</p>
<p>But within code, the lookup table is not necessary. I created an enumeration for the status values. The IDs were well-known. I didn't care about the descriptions.</p>
<p>I brought both the Order entity and the OrderStatus entity into the EDMX. The Order entity so I could create orders, and the OrderStatus entity to populate a combo-box. Since the Order table has a foreign key constraint relating it to OrderStatus, Entity Framework created a relationship. This caused problems.</p>
<p>When inserting an Order, I needed to set its status. So I created an OrderStatus and set its ID:</p>
<pre>order.OrderStatus = <span style="color: blue">new</span> <font color="#2c92af">OrderStatus</font>() { OrderStatusId = <font color="#2c92af">OrderStatusEnum</font>.Submitted };</pre>
<p>Entity Framework did not see this as setting the foreign key. Instead, it saw this as inserting both an Order and an OrderStatus. The result was a uniqueness constraint violation. The correct way to do this is to query for the existing order status, and then set the reference in the new order.</p>
<pre><font color="#2c92af">OrderContainer</font> container = <span style="color: blue">new</span> <font color="#2c92af">OrderContainer</font>();
order.OrderStatus =
  container.OrderStatus
    .Where(s =&gt; s.OrderStatusId == (<span style="color: blue">byte</span>)<font color="#2c92af">OrderStatusEnum</font>.Submitted)
    .First();</pre>
<p>That just seems like too much work to set a foreign key in a row that I'm inserting. I decided instead to delete the relationship that EF had created between Order and OrderStatus. Upon doing so, I received this error validating the model.</p>
<blockquote><p>Foreign key constraint 'FK_Order_OrderStatus' from table Orders (OrderStatusId) to table OrderStatus (OrderStatusId):: Insufficient mapping: Foreign key must be mapped to some AssociationSet on the conceptual side.</p></blockquote>
<p>Entity Framework had pulled the foreign key constraint in from the database schema, and it needed to be mapped. I just deleted the association on the "conceptual side" (i.e. the EDMX designer surface) that represented that constraint.</p>
<p><strong>Here's my solution</strong><br />
I actually have three. First, I could go back to my database and delete the foreign key constraint. This would make EF happy, but it would also remove the extra check on order status. It would take away some information that could be used by reporting tools. The foreign key constraint is the correct model, relationally, and I did not want to violate that model to satisfy EF. So I didn't do it.</p>
<p>Next, I could move OrderStatus to its own EDMX. I took this approach on other parts of the system that had several lookup tables, creating one single Lookup.EDMX file for all of them. This would prevent EF from importing the related tables in the same context, and would prevent it from creating the relationship. This seemed a bit much in this case, since I didn't have any other lookups, so I didn't do it.</p>
<p>Finally, I could remove the imported foreign key constraint. This requires hand-editing the XML, since the model browser doesn't allow you to delete any of the constraints that it has imported. To edit the XML, right-click on the EDMX file in solution explorer, select "Open With..." and then "XML Editor".</p>
<p>Find the AssociationSet element that refers to the foreign key that's giving you trouble. I deleted this chunk of XML:</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">AssociationSet</span> <span style="color: red">Name</span>="<span style="color: blue">FK_Order_OrderStatus</span>" <span style="color: red">Association</span>="<span style="color: blue">Order.Store.FK_Order_OrderStatus</span>"<span style="color: blue">&gt;</span>
  <span style="color: blue">&lt;</span><span style="color: maroon">End</span> <span style="color: red">Role</span>="<span style="color: blue">OrderStatus</span>" <span style="color: red">EntitySet</span>="<span style="color: blue">OrderStatus</span>" /<span style="color: blue">&gt;</span>
  <span style="color: blue">&lt;</span><span style="color: maroon">End</span> <span style="color: red">Role</span>="<span style="color: blue">Orders</span>" <span style="color: red">EntitySet</span>="<span style="color: blue">Orders</span>" /<span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">AssociationSet</span><span style="color: blue">&gt;</span></pre>
<p>After cleaning that up, my EDMX validated again. Finally, to set the foreign key myself, I added a scalar property and mapped it to the column in the table.</p>
<p>This is another case of the tool trying too hard to help you out. It can't tell based on the relational model that this is a lookup table, and that it is not supposed to insert rows. Entity Framework tries very hard to keep you from managing foreign keys yourself. But the database <em>is</em> relational, and you <em>do</em> need to know about constraints and foreign keys. You have to be incredibly forceful to get the tool to move out of your way and let you see the model as it truly is.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="indexf167.html?p=306#comments" title="Comment on Lookup tables should not be modeled as related entities in Entity Framework">4 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-302"><a href="index52e8.html?p=302" rel="bookmark" title="Permanent Link to Entity Framework doesn&#8217;t properly model a summary view">Entity Framework doesn&#8217;t properly model a summary view</a></h3>
				<small>Thursday, March 12th, 2009</small>

				<div class="entry">
					<p>Entity Framework does not understand the difference between independent and dependent data.</p>
<p><a href="wp-content/uploads/2009/03/orderedmx.png"><img src="wp-content/uploads/2009/03/orderedmx-thumb.png" style="border: 0px none " alt="OrderEDMX" align="right" border="0" width="244" height="239" /></a> We have in our schema a table containing orders, and another table containing order lines. We have a web page that shows a filtered list of orders. This page can be filtered and sorted according to several properties of the order, including total. Total is a dependent property, calculated from the order lines.</p>
<p>To accomplish this filtering and sorting in the database, we've created an order summary view. This view aggregates properties of an order that depend upon its lines. The order and order line tables represent independent data -- they can be changed -- while the order summary view represents dependent data -- its behavior depends upon other objects.</p>
<p>We've modeled this in Entity Framework in the picture to the right. An order has many order lines. An order is also associated with one order summary. We can write queries for orders based on properties of order summary. This works.</p>
<p><strong>Insert fails</strong><br />
The problem happens when we insert an order. Because the order is in one-to-one association with an order summary, Entity Framework wants us to create an OrderSummary object at the same time.</p>
<blockquote><p>Entities in 'OrderContainer.Order' participate in the 'OrderOrderSummary' relationship. 0 related 'OrderSummary' were found. 1 'OrderSummary' is expected.</p></blockquote>
<p>Entity Framework does not understand that the OrderSummary view is dependent upon the Order table. When I insert into Order, the database calculates an OrderSummary. It thinks that OrderSummary is independent -- that I have to insert it myself.</p>
<p><strong>Here's my bad solution</strong><br />
I changed multiplicity of the OrderSummary end from "One" to "Zero or One". This tells Entity Framework that the OrderSummary relationship is not required. Unfortunately, this is not the correct model. There always <em>will</em> be an order summary. If there is an order, the view will contain a row for it. One-to-one is not just a requirement, it is a promise. If the model only claims one-to-zero or one, then this promise is not expressed.</p>
<p>When making this change, the following error appeared briefly:</p>
<blockquote><p>The multiplicity 'ZeroOrOne' on End 'OrderSummary' in the conceptual side Association 'Order.OrderOrderSummary' doesn't match with multiplicity 'One' on end 'OrderSummary' on the object side Association 'Order.OrderOrderSummary'.</p></blockquote>
<p>I don't recall when it went away, but I went through a few gyrations of saving, closing, reopening, refreshing, and shaking the box. This particular relationship was not generated from the database. How could it have been, since views don't have foreign key constraints. There should be no "conceptual side" to get out of sync, but there must have been something in the EDMX that thought differently.</p>
<p><strong>A better solution</strong><br />
I would prefer to tell EF that OrderSummary is dependent. It should know that I never have to insert it, update it, or delete it. Independent data can be changed. Dependent data cannot.</p>
<p>Since that is not possible, I am considering moving the dependent fields from OrderSummary into Order itself. I may do this with a multi-table mapping (actually, one table and one view). Or I may expose all of the Order columns in the OrderSummary view and just bind Order to this view.</p>
<p>Or I may skip the OrderSummary view altogether and see if I can express the total in linq. If linq can generate the appropriate aggregate, sort by it, and filter by it, then the view would not even be necessary. In this case, at least. We'll see.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="index52e8.html?p=302#respond" title="Comment on Entity Framework doesn&#8217;t properly model a summary view">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-298"><a href="indexba86.html?p=298" rel="bookmark" title="Permanent Link to Entity Framework query based on properties of related objects">Entity Framework query based on properties of related objects</a></h3>
				<small>Thursday, March 5th, 2009</small>

				<div class="entry">
					<p>We're using Entity Framework for data access on an enterprise system. It has been painful, but we've gradually learned how to use the product. This last problem was our fault, but we blamed the tool.</p>
<p>The situation is that we have Orders with OrderLines. We want to find all orders that include a particular item. From those orders, we want to get information from a related entity called OrderSummary.</p>
<p>We tried several approaches until we found a syntax that would compile and give us the right set of orders. What we ended up with was a linq query using two "from" clauses:</p>
<pre><font color="#2c92af">OrderContainer</font> container = <span style="color: blue">new</span> <font color="#2c92af">OrderContainer</font>();
<font color="#0000ff">var</font> source = container.Orders.Include(<span style="color: maroon">"OrderSummary"</span>);

<font color="#0000ff">var</font> orders =
	<font color="#0000ff">from</font> o <font color="#0000ff">in</font> source
	<font color="#0000ff">from</font> ol <font color="#0000ff">in</font> o.OrderLines
	<font color="#0000ff">where</font> ol.ItemId == <span style="color: maroon">"32180"</span>
	<font color="#0000ff">select</font> o;</pre>
<p>This query returns the correct set of orders, but the OrderSummary navigation property is not loaded. We called it a bug in EF and worked around it. The workaround involved multiple queries, and was generally a bad idea.</p>
<p>Fortunately, we took the time to revisit the problem. The first thing I did was to use Reflector to find out what that query was actually doing. Here's the equivalent:</p>
<pre><font color="#0000ff">var</font> orders = source
	.SelectMany(o =&gt; o.OrderLines, (o, ol) =&gt; <span style="color: blue">new</span> { order = o, orderLine = ol })
	.Where(result =&gt; result.orderLine.ItemId == <span style="color: maroon">"32180"</span>)
	.Select(result =&gt; result.order);</pre>
<p>It's a round-about way of saying it, but it looks OK. It creates a tuple of orders and order lines, filters that tuple based on the item ID, then selects just the order part of the tuple. If you think about it relationally, this is pretty close to an old-fashioned WHERE join.</p>
<p>Keeping with the explicit syntax, I wrote the query exactly as I wanted it. This is the result:</p>
<pre><font color="#0000ff">var</font> orders = source
	.Where(o =&gt; o.OrderLines
		.Any(ol =&gt; ol.ItemId == <span style="color: maroon">"32180"</span>));</pre>
<p>This reads like the specification. It gets all orders where any order line has the desired item ID.</p>
<p>This version of the code not only selects exactly the orders I want, it also includes the OrderSummary. No longer do I have to do additional queries to fill in the missing details.</p>
<p><strong>Here's my solution</strong><br />
My advice after working through this problem is to skip the linq syntax. Get used to the more explicit extension method syntax. Understand .Where(), .Select(), and .Any(). When you are more explicit with your tools (and I'm not talking profanity here), you have a better chance of getting the behavior you want out of them.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index8e7f.html?cat=19" title="View all posts in C#" rel="category">C#</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="indexba86.html?p=298#respond" title="Comment on Entity Framework query based on properties of related objects">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-296"><a href="index3e8e.html?p=296" rel="bookmark" title="Permanent Link to Problems with the Entity Framework, and how to overcome them">Problems with the Entity Framework, and how to overcome them</a></h3>
				<small>Monday, March 2nd, 2009</small>

				<div class="entry">
					<p>I am not a signatory of the <a href="http://efvote.wufoo.com/forms/ado-net-entity-framework-vote-of-no-confidence/">Entity Framework Vote of No Confidence</a>. Not because I have any confidence in the tool, but rather because my concerns are different. The concerns expressed in the VoNC are:</p>
<ul>
<li>Focus on data over behavior</li>
<li>Lack of lazy loading</li>
<li>Shared canonical model</li>
<li>Lack of persistence ignorance</li>
<li>Excessive merge conflicts</li>
</ul>
<p>These are valid concerns coming mostly from a community that uses ORM tools. I am not an ORM advocate, so some of these concerns mean little to me. In particular, persistence ignorance, while a cornerstone of ORM culture, has been of limited value in my experience. I've never had the need to port a data model unchanged into a different database. The database always imposes its constraints on the domain model. (Or maybe I just don't understand what PI really means.)</p>
<p>My concerns, on the other hand, are born out of trying to use EF on an enterprise project. My team has settled on a way of using it that works for us, so we will continue to use it. The problems that we've had to overcome are:</p>
<ul>
<li>Tight coupling to the database schema</li>
<li>Lack of versioning support</li>
<li>Lack of visibility</li>
<li>Confusion between ownership and association</li>
</ul>
<p><strong>Tight coupling to the database schema</strong><br />
The easiest way to create an entity model is to reverse-engineer it from the database. The tool will create an entity type for each table that you select, and a relationship for each foreign key. It will even turn a two-column associative table into a many-to-many relationship. For simple schemas, this works pretty well.</p>
<p>There are many problems with taking this approach, however. The first is that foreign keys are only properties of tables, not views. The import creates an entity for each selected view, but cannot create relationships. Relationships can be created manually, so this is easily overcome. However this shortcoming encourages the use of tables over views, removing one useful layer of indirection.</p>
<p>We will reverse-engineer up to a point, then switch to views under the covers. Once that switch is made, we no longer refresh the EDMX from the model. This practice retains the layer of abstraction that we gain from views, but doesn't completely defeat the usefulness of the tool.</p>
<p><strong>Lack of versioning support</strong><br />
We are building a service-oriented application. There are problems with SOA that I won't get into right now, but the biggest problem has been breaking changes in the service contract.</p>
<p>Entity Framework adds the [DataContract] attribute to all of the entities. This allows you to return an entity from a WCF service. If Microsoft made it this easy, it must the right thing to do, right?</p>
<p>The problem is that there is just one version of each entity type, and therefore of each service signature. If someone adds a column to a table, the client proxy needs to be regenerated. Every change to the database schema is a breaking change to the clients. And there is no way to keep old versions of the service calls while simultaneously adding new versions. This is painful in development. This would be death to production.</p>
<p>The solution is to ignore the help that Microsoft gives you. Don't use EF entities in WCF service contracts. Yes, this means that you have to write left-hand-right-hand code, but at least it's completely under your control. You choose when to define new data types, and you can version them according to your own needs.</p>
<p><strong>Lack of visibility</strong><br />
We have some talented DBAs on the team. They are the reason that I'm not much of an ORM advocate. I see the job that they do, and I don't want my developers to be responsible for it. They think about the health and design of the data. Every day. If you use an ORM, you either ask your developers to be just as concerned, or you get accidental data access. Frankly, my developers have too much to think about without also caring as deeply about the data as my DBAs do.</p>
<p>So since I lean so heavily upon my DBAs, I want to give them all of the information they need. One thing they ask for is a list of queries that the application will be performing. They need this in order to ensure that the tables are properly indexed. Extracting this information from EF is cumbersome. The best way I've discovered is to run SQL Profiler and start the integration tests.</p>
<p>Another thing they ask for is a list of tables and views that a particular build of the application requires. They need this to coordinate database releases with application releases. We don't bring down the whole datacenter in order to release. Database changes are rolled out on a live system in advance of application changes. They are applied in a way that will not break the previous application. Then, when the database is upgraded, the app servers are individually taken off-line and upgraded. During this process, there is zero down-time. Part of the datacenter is on the previous version, while the other part is on the new version. Entity Framework hides the dependency of code upon schema, and gives us absolutely no help in planning for this dance.</p>
<p><strong>Confusion between ownership and association</strong><br />
I observe five axioms of software behavior. One of them is ownership. An object has exactly one owner. It's a parent-child relationship. If the child is removed from the parent, it is deleted.</p>
<p>Ownership is different from association. An association is just a reference. That reference can be changed without deleting the object.</p>
<p>In a relational database, ownership is manifested as a foreign key that you cannot change. A child is added to a parent when it is inserted, and removed when it is deleted. A one-to-one or one-to-many association is also a foreign key, but you are allowed to change it. A many-to-many association is represented as an associative table.</p>
<p>Entity Framework only has navigation properties. It makes no distinction between ownership and association. In fact, it treats all navigation properties as associations, and does not do the right thing with parent-child relationships. Removing an object from a navigation property does not delete it, even if the parent is supposed to be the owner. Instead, it throws this exception:</p>
<blockquote><p>A relationship is being added or deleted from an AssociationSet '***'. With cardinality constraints, a corresponding '***' must also be added or deleted.</p></blockquote>
<p>You have to delete the child object from the container, not from its owner.</p>
<p>The way you code with objects is different than the way you code with relational databases. Entity Framework tries to hide these differences behind a layer of abstraction, but it fails completely. Not being an ORM user, I don't know the extent to which other frameworks succeed. But when I'm working with a relational database, I prefer to code relationally. It's really not that bad.</p>
<p>So when using Entity Framework in an enterprise environment:</p>
<ul>
<li>Don't completely rely upon reverse-engineering the model.</li>
<li>Don't expose entities through WCF services.</li>
<li>Use SQL Profiler to see what EF is doing.</li>
<li>Know the difference between ownership and association, even if the tool doesn't.</li>
</ul>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="index3e8e.html?p=296#respond" title="Comment on Problems with the Entity Framework, and how to overcome them">No Comments &#187;</a></p>

			</div>

		
		<div class="navigation">
			<div class="alignleft"></div>
			<div class="alignright"></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 17 queries. 0.403 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?cat=39 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:25 GMT -->
</html>
