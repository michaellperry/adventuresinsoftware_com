<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?cat=7&paged=3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:09:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software   &raquo; Databases</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

		
		 		<h2 class="pagetitle">Archive for the &#8216;Databases&#8217; Category</h2>

 	  

		<div class="navigation">
			<div class="alignleft"></div>
			<div class="alignright"><a href="index7d66.html?cat=7&amp;paged=2">Next Entries &raquo;</a></div>
		</div>

				<div class="post">
				<h3 id="post-76"><a href="index04cd.html?p=76" rel="bookmark" title="Permanent Link to Paging in a MySQL Stored Procedure">Paging in a MySQL Stored Procedure</a></h3>
				<small>Friday, January 5th, 2007</small>

				<div class="entry">
					<p>At Handmark, we make on-line services for both cell phones and web browsers. A common need on both platforms is to return search results to the client a page  at a time. The way to accomplish this in MySQL is to use the LIMIT ... OFFSET clause. Unfortunately, this doesn't work so well in a stored procedure.</p>
<p>The parameters of LIMIT ... OFFSET are the number of rows to return, and the number of rows to skip. So if you want to display 25 rows at a time you end your SELECT statement with LIMIT 25 OFFSET 0. When the user clicks the "next" button, you use LIMIT 25 OFFSET 25.</p>
<p>Mobile devices come in many different sizes and form factors. A Windows Mobile Pocket PC has a larger screen than a Blackberry, for example, and can therefore display more results per page without scrolling. We adjust the number of results based on the device type to optimize the user experience.</p>
<p>The combination of these concerns means that the parameters to the LIMIT ... OFFSET clause must be soft. We cannot hardcode them into our stored procedures, nor can we afford to maintain several different procedures with different hardcoded values. But it would seem that the designers of MySQL expect us to do just that, since you cannot use procedure parameters with this clause.</p>
<p><strong>Here's my solution</strong><br />
There are several quirks that I discovered on the road to getting this working correctly. Some of them I am convinced are simply bugs, and will probably be fixed soon. But the pattern that I found to work is to prepare a statement, then call it using user-defined "@" variables. The actual stored procedure parameters won't work.</p>
<pre>DELIMITER $$

CREATE PROCEDURE call_log_by_user_enum_v1(
    IN i_user_id INT,
    IN i_limit INT,
    IN i_offset INT,
    OUT o_count INT )
BEGIN
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
    SET o_count = (SELECT COUNT(1) FROM call_log WHERE user_id = i_user_id);

    PREPARE ps FROM 'SELECT call_date, command
        FROM call_log
        WHERE user_id = ?
        LIMIT ? OFFSET ?';

    SET @v_user_id = i_user_id;
    SET @v_limit = i_limit;
    SET @v_offset = i_offset;
    EXECUTE ps USING @v_user_id, @v_limit, @v_offset;
    DROP PREPARE ps;
END$$

DELIMITER ;</pre>
<p>A recent release has thankfully allowed the limit clause in a prepared statement to accept "?" placeholders. Prior to that release, you had to concatenate the SQL string in a variable (an "@" variable, not a DECLAREd variable). That's one small step toward the right solution, but there are still a couple more to take.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index04cd.html?p=76#comments" title="Comment on Paging in a MySQL Stored Procedure">1 Comment &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-74"><a href="index49a5.html?p=74" rel="bookmark" title="Permanent Link to Unable to call a stored procedure in MySQL">Unable to call a stored procedure in MySQL</a></h3>
				<small>Thursday, December 28th, 2006</small>

				<div class="entry">
					<p>You've created a procedure in MySQL 5. You've granted EXECUTE privileges to your application's user account. But when your application prepares a statement to call that procedure, an exception is thrown. Perhaps it's a NullPointerException deep inside of ConnectorJ. Perhaps the exception claims that the procedure does not exist. Or perhaps you've gotten lucky enough to get the exception that leads you down the right path (Driver requires declaration of procedure to either contain a ''\nbegin'' or ''\n'' to follow argument declaration, or SELECT privilege on mysql.proc to parse column types). Here are the troubleshooting steps that I've gleaned from hours of searching the MySQL forums.</p>
<p>First, open two console windows. In one, log into MySQL as the application user. In the other, log in as root. In your app window, list the databases.</p>
<pre>SHOW DATABASES;</pre>
<p>If your application's database does not appear, then you should go to your root window and grant database privileges.</p>
<pre>USE mydatabase;
GRANT ALL ON mydatabase TO appuser;</pre>
<p>Now go back to the app window. List the databases again to ensure that it appears. Now that it does, go into it.</p>
<pre>USE mydatabase;</pre>
<p>Once you're in, try to view the procedure.</p>
<pre>SHOW CREATE PROCEDURE myproc /G</pre>
<p>One of three things will happen. If you get a message saying "PROCEDURE myproc does not exist" then the app user does not have privileges for it. Go back to the root window and grant them.</p>
<pre>GRANT EXECUTE ON PROCEDURE myproc TO appuser;</pre>
<p>The second thing that might happen is that the procedure will be found, but the body will not be listed. Instead, it will say "Create Procedure: NULL". If so, go back to the root window and take care of that.</p>
<pre>GRANT SELECT ON mysql.proc TO appuser;</pre>
<p>The third thing that could happen is what you want to happen; the body of the procedure will be listed. Now you should be able to call the procedure from your application.</p>
<p><strong>Warnings<br />
</strong>You may be tempted to take a couple of short-cuts to resolve problems like these. Please don't. Shortcuts may cause bigger problems down the road.</p>
<p>The first thing you might try is to use the root account from within your application. This is extremely dangerous. Security comes in layers. While you should use stored procedures and prepared statements to avoid SQL injection attacks, you should also apply the principle of least privilege just in case they occur anyway. Allowing your application to connect as root gives an attacker access to your most valuable resource: your data. But giving each part of the application a separate account with only the privilege that it requires quarantines the bad guy.</p>
<p>The second thing that you might try after hours of research is to set the "noAccessToProcedureBodies" flag in the ConnectorJ connection string. Please avoid this flag, as it circumvents the parameter type checking that the JDBC driver provides for you. This flag causes ConnectorJ to convert all of the parameters to strings, which MySQL will then convert back to the required type.</p>
<p>But by walking through the problem step-by-step, these short-cuts should not be necessary.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index49a5.html?p=74#respond" title="Comment on Unable to call a stored procedure in MySQL">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-65"><a href="index7665.html?p=65" rel="bookmark" title="Permanent Link to MySQL LAST_INSERT_ID() is Broken, Too">MySQL LAST_INSERT_ID() is Broken, Too</a></h3>
				<small>Monday, December 11th, 2006</small>

				<div class="entry">
					<p>Stored procedures are finally supported in MySQL 5. This makes for better encapsulation of the database, and gives us hooks for logging and optimization. However, it also means that we have to find our way through a new set of gotchas.</p>
<p>We've defined a stored procedure that inserts data into three separate tables. The ID of the first table is used as a foriegn key in the second, and the ID of the second table is used in the third. This revealed a problem with the LAST_INSERT_ID() function. Here's the code:</p>
<pre>    INSERT queue_user (queue_user_name) VALUES (publisher);
    SET publisher_id = LAST_INSERT_ID();
    INSERT queue_entry (publisher_queue_user_id)
    VALUES (publisher_id);
    SET entry_id = LAST_INSERT_ID();
    INSERT queue_data (queue_entry_id, request)
        VALUES (entry_id, data);</pre>
<p>The queue_user row was inserted correctly, and returned an ID of 7. The queue_entry row was correctly associated to publisher ID 7 with the new entry ID 5. However, the entry_id variable was set by LAST_INSERT_ID() to 7, not 5. This caused the queue_data row to be associated with the wrong entry ID. Apparently, within a stored procedure LAST_INSERT_ID() returns the ID generated by the first INSERT statement, not the last one.</p>
<p><strong>Here's my solution</strong><br />
If you wrap the first insert in a transaction, then the problem is solved. This, of course, violates the atomic intent of the transaction, but in our case that wasn't an issue. Here's the "fixed" code:</p>
<pre>    START TRANSACTION;
INSERT queue_user (queue_user_name) VALUES (publisher);
    SET publisher_id = LAST_INSERT_ID();
    COMMIT;
INSERT queue_entry (publisher_queue_user_id)
        VALUES (publisher_id);
    SET entry_id = LAST_INSERT_ID();
  INSERT queue_data (queue_entry_id, request)
        VALUES (entry_id, data);</pre>
<p>I only hope they fix this soon.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index7665.html?p=65#respond" title="Comment on MySQL LAST_INSERT_ID() is Broken, Too">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-64"><a href="index8cd4.html?p=64" rel="bookmark" title="Permanent Link to MySQL row_count() is Broken">MySQL row_count() is Broken</a></h3>
				<small>Wednesday, December 6th, 2006</small>

				<div class="entry">
					<p>Like most other SQL-based relational database engines, MySQL provides a mechanism to get the number of rows affected by the last operation. In MySQL, it is the row_count() function. This function is useful for implementing a number of patterns, including the "update/insert" pattern (or "upsert" as it is sometimes known).</p>
<p>It is often necessary to have one procedure that inserts a row if it doesn't yet exist, or update it if it does. There are several ways to accomplish this. You could SELECT first to determine whether it exists, then UPDATE or INSERT based on the result. However, this is not the most efficient mechanism, and may even result in consistency problems or deadlocking depending upon the agressiveness of the RDBMS locking mechanism. A faster and safer approach is the update/insert pattern.</p>
<p>In an update/insert procedure, you attempt an UPDATE statement to modify the desired records. Then you check row_count() to see if any rows were affected. If the records did not previously exist, row_count() would return 0. In that case, you would INSERT.</p>
<p>Unfortunately, the MySQL implementation of row_count() does not support this pattern. Whereas most RDBMS engines count the number of rows matched, MySQL does not count records that haven't actually changed during an UPDATE statement.</p>
<p>Try this experiment. Create a table:</p>
<pre>mysql&gt; create table rcbroke
(rcbroke_id int auto_increment not null primary key,
val int not null default 0,
create_date datetime not null,
modify_date timestamp not null);
Query OK, 0 rows affected (0.08 sec)</pre>
<p>Insert a couple of rows.</p>
<pre>mysql&gt; insert into rcbroke (create_date) values (NOW());
Query OK, 1 row affected (0.03 sec)

mysql&gt; insert into rcbroke (create_date) values (NOW());
Query OK, 1 row affected (0.03 sec)

mysql&gt; select * from rcbroke;
+------------+-----+---------------------+---------------------+
| rcbroke_id | val | create_date         | modify_date         |
+------------+-----+---------------------+---------------------+
|          1 |   0 | 2006-12-06 10:27:27 | 2006-12-06 10:27:27 |
|          2 |   0 | 2006-12-06 10:27:30 | 2006-12-06 10:27:30 |
+------------+-----+---------------------+---------------------+
2 rows in set (0.00 sec)</pre>
<p>Now update one of those rows, setting the value that it already contains. Select row_count() to see if the matching row is counted.</p>
<pre>mysql&gt; update rcbroke set val=0 where rcbroke_id=1; select row_count();
Query OK, 0 rows affected (0.00 sec) Rows matched: 1  Changed: 0  Warnings: 0

+-------------+
| row_count() |
+-------------+
|           0 |
+-------------+
1 row in set (0.00 sec)</pre>
<p>Notice that MySQL reports one row matched, but no rows changed. For the update/insert pattern (and most other useful SQL patterns), we are most interested in the rows matched, but row_count() returns the number of rows changed.</p>
<p>But our test table contains a Timestamp column, which is automatically updated when a row changes. Surely, MySQL has set the timestamp for us. Sorry, but no...</p>
<pre>mysql&gt; select * from rcbroke;
+------------+-----+---------------------+---------------------+
| rcbroke_id | val | create_date         | modify_date         |
+------------+-----+---------------------+---------------------+
|          1 |   0 | 2006-12-06 10:27:27 | 2006-12-06 10:27:27 |
|          2 |   0 | 2006-12-06 10:27:30 | 2006-12-06 10:27:30 |
+------------+-----+---------------------+---------------------+
2 rows in set (0.00 sec)</pre>
<p>If we change the value of a column, then row_count() works correctly.</p>
<pre>mysql&gt; update rcbroke set val=1 where rcbroke_id=1; select row_count();
Query OK, 1 row affected (0.02 sec) Rows matched: 1  Changed: 1  Warnings: 0

+-------------+
| row_count() |
+-------------+
|           1 |
+-------------+
1 row in set (0.00 sec)</pre>
<p>And the modify_date is automatically changed for us.</p>
<pre>mysql&gt; select * from rcbroke;
+------------+-----+---------------------+---------------------+
| rcbroke_id | val | create_date         | modify_date         |
+------------+-----+---------------------+---------------------+
|          1 |   1 | 2006-12-06 10:27:27 | 2006-12-06 10:28:35 |
|          2 |   0 | 2006-12-06 10:27:30 | 2006-12-06 10:27:30 |
+------------+-----+---------------------+---------------------+
2 rows in set (0.00 sec)</pre>
<p><strong>Here's my solution</strong><br />
The Timestamp column is our saving grace, although it may as well be a regular Datetime column for all it's worth. If we explicitly update modify_date to the current time, MySQL will count that row as changed. There is still a small chance that we might call the UPDATE twice within the same Timestamp granularity, but that chance is small enough to live with in most scenarios.</p>
<pre>mysql&gt; update rcbroke set val=1, modify_date=NOW() where rcbroke_id=1; select row_count();
Query OK, 1 row affected (0.02 sec) Rows matched: 1  Changed: 1  Warnings: 0

+-------------+
| row_count() |
+-------------+
|           1 |
+-------------+

1 row in set (0.00 sec)mysql&gt; select * from rcbroke;
+------------+-----+---------------------+---------------------+
| rcbroke_id | val | create_date         | modify_date         |
+------------+-----+---------------------+---------------------+
|          1 |   1 | 2006-12-06 10:27:27 | 2006-12-06 10:29:12 |
|          2 |   0 | 2006-12-06 10:27:30 | 2006-12-06 10:27:30 |
+------------+-----+---------------------+---------------------+
2 rows in set (0.00 sec)</pre>
<p>This is the closest we can get to correct behavior of MySQL's row_count(). Even though it may return the correct "number of rows affected" by one interpretation of the SQL spec, I see no valid use for the function as defined.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index8cd4.html?p=64#comments" title="Comment on MySQL row_count() is Broken">4 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-61"><a href="index094d.html?p=61" rel="bookmark" title="Permanent Link to The Work Queue Pattern">The Work Queue Pattern</a></h3>
				<small>Thursday, November 30th, 2006</small>

				<div class="entry">
					<p>In each of the Enterprise systems I've worked on, we've had background processes to massage data. They could be report aggregators, media renderers, or message processors. The features that they have in common are:</p>
<ul>
<li>Work items may not be lost.</li>
<li>Work must not be interrupted.</li>
<li>Work items are independent of one-another.</li>
<li>Work items may not be repeated.</li>
</ul>
<p>The pattern that best implements these features is a work queue. A work queue has a publish-subscribe queue of work items serviced by redundant processors. The durability of the queue ensures that work items are not lost. Processors are allowed to work in parallel since work items are independent. That redundancy ensures that work continues even if a processor goes down. And proper use of the queue ensures that no two processors get the same work item.</p>
<p>This problem could be solved with JMS or MSMQ, but in my experience these solutions imposed undesirable requirements. JMS marries your code to J2EE, while MSMQ requires a Microsoft server environment. I prefer to keep my options open. Fortunately, it is not difficult to implement a work queue directly in the database of your choice.</p>
<p><span style="font-weight: bold">Here's my solution</span><br />
First you have to define a work queue table. In addition to columns that describe the work to be done, this table must also have a column that identifies the processor that is performing the work. A foreign key to a processor table works well. The processor table has a primary key (the processor ID) and the name of the machine running the process.</p>
<p>When a processor is ready to perform some work, it must query the work queue table twice. First it looks for any available work item, and then it ensures that no other processor has claimed that work item. This two-step query is the most effective way I've found to detect and resolve collisions let me explain in more detail.</p>
<p>The first query is performed with the transaction isolation level set to "read uncommitted". This allows the query to see any work queue items that are currently being claimed. The result of this query is the work item ID that the processor will try to claim for itself.</p>
<pre>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SET @id = (SELECT WorkItemID FROM WorkQueue WHERE ProcessorID=NULL);</pre>
<p>The second query is performed with the standard transaction isolation level of "read committed". It both locks the record and verifies that the work has not yet been claimed.</p>
<pre>SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT ProcessorID FROM WorkQueue (UPDATE) WHERE WorkItemID=@id;</pre>
<p>If the row is found and the processor ID comes back NULL, then you know that the work has not yet been claimed. You may now update the ProcessorID and commit the transaction.</p>
<p>However, if the row is not found, then the work has already been completed and deleted from the queue. If the processor ID is not NULL, then a collision has occurred. Another processor is already busy working on that item. So you just commit your transaction and try again.</p>
<p>It took several days of trial-and-error to get the pattern right the first time. But now that I have it, it is easy to create a work queue without the overhead of JMS or MSMQ.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a>,  <a href="indexb31a.html?cat=1" title="View all posts in Uncategorized" rel="category">Uncategorized</a> |   <a href="index094d.html?p=61#respond" title="Comment on The Work Queue Pattern">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-54"><a href="indexcc0f.html?p=54" rel="bookmark" title="Permanent Link to Data Aggregation for Reporting">Data Aggregation for Reporting</a></h3>
				<small>Thursday, November 16th, 2006</small>

				<div class="entry">
					<p>A good way to design an enterprise system is to separate reporting from transaction processing. This lets the two processes run independently without interfering with one another. It also allows the database designer to optimize each component for its particular use.</p>
<p>When these two concerns are separated, the data must be moved from the transaction processing side of the business into the reporting side. In the process, data should be aggregated to keep storage requirements low and to make reports run quickly. There are two ways of accomplishing this: real-time and agent-driven.</p>
<p>A real-time aggregation solution updates the aggregate records as transactions are processed. For example, a book sale transaction might update a record that keeps track of the number of books sold by author. The author's record is either inserted or updated during the book sale transaction.</p>
<p>An agent-based aggregation solution, on the other hand, calculates an aggregate in the background after many transactions. For example, a query might run once a day to insert a count of books sold by author for that day.</p>
<p>There are advantages and disadvantages to each technique. Real-time updates provide the most accurate and useful reports, but they can interfere with the main business of the system. Agent-based aggregates don't block current transactions, but they can generate large batches of data that can be hard to move. Which method is right for a given situation?</p>
<p><strong>Here's my solution</strong><br />
The best rule-of-thumb that I've found is to use the granularity as an indicator. Some aggregates are extremely coarse-grained, pulling all of the data into a small number of categories. Others are more fine, rolling up to a large number of very specific line items. Coarse-grained aggregates should be updated by a background agent, while fine-grained aggregates should be summed in real-time.</p>
<p>Coarse-grained aggregates create sums for a small set of keys. Usually, this key set is fixed, as in the categories of books or the locations of book stores. If the key set is small, then a real-time rollup would experience a lot of contention. The same small number rows would be updated many times by many concurrent threads. However, a delayed agent rollup would calculate each of those rows once by a single process. That makes the agent-based approach ideal.</p>
<p>Fine-grained aggregates create sums for a large set of keys. This key set grows over time because is based on the data itself. It might include individual books, authors, or customers. If the key set is large, a background agent would produce a large set of rows all at once. Large row sets cause problems with replication and blocking. But a real-time update would insert or modify one row at a time, leaving plenty of room for replication or blocking operations to interweave. Furthermore, if a user ID is part of the key set, collisions are extremely unlikely. User activity tends to be serialized, since one person can't usually do two things at once with the same application.</p>
<p>Separating reporting from transaction processing is an important part of an enterprise system. Consider the size of the aggregate key set when choosing how to go about moving the data.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="indexcc0f.html?p=54#comments" title="Comment on Data Aggregation for Reporting">1 Comment &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-44"><a href="index49b1.html?p=44" rel="bookmark" title="Permanent Link to Share the Authority">Share the Authority</a></h3>
				<small>Monday, November 13th, 2006</small>

				<div class="entry">
					<p>In the typical database application, identity is created by an auto-increment key. Every insert to a table allocates a new number that uniquely identifies that new row. This number is used within the business logic of the application to return to that row in the future, and as foreign keys in other tables. It's a solution that works quite well.</p>
<p>That is, until it stops working.</p>
<p>One problem with this approach is that it fails to scale out. The one database server that allocates IDs becomes the one and only authority on identity. In order to create a new identity, any web server, any app server, and any integrated database server must abdicate to the one keeper of the auto-increment key. This one server becomes the bottleneck for rows in the table.</p>
<p>Database vendors have created ingenious solutions to this problem. It is possible with today's technology to connect a cluster of homogeneous servers and have them act as one big database. However, this solution is costly go build, tricky to configure, and difficult to maintain.</p>
<p>The problem (which we see time and again) is that our model has written a check that our technology can't cash. When we design our systems relationally, we assume that we can always go to one big table and that it will contain all of the rows that we need. If the customer in my system, she can be found in the one and only customer table. Since there is no other table that holds customers, the monotonically increasing ID is all I need to find her.</p>
<p>That assumption builds in a bottleneck that we later try to engineer out. In creating a cluster, we acknowledge that it can't <em>really</em> be one big table, but we still have to make it look like one. The relational model demands it.</p>
<p>But if we take a step back, we discover that we don't really need all of the promises that the relational model makes. Instead, we can live with a smaller set of promises that the technology can actually deliver.</p>
<p><strong>Here's my solution </strong><br />
Distribute data across different databases. These databases agree in schema, but differ in data. Identify rows not just by their auto-incremented ID numbers, but by a compound key that also includes a database ID. Yes, go ahead and store that database ID in a separate column -- make that the first column -- of every table.</p>
<p>Use a connection factory in your applications that recognizes this database ID. Based on that ID, create a connection to the appropriate database. Give your operations team control over that configuration so that they can control the allocation of IDs to databases. Give them tools to move data from one database to another in order to split or merge databases as demand requires.</p>
<p>Joining across databases is often impossible and never recommended. So keep all detail rows in the same database as their master. Choose your pivot points wisely to avoid the need for cross-database joining. Database allocation should be coarse, such as keeping all records for one client or account in the same database. But when you need finer grained control, choose a relationship that you exploit only through presentation-tier linking or middle-tier business logic, never through data-tier joins. You can serve a link on a web page that leads to another database, but don't mix data from two databases on one page.</p>
<p>And always allow for many database IDs to refer to one physical database server. This will be necessary when underutilized databases are merged. It will also give your operations team the ability to plan ahead for future splits should they become necessary.</p>
<p>One server or cluster may be all you ever need, but by sharing the authority you give yourself options. The operations team may thank you in years to come.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="index49b1.html?p=44#respond" title="Comment on Share the Authority">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-4"><a href="index5c7e.html?p=4" rel="bookmark" title="Permanent Link to Not for Win2K">Not for Win2K</a></h3>
				<small>Monday, June 26th, 2006</small>

				<div class="entry">
					<p>If you go to the SQL Everywhere download page, you will see that the system requirements for the CTP are 2003 or XP. We have an install base that is still on 2000, so that pretty much kills it for us. Perhaps these are just the CTP requirements, and the final release will support 2000. One can hope.</p>
<p>Still, I'm  intrigued by Microsoft's vision of using merge replication as an occasionally-connected client solution. I suspect that the admin chores of setting up merge replication will be tedious. I also expect that schema versioning will be an issue. These are the things that have killed replication as a feasible solution for us in the past. I'll continue my investigation and see if they've gotten better at it.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index5c7e.html?p=4#respond" title="Comment on Not for Win2K">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-3"><a href="index2207.html?p=3" rel="bookmark" title="Permanent Link to SQL Everywhere">SQL Everywhere</a></h3>
				<small>Monday, June 26th, 2006</small>

				<div class="entry">
					<p>I am an Enterprise Software Architect working at Radiant Systems in Dallas. We create products for the hospitality industry (restaurants). Some of these products have in-store components that are occasionally connected to our datacenter.</p>
<p>Microsoft has recently repositioned SQL 2005 Mobile Edition for desktop applications. They are branding it SQL 2005 Everywhere Edition (<br />
<a href="http://www.microsoft.com/sql/ctp_sqleverywhere.mspx">http://www.microsoft.com/sql/ctp_sqleverywhere.mspx</a>). We are evaluating the feasibility of using SQL Everywhere instead of SQL Express for our in-store software.</p>
<p>SQL Everywhere runs in-process with the client application. It is not installed as a service, as SQL Express is. That means that it cannot serve multiple applications from the same database, only its host. That's OK for our needs, since our host application is already a service. Our clients are small DLLs that make application-specific requests from the service.</p>
<p>I'll let you know what our research reveals, and if we decide to switch from Express to Everywhere.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index2207.html?p=3#respond" title="Comment on SQL Everywhere">No Comments &#187;</a></p>

			</div>

		
		<div class="navigation">
			<div class="alignleft"></div>
			<div class="alignright"><a href="index7d66.html?cat=7&amp;paged=2">Next Entries &raquo;</a></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 17 queries. 0.412 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?cat=7&paged=3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:09:49 GMT -->
</html>
