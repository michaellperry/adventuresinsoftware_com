<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?m=200909 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:39:17 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software   &raquo; 2009&raquo; September</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

		
		 		<h2 class="pagetitle">Archive for September, 2009</h2>

		

		<div class="navigation">
			<div class="alignleft"><a href="index4465.html?m=200909&amp;paged=2">&laquo; Previous Entries</a></div>
			<div class="alignright"></div>
		</div>

				<div class="post">
				<h3 id="post-443"><a href="indexe0b1.html?p=443" rel="bookmark" title="Permanent Link to Table as queue">Table as queue</a></h3>
				<small>Wednesday, September 30th, 2009</small>

				<div class="entry">
					<p>To play along at home, please download the <a href="wp-content/uploads/2009/09/queues.mp3" title="queues.sql">script</a> for SQL Server 2005. It may work on earlier versions, but I haven't tried it.</p>
<p>Yesterday I said that <a href="index6c6e.html?p=442">the data is the queue</a>. It is a mistake to separate the processing of data from the data itself. I proposed an architecture in which there is no workflow orchestration, there are only autonomous worker processes. These processes pick up work based on attributes of the objects on which they act, not based on any external queue.</p>
<p>There are a small number of database patterns that make this possible. One that I often use is Table as Queue.</p>
<p><strong>Setup a test environment</strong><br />
I created a test database called "Queues" to test this pattern. You can find the script attached. As it is now, this script is incorrect. We will correct it as we go along.</p>
<p>The database has two tables. The Order table holds orders that we want to process. If the order hasn't been processed, it has no confirmation number. If it has, it does. The Log table holds a log of all the steps the order processor has gone through. This will help us see how well we are doing.</p>
<p>There are three stored procedures that we'll use. The InsertLoop stored procedure generates some test data. Run this one first. The ProcessLoop stored procedure simulates the ERP process. You'll want to open two query windows and enter "EXEC ProcessLoop" in both of them. Finally, the ViewLog procedure lets us see how we did.</p>
<p><strong>Anatomy of a queue procedure</strong><br />
The ProcessLoop stored procedure begins by selecting one order to process. It returns only the ID of this order.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order]
	WHERE ConfirmationNumber IS NULL)</pre>
<p>This ID has to be the primary key of the table. This is necessary for correct queuing behavior. If it is not the primary key, we will not get the correct locks later.</p>
<p>To process the order, other details about that record will be required. These should be fetched separately by the returned ID. Do not try to combine these steps.</p>
<p><strong>Default isolation level</strong><br />
Right now, the ProcessLoop stored procedure uses the default transaction isolation level (read committed). It starts a transaction, gets an order from the queue, processes it, and updates the confirmation number.</p>
<p>Hit F5 on both of your ProcessLoop query windows. While this is running, run ViewLog. You'll see something like this:</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">89</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 12:51:18.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:18.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
</table>
<p>Both of the SPIDs are processing all of the orders. This is clearly not what we want. We want only one SPID to process each order.</p>
<p><strong>Higher isolation level</strong><br />
The other process is able to sneak in between the SELECT and the UPDATE and perform an UPDATE of its own. We want to ensure that the row that the process UPDATEs is the same version it SELECTed. The way to do this is to raise the isolation level to REPEATABLE READ. As the name implies, it ensures that two SELECTs within the same transaction will read the same data. What it also means is that an UPDATE in the same transaction will update the same version of the row. No intermediate UPDATEs will be allowed.</p>
<p>Make the following change to the ProcessLoop procedure:</p>
<pre>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ</pre>
<p>Then start the two ProcessLoops again. Before long you will get the error "Transaction (Process ID 53) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction." The other process will still be running.</p>
<p>Kill the remaining process. Close the window so that you can commit the transactions that got left open. Then open a new window and type "EXEC ProcessLoop" again to prepare for the next step.</p>
<p>If you look at the log, you'll see only one of the SPIDs represented. The logs from the other one were rolled back with its transaction.</p>
<p>What happened is that both SPIDs SELECTed the same record. The first one UPDATEd it, which prevented the second from doing so. When it tried to UPDATE, SQL recognized the deadlock and rolled it back.</p>
<p><strong>Update lock</strong><br />
What we want to do is lock the record so that the first one to SELECT it is the one to process it. We'll do this by escalating our read lock to an update lock.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] <strong>WITH (UPDLOCK)</strong>
	WHERE ConfirmationNumber IS NULL)</pre>
<p>Now run the two processes and see what happens.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">138</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 14:05:26.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.377</td>
</tr>
</table>
<p>At first glance this looks good. Each order is processed by just one SPID. But look closely at the times. The two processes are taking turns. Each one enters SELECT, but then waits for the other one to commit its transaction before SELECT returns.</p>
<p>Since we've requested an update lock, the higher transaction isolation level makes no difference. We can turn it back down to the default.</p>
<p><strong>Read past</strong><br />
We want each process to skip over locked rows. We do this by specifying the READPAST query hint.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] WITH (UPDLOCK, <strong>READPAST</strong>)
	WHERE ConfirmationNumber IS NULL)</pre>
<p>With this hint in place, we get some good behavior.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="39" height="20">583</td>
<td class="xl65" style="width: 66pt" width="88">Processing</td>
<td class="xl65" style="width: 31pt" width="41">53</td>
<td class="xl65" style="width: 132pt" width="176">2009-09-29 14:37:21.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:22.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
</table>
<p>Now the two processes are running concurrently. Each order is handled by only one process. There are no deadlocks.</p>
<p>With this pattern, the data itself can be used as a queue. But you have to remember the details:</p>
<ul>
<li>SELECT TOP 1 just the primary key of the queue table.</li>
<li>Use both the UPDLOCK and READPAST query hints on the SELECT.</li>
<li>Fetch additional information by ID in a separate query.</li>
<li>After operating on the data, update the record to exclude it from the original WHERE clause.</li>
<li>Perform both the SELECT and the UPDATE within the same transaction.</li>
</ul>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="indexe0b1.html?p=443#respond" title="Comment on Table as queue">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-442"><a href="index6c6e.html?p=442" rel="bookmark" title="Permanent Link to The data is the queue">The data is the queue</a></h3>
				<small>Tuesday, September 29th, 2009</small>

				<div class="entry">
					<p>Our eCommerce system uses BizTalk to process orders. The BizTalk orchestration keeps track of the status of the order. Queues keep track of communications between BizTalk and external systems, like the ERP. The database is updated at all points in the process so the web site reflects the current order status.</p>
<p>This system is fragile.</p>
<p><strong>Problem 1: Diagnostics are scattered</strong><br />When something goes wrong, there are different ways of observing the system. The customer observes it from the web. They call support to report a problem. Support looks at the system in the Business Activity Monitor (BAM). They call ops. Ops observes the system through Health and Activity Tracking (HAT). If an activity is waiting on the receipt of a message, they will then inspect the appropriate queue. Each of these places holds part of the story.</p>
<p><strong>Problem 2: Things get out of sync</strong><br />In order to fix a problem, ops needs to take action at some level. They might cancel an orchestration. They might delete a message from a queue. They might manually enter an order into the ERP. When they do, the other parts of the system don't know about the change.</p>
<p><strong>Problem 3: Blocking</strong><br />One process is querying by status; another is updating it. One process is working on a request; another needs to skip it and go to the next. The workflow problem seems to attract blocking behaviors.</p>
<p><strong>Problem 4: Distributed transactions</strong><br />When the orchestration moves from one step to another, it needs to update the order status. Before it can wait on the receive queue, it must push to the send queue. It would be disastrous to perform one of these operations without also performing the other. So the BizTalk message box, the order database, and the outgoing and incoming message queues must be accessed within the same transaction. This brings the Distributed Transaction Coordinator into the picture, increasing fragility and exacerbating blocking behaviors.</p>
<p><strong>Here's my solution</strong><br />There is no need to manage workflow separate from data. This is the fundamental flaw in all workflow systems: BizTalk, WF, MSMQ, Service Broker, just to name a few. They all have their own data storage separate from the subject of the workflow.</p>
<p>If we relied upon the Order table instead of using BizTalk and external queues, we would have a more consistent system. We could diagnose the entire workflow from the database. Having one shared system of record, services would never get out of sync. Certain patterns could be used to eliminate unnecessary blocking. And all transactions would be local.</p>
<p>Broken down in this way, the system no longer has an overarching orchestration. You cannot open a designer and see the workflow. Instead, it has a number of autonomous processes that each move a unit of work further along the pipeline. Each process does its work in the same database.</p>
<p>There is one cardinal rule that makes this possible. <strong>The action that a process performs must also remove it from its queue.</strong></p>
<p>A process runs a query to get a work item. It then performs some action on that work item. The outcome of that action is going to be a single database command. That command, whatever it is, must render the work item ineligible for the query.</p>
<p>It is tempting to perform two database commands in the same transaction: record the results of the action and update the work item status. Avoid this pattern. This allows work items to become out of sync. Instead, design one database command that both records the result and disqualifies the work item from the query.</p>
<p><strong>Confirmation number</strong><br />Let's look at one unit of the order processing orchestration. Take the part of the system that submits the order to the ERP system. This process sends an order to a web service, and receives a confirmation number. So what if we designed this process to use the following query?</p>
<pre>SELECT TOP 1 OrderId, OrderDetails FROM [Order] WHERE ConfirmationNumber IS NULL</pre>
<p>And then recording the results of the action was:</p>
<pre>UPDATE [Order] SET ConfirmationNumber ? WHERE OrderId = ?</pre>
<p>This single UPDATE statement disqualifies the order from the SELECT statement. That means that the process will move the unit of work forward, but it can never be out of sync.</p>
<p>Unfortunately, this SELECT ... UPDATE pattern is prone to blocking. We'll look at some patterns that satisfy this cardinal rule without blocking in future posts.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="index6c6e.html?p=442#respond" title="Comment on The data is the queue">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-441"><a href="indexdf01.html?p=441" rel="bookmark" title="Permanent Link to Survey Sez">Survey Sez</a></h3>
				<small>Monday, September 28th, 2009</small>

				<div class="entry">
					<p>We just did a review session in Q.E.D. Hour. For our review, we divided the group into two teams and played a game of Survey Sez.</p>
<p>I searched in vain for a PowerPoint version of the game that met my requirements. Unfortunately, while the sub culture of PowerPoint game developers has produces several versions of the popular TV show, none of them worked the way I wanted them to. So I wrote my own using a tool better suited to the problem: WPF.</p>
<p>Survey Sez iz best played using a wireless number pad. You press the numbers 1-9 to reveal answers. And you press Enter and Backspace to navigate through the questions. The other keys on the number pad will eventually control other game options, like incorrect answers, bonus rounds, and game winning animation.</p>
<p>I posted the source code as-iz on <a href="http://surveysez.codeplex.com/">CodePlex</a>. Future versions will look better and include more game features. Eventually, I may even add some social networking aspect, like Twitter integration. After all, every system evolves until into a Twitter client.</p>
<p>If you would like to contribute, please post a comment. We'll talk about what you can work on.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index6c5d.html?cat=18" title="View all posts in Fun" rel="category">Fun</a> |   <a href="indexdf01.html?p=441#respond" title="Comment on Survey Sez">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-440"><a href="indexe982.html?p=440" rel="bookmark" title="Permanent Link to Homework assignment: Fix the Socket API">Homework assignment: Fix the Socket API</a></h3>
				<small>Friday, September 25th, 2009</small>

				<div class="entry">
					<p>Your task is to fix the .NET Socket API. This is as unhelpful as an API gets. There are several rules that a user of a Socket must follow. Create an API that proves that they are following all of the rules.
<p>Here is the relevant part of the existing unhelpful API:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Socket : IDisposable
{
    <span style="color: blue">public</span> Socket(SocketInformation socketInformation);
    <span style="color: blue">public</span> Socket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType);

    <span style="color: blue">public</span> Socket Accept();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Bind(EndPoint localEP);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(EndPoint remoteEP);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Connect(<span style="color: blue">string</span> host, <span style="color: blue">int</span> port);
    <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose();
    <span style="color: blue">public</span> <span style="color: blue">void</span> Listen(<span style="color: blue">int</span> backlog);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Receive(<span style="color: blue">byte</span>[] buffer);
    <span style="color: blue">public</span> <span style="color: blue">int</span> Send(<span style="color: blue">byte</span>[] buffer);
}</pre>
<p>Here are the rules as documented in MSDN: </p>
<ul>
<li>You cannot use a Socket returned from Accept to accept any additional connections from the connection queue.
<li>You cannot call Accept, Bind, Connect, Listen, Receive, or Send if the socket has been closed.
<li>You must call Bind before you can call the Listen method.
<li>You must call Listen before calling Accept.
<li>Connect(string host, int port) can only be called if addressFamily is either InterNetwork or InterNetworkV6.
<li>Connect cannot be called if Listen has been called.
<li>You have to either call Connect or Accept before Sending and Receiving data.
<li>If the socket has been previously disconnected, then you cannot use Connect to restore the connection.</li>
</ul>
<p>You may use as the basis of your proof the concepts that were discussed in previous Q.E.D. articles, including:</p>
<ul>
<li><a href="index0ed6.html?p=410">Math 101 for developers</a></li>
<li><a href="indexd519.html?p=415">Proving prerequisites</a></li>
<li><a href="index5750.html?p=416">The constructor: the strongest of all methods</a></li>
<li><a href="indexedce.html?p=429">Closure</a></li>
<li><a href="indexecc4.html?p=432">Proof based on imperative programming</a></li>
<li><a href="indexc1f6.html?p=436">Fixing an unhelpful API</a></li>
</ul>
<p>Please post responses in the comments, email them to <a href="mailto:mperry@adventuresinsoftware.com">mperry@adventuresinsoftware.com</a>, or post links on your own blog. I will share my solution next week.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb31a.html?cat=1" title="View all posts in Uncategorized" rel="category">Uncategorized</a> |   <a href="indexe982.html?p=440#respond" title="Comment on Homework assignment: Fix the Socket API">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-439"><a href="indexfcc0.html?p=439" rel="bookmark" title="Permanent Link to Relaxed locking on thread-safe cache">Relaxed locking on thread-safe cache</a></h3>
				<small>Friday, September 18th, 2009</small>

				<div class="entry">
					<p>In a <a href="index14c7.html?p=437">prior post</a>, I showed how callbacks can be used to prove prerequisites and thread-safety. The example was a cache. But the solution left the cache too constraining. While it was correct, it was too tightly locked. All users of the class will line up behind one another, whether they are after the same data or not.</p>
<p>To resolve this problem, let's move the lock. Instead of locking on the cache while fetching the value, let's lock on the key. Two clients accessing the cache with the same key will line up, but clients with different keys will not.</p>
<p>But we can't lock on the key itself. We need to lock on something with identity. The identity of the key is not important. A client can create a new instance of the key having the same value, and that should qualify as the same key. So we have to look elsewhere.</p>
<p>Fortunately, the value of the key is used to find an object in the dictionary. That object <em>does</em> have identity. So we move the lock there.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CachedObject&lt;TValue&gt;
{
    <span style="color: blue">private</span> TValue _value;
    <span style="color: blue">private</span> <span style="color: blue">bool</span> _fetched = <span style="color: maroon">false</span>;
    <span style="color: blue">public</span> DateTime DateCached { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

    <span style="color: blue">public</span> CachedObject(DateTime dateCached)
    {
        DateCached = dateCached;
    }

    <span style="color: blue">public</span> TValue Value
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _value; }
        <span style="color: blue">set</span> { _value = value; _fetched = <span style="color: maroon">true</span>; }
    }

    <span style="color: blue">public</span> <span style="color: blue">bool</span> Fetched
    {
        <span style="color: blue">get</span> { <span style="color: blue">return</span> _fetched; }
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key, Func&lt;TKey, TValue&gt; fetch)
    {
        CachedObject&lt;TValue&gt; found;

        <span style="color: blue">lock</span> (_store)
        {
            <span style="color: green">// If the object is not in the cache, or it is expired,</span>
            <span style="color: green">// fetch it and add it to the cache.</span>
            DateTime now = DateTime.Now;
            <span style="color: blue">if</span> (_store.TryGetValue(key, <span style="color: blue">out</span> found) &amp;&amp;
                found.DateCached + _expiry &lt; now)
            {
                <span style="color: blue">return</span> found.Value;
            }

            found = <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(now);
            _store.Add(key, found);
        }

        <span style="color: blue">lock</span> (found)
        {
            <span style="color: blue">if</span> (!found.Fetched)
                found.Value = fetch(key);
            <span style="color: blue">return</span> found.Value;
        }
    }
}</pre>
<p>The Get method locks first on the cache. This protects the data structure, and ensures that we get just one instance of CachedObject. Once it has that, it locks on the found CachedObject so that clients after the same key line up.</p>
<p>Inside the lock, it checks to see whether the value has already been fetched. If not, this thread is the first in line, so it fetches the value. But if it <em>has</em> already been fetched, then the thread was not the first in line and can just use the fetched object.</p>
<p>The above is not a formal proof, and has many logical holes. Hopefully we'll have time to shore it up, and possibly find bugs in the code along the way. This is the kind of code that definitely needs to be proven. Sure, unit testing can give us some confidence, but no amount of unit testing can verify that this code is completely thread safe.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="indexfcc0.html?p=439#respond" title="Comment on Relaxed locking on thread-safe cache">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-438"><a href="index9ed5.html?p=438" rel="bookmark" title="Permanent Link to Continuous testing does not require static analysis">Continuous testing does not require static analysis</a></h3>
				<small>Thursday, September 17th, 2009</small>

				<div class="entry">
					<p>Ben Rady is the author of Infinitest, a continuous testing tool. This is an Eclipse or IntelliJ plug-in for Java that runs unit tests as you edit code. The key differentiator of <a href="http://www.benrady.com/2009/04/comparing-infinitest-and-junitmax.html">Infinitest over other continuous testing plug-ins</a> is that it runs only the unit tests that need to be run.</p>
<p>Ben describes how he accomplishes this feat. He uses static analysis of both the test and the code under test to determine whether tests need to run. Unfortunately, he's doing more work than he needs to. Continuous testing does not require static analysis.</p>
<p><strong>Update Controls</strong><br />I moderate an open source project called Update Controls for .NET. This project does data binding for WPF, Winforms, and Silverlight. It has absolutely nothing to do with a continuous testing plug-in for Java.</p>
<p>Or does it?</p>
<p>Update Controls automatically discovers the data that your properties depend upon. When that data changes, those properties are updated. You might think that it's doing some sort of static analysis to discover dependencies, but it's much simpler than that.</p>
<p>Say you have a dependent property "A". As the property getter for "A" is executing, Update Controls is watching. When another property called "B" is referenced, Update Controls says "Aha! A depends upon B." It's that simple.</p>
<p><strong>Why does this work?</strong><br />Most code is deterministic. If you call it providing the same inputs, it will produce the same outputs. Furthermore, it will do so in exactly the same way. So execute some code and it see what set of properties it reads. Execute it again, and it will still read the same set of properties.</p>
<p>Now, change a property <em>not</em> in the set that was read. Does the behavior of the code change?</p>
<p>No! The code only observed one set of properties. It doesn't care what happens to any other properties. It will still read that same set, and it will still produce the same results.</p>
<p>OK, this time change a property that <em>is</em> in the set. Does the behavior of the code change?</p>
<p>You bet it does. In fact, it may change drastically. It may even read an entirely different set of properties next time. So all bets are off. Once you change a property upon which it depends, you have to dump the entire set and run the code again. Then you can gather up a brand new set.</p>
<p><strong>Back to Infinitest</strong><br />So, Ben, my advice to you. Drop the static analysis. Instead pick up a code coverage tool. Look at all of the lines of code covered by each test. If any of those lines changes, you have to rerun the test. If not, you don't. Simple as that.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexa88f.html?cat=36" title="View all posts in Update Controls" rel="category">Update Controls</a> |   <a href="index9ed5.html?p=438#comments" title="Comment on Continuous testing does not require static analysis">1 Comment &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-437"><a href="index14c7.html?p=437" rel="bookmark" title="Permanent Link to Thread safety through callbacks">Thread safety through callbacks</a></h3>
				<small>Wednesday, September 16th, 2009</small>

				<div class="entry">
					<p>While callbacks are good at proving prerequisites, they are also good at proving thread safety. Take, for example, this cache:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> CachedObject&lt;TValue&gt;
{
    <span style="color: blue">public</span> TValue Value { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }
    <span style="color: blue">public</span> DateTime DateCached { <span style="color: blue">get</span>; <span style="color: blue">private</span> <span style="color: blue">set</span>; }

    <span style="color: blue">public</span> CachedObject(TValue value, DateTime dateCached)
    {
        Value = value;
        DateCached = dateCached;
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key)
    {
        CachedObject&lt;TValue&gt; found;

        <span style="color: green">// If the object is in the cache, check the date.</span>
        <span style="color: blue">if</span> (_store.TryGetValue(key, <span style="color: blue">out</span> found) &amp;&amp;
            found.DateCached + _expiry &lt; DateTime.Now)
        {
            <span style="color: blue">return</span> found.Value;
        }
        <span style="color: blue">else</span>
        {
            <span style="color: blue">return</span> <span style="color: blue">default</span>(TValue);
        }
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> Put(TKey key, TValue value)
    {
        _store.Add(key, <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(value, DateTime.Now));
    }
}</pre>
<p>The caller has to use it properly for it to work. They have to call Get before Put (prerequisite), and they have to synchronize around the two calls. If they don't, they run the risk of creating a race condition.</p>
<p>A race condition occurs when the outcome of an operation depends upon other operations happening in parallel. If one thread gets finished first, there is one result. If another thread finishes first, there is another. In this case, two threads could try to Get the same value. Finding none, they can both race to fetch the value and put it in the cache.</p>
<p>To prove that a race condition cannot occur, we can use a callback.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Cache&lt;TKey, TValue&gt;
{
    <span style="color: blue">private</span> TimeSpan _expiry;
    <span style="color: blue">private</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt; _store =
        <span style="color: blue">new</span> Dictionary&lt;TKey, CachedObject&lt;TValue&gt;&gt;();

    <span style="color: blue">public</span> Cache(TimeSpan expiry)
    {
        _expiry = expiry;
    }

    <span style="color: blue">public</span> TValue Get(TKey key, Func&lt;TKey, TValue&gt; fetch)
    {
        <span style="color: blue">lock</span> (_store)
        {
            CachedObject&lt;TValue&gt; found;

            <span style="color: green">// If the object is not in the cache, or it is expired,</span>
            <span style="color: green">// fetch it and add it to the cache.</span>
            DateTime now = DateTime.Now;
            <span style="color: blue">if</span> (!_store.TryGetValue(key, <span style="color: blue">out</span> found) ||
                found.DateCached + _expiry &gt;= now)
            {
                found = <span style="color: blue">new</span> CachedObject&lt;TValue&gt;(fetch(key), now);
               _store.Add(key, found);
            }
            <span style="color: blue">return</span> found.Value;
        }
    }
}</pre>
<p>This version of the cache takes a callback to fetch the value if it is not found. Synchronization is now built into the Get method. The caller doesn't need to synchronize around it. More importantly, we can prove the correctness of the code without seeing the caller. There is no way to get it wrong.</p>
<p>This cache still has problems. The lock is to broad. In preventing a race condition on two thread getting the same value, we've inadvertently blocked two threads getting different values. We'll fix that next.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="index14c7.html?p=437#respond" title="Comment on Thread safety through callbacks">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-436"><a href="indexc1f6.html?p=436" rel="bookmark" title="Permanent Link to Fixing an unhelpful API">Fixing an unhelpful API</a></h3>
				<small>Tuesday, September 15th, 2009</small>

				<div class="entry">
					<p>I started Q.E.D. Hour at work to discuss ways that we can use mathematical proof to have more confidence in our code. In last week's session, we walked through some improvements to a particular piece of code. Here is how it started:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">void</span> DoWorkWithOrderService()
{
    <span style="color: blue">using</span> (ITransaction currentTransaction = <span style="color: blue">new</span> AcidTransaction(_container))
    {
        OrderService.Transaction = currentTransaction;
        OrderService.DoWork();
        currentTransaction.Commit();
    }
}</pre>
<p>It is only possible to prove the correctness of this code based on the caller (seen here), and not the order service itself. If the caller forgets to initialize the transaction property, if the caller forgets to create the transaction in a using statement, or if the caller forgets to create a new instance per thread, then bad things can happen.</p>
<p><a href="wp-content/uploads/2009/09/unhelpful-api.jpg"><img style="border-top-width: 0px; border-left-width: 0px; border-bottom-width: 0px; border-right-width: 0px" height="133" alt="Unhelpful_API" src="wp-content/uploads/2009/09/unhelpful-api-thumb.jpg" width="244" align="right" border="0"></a> The order service is an unhelpful API. When you approach it, you have to use caution. If you use it in the wrong way, bad things will happen. If you're lucky, it will throw an exception. If you are unlucky, you won't catch errors until you release to production.</p>
<p>An unhelpful API must be approached with fear.</p>
<p><strong>Parameters are prerequisites</strong><br />The first step in improving this unhelpful API is to ensure that a transaction exists before a service method is called. We can do this by turning the property into a parameter.</p>
<p>Before:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> Service : IService
{
    <span style="color: blue">public</span> ITransaction Transaction
    {
        <span style="color: blue">set</span>;
        <span style="color: blue">get</span>;
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> DoWork() { }
}</pre>
<p>After:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ServiceFactory : IServiceFactory
{
    <span style="color: blue">public</span> IService CreateService(ITransaction transaction)
    {
        <span style="color: blue">return</span> <span style="color: blue">new</span> Service(transaction);
    }
}

<span style="color: blue">public</span> <span style="color: blue">class</span> Service : IService
{
    <span style="color: blue">private</span> ITransaction _transaction;

    <span style="color: blue">public</span> Service(ITransaction transaction)
    {
        _transaction = transaction;
    }

    <span style="color: blue">public</span> <span style="color: blue">void</span> DoWork() { }
}</pre>
<p>You cannot get a service from the factory without providing a transaction. Therefore, you cannot make any service calls before providing a transaction. Q.E.D.</p>
<p><strong>Callbacks are prerequisites</strong><br />We have proven that a transaction is provided before a service method is called, but we haven't yet proven that the transaction gets disposed. We can take one more step toward making this a helpful, provable API using a callback.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> ServiceFactory : IServiceFactory
{
    <span style="color: blue">private</span> ITransactionFactory _transactionFactory;

    <span style="color: blue">public</span> <span style="color: blue">void</span> CallService(Action&lt;IService&gt; action)
    {
        <span style="color: blue">using</span> (ITransaction transaction =
            _transactionFactory.CreateTransaction())
        {
            action(<span style="color: blue">new</span> Service(transaction));
        }
    }
}</pre>
<p>A transaction factory is injected into the service factory (via constructor not shown here), and that is used to create a transaction as needed. That creation happens within a using statement in the service factory, not in the calling code. There is no way for the caller to forget to do this. Thus we have proven that the transaction gets disposed.</p>
<p>In these two steps, we have transformed an unhelpful API into a helpful one. The unhelpful API offered many options, most of them wrong. The helpful API offers only the options that are correct. It guides the caller in its proper use. It cannot be used incorrectly.</p>
<p>An unhelpful API cannot be proven. It must be approached with fear. A helpful API can be proven. It can be approached with confidence.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="indexc1f6.html?p=436#respond" title="Comment on Fixing an unhelpful API">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-433"><a href="index1557.html?p=433" rel="bookmark" title="Permanent Link to No public TypeConverter class?">No public TypeConverter class?</a></h3>
				<small>Monday, September 14th, 2009</small>

				<div class="entry">
					<p>I just saw this error message:</p>
<blockquote><p>'IEnumerable' type does not have a public TypeConverter class.</p>
</blockquote>
<p>It referred to the following XAML:</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">ListBox</span> <span style="color: red">Grid.Row</span>="<span style="color: blue">0</span>" <span style="color: red">ItemsSource</span>="<span style="color: blue"><strong>Contracts</strong></span>"<span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span><span style="color: maroon">ListBox.ItemTemplate</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">DataTemplate</span><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">TextBlock</span> <span style="color: red">Text</span>="<span style="color: blue">{Binding Name}</span>"/<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">DataTemplate</span><span style="color: blue">&gt;</span>
    <span style="color: blue">&lt;</span>/<span style="color: maroon">ListBox.ItemTemplate</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">ListBox</span><span style="color: blue">&gt;</span></pre>
<p>Do you see the problem? I forgot the {Binding} markup extension. Sometimes the solution does not fit the error message.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index81ea.html?cat=3" title="View all posts in Error messages" rel="category">Error messages</a> |   <a href="index1557.html?p=433#comments" title="Comment on No public TypeConverter class?">8 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-432"><a href="indexecc4.html?p=432" rel="bookmark" title="Permanent Link to Proof based on imperative programming">Proof based on imperative programming</a></h3>
				<small>Monday, September 14th, 2009</small>

				<div class="entry">
					<p>Our Q.E.D. homework for last week was to prove some code to be correct. In particular, prove that:</p>
<ul>
<li>The service has a transaction when it is called.
<li>The transaction is disposed.
<li>The code is thread safe.</li>
</ul>
<p>The code in question was:</p>
<pre><span style="color: blue">public</span> Order GetOrder(<span style="color: blue">int</span> orderId)
{
   <span style="color: blue">return</span> InvokeGetOrder(() =&gt; OrderServiceProvider.GetOrderWithItems(orderId));
}

<span style="color: blue">public</span> Order InvokeGetOrder(Func&lt;Order&gt; function)
{
    Order order;
    <span style="color: blue">using</span> (IBusinessTransactionContext currentBusinessTransactionContext =
        <span style="color: blue">new</span> AcidBusinessTransactionContext(_container, <span style="color: maroon">false</span>))
    {
        OrderServiceProvider.BusinessTransactionContext =
            currentBusinessTransactionContext;

        order = function();
        OrderServiceProvider.BusinessTransactionContext.Commit();
    }

    <span style="color: blue">return</span> order;
}</pre>
<p>The proof of the first two points is pretty straight forward. Because the transaction is assigned prior to calling the service function, we know the service function has a transaction. And because the transaction is created in a using statement, we know that it will be disposed.</p>
<p>The third point is harder to prove. If two threads call GetOrder on the same object, they will both try to assign a transaction to the same OrderServiceProvider. We have to prove that this won't happen. For that, we look at the Castle configuration:</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">component</span>
    <span style="color: red">id</span>="...OrderService"
    <span style="color: red">service</span>="...OrderService, ..."
    <span style="color: red">type</span>="...OrderService, ..."
    <span style="color: red">lifestyle</span>="<strong>transient</strong>”<span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span><span style="color: maroon">parameters</span><span style="color: blue">&gt;</span>
            <span style="color: blue">&lt;</span><span style="color: maroon">orderRepository</span><span style="color: blue">&gt;</span>
                ${...OrderRepository}
            <span style="color: blue">&lt;</span>/<span style="color: maroon">orderRepository</span><span style="color: blue">&gt;</span>
        <span style="color: blue">&lt;</span>/<span style="color: maroon">parameters</span><span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">component</span><span style="color: blue">&gt;</span></pre>
<p>Because the OrderService is declared to be transient, we are guaranteed to get a new instance each time the component is resolved. Each web request resolves the service, so we know that each web request gets a unique object. The request is thread safe. Q.E.D.</p>
<p><strong>Perils of imperative proofs</strong><br />While these proofs are correct, there is a significant problem. We proved correctness based on the code that calls OrderService, not based on OrderService itself. In fact, there is nothing about the OrderService API that compels the caller to use it correctly.</p>
<p>For example, the service requires that we set the BusinessTransactionContext property before we call a method. If we forget one little assignment statement, then the service does not have a transaction. This problem can be caught no earlier than integration testing.</p>
<p>If, on the other hand, we forget to create our transaction in a using statement, we have a more subtle problem. We may see that database connections leak over time. Or we may see blocking because failed transactions remain open instead of being rolled back. This problem won't be caught in integration testing, and may be very difficult to diagnose when it finally is identified.</p>
<p>And what if we forget to configure our components to be transient? The only time this causes a measurable problem is when we have concurrency greater than 1. This doesn't happen during a typical integration test. Nor does this usually happen during manual testing. The first time a web application sees concurrency is usually during stress testing, or maybe even production.</p>
<p>This lead into a discussion of prerequisites. There are ways that we can rewrite the OrderService API so that it cannot be used incorrectly. Some examples are to <a href="indexd519.html?p=415">require a parameter</a> and to <a href="index5750.html?p=416">use the constructor</a>. We'll apply these techniques to the OrderService in the next post.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index51fa.html?cat=40" title="View all posts in qed" rel="category">qed</a> |   <a href="indexecc4.html?p=432#respond" title="Comment on Proof based on imperative programming">No Comments &#187;</a></p>

			</div>

		
		<div class="navigation">
			<div class="alignleft"><a href="index4465.html?m=200909&amp;paged=2">&laquo; Previous Entries</a></div>
			<div class="alignright"></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 17 queries. 0.457 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?m=200909 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:39:31 GMT -->
</html>
