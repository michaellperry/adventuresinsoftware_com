<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?p=539 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software  &raquo; Blog Archive   &raquo; Forward network credentials to Report Server</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="widecolumn">

	
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="index0745.html?p=532">Forms Authentication and the Active Directory membership provider</a></div>
			<div class="alignright"><a href="index0d79.html?p=542">Navigate SSRS reports from a web application</a> &raquo;</div>
		</div>
		<br/>

		<div class="post" id="post-539">
			<h1>Forward network credentials to Report Server</h1>

			<div class="entry">
				<p>I am on a quest to <a href="index7398.html?p=531">deliver SSRS reports within a web application</a>. So far we have <a href="index0745.html?p=532">authenticated against Active Directory using Forms Auth</a>. Now we need to embed a report in our app. Then, we’ll need to forward the logged-on user’s AD credentials to the report server so he can access the report.</p>
<p><a href="wp-content/uploads/2010/07/image8.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="wp-content/uploads/2010/07/image-thumb8.png" width="244" height="117" /></a> <a href="wp-content/uploads/2010/07/image9.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="wp-content/uploads/2010/07/image-thumb9.png" width="244" height="86" /></a> <a href="wp-content/uploads/2010/07/image10.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="wp-content/uploads/2010/07/image-thumb10.png" width="244" height="120" /></a> </p>
<p>For now, I’m just going to add a report to Default.aspx. Later on, we’ll provide a menu to navigate the user’s reports. First, drag a “MicrosoftreportViewer” control from the Toolbox onto the designer. Then, click the task button, open “Choose Report”, and select “&lt;Server Report&gt;”. Fill in your Report Server URL, which you can get by launching “Reporting Services Configuration Manager” and selecting the Web Service URL. Enter the path to the report that you created earlier. Your page source should look like this.</p>
<pre class="code"><span style="background: #ffee62">&lt;%</span><span style="color: blue">@ </span><span style="color: #a31515">Page </span><span style="color: red">Language</span><span style="color: blue">=&quot;C#&quot; </span><span style="color: red">AutoEventWireup</span><span style="color: blue">=&quot;true&quot; </span><span style="color: red">CodeBehind</span><span style="color: blue">=&quot;Default.aspx.cs&quot; </span><span style="color: red">Inherits</span><span style="color: blue">=&quot;WebApplication1._Default&quot; </span><span style="background: #ffee62">%&gt;

&lt;%</span><span style="color: blue">@ </span><span style="color: #a31515">Register </span><span style="color: red">assembly</span><span style="color: blue">=&quot;Microsoft.ReportViewer.WebForms, Version=9.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot; </span><span style="color: red">namespace</span><span style="color: blue">=&quot;Microsoft.Reporting.WebForms&quot; </span><span style="color: red">tagprefix</span><span style="color: blue">=&quot;rsweb&quot; </span><span style="background: #ffee62">%&gt;

</span><span style="color: blue">&lt;!</span><span style="color: #a31515">DOCTYPE </span><span style="color: red">html PUBLIC </span><span style="color: blue">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;

&lt;</span><span style="color: #a31515">html </span><span style="color: red">xmlns</span><span style="color: blue">=&quot;http://www.w3.org/1999/xhtml&quot; &gt;
&lt;</span><span style="color: #a31515">head </span><span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;
    &lt;</span><span style="color: #a31515">title</span><span style="color: blue">&gt;&lt;/</span><span style="color: #a31515">title</span><span style="color: blue">&gt;
&lt;/</span><span style="color: #a31515">head</span><span style="color: blue">&gt;
&lt;</span><span style="color: #a31515">body</span><span style="color: blue">&gt;
    &lt;</span><span style="color: #a31515">form </span><span style="color: red">id</span><span style="color: blue">=&quot;form1&quot; </span><span style="color: red">runat</span><span style="color: blue">=&quot;server&quot;&gt;
    &lt;</span><span style="color: #a31515">div</span><span style="color: blue">&gt;

        &lt;</span><span style="color: #a31515">rsweb</span><span style="color: blue">:</span><span style="color: #a31515">ReportViewer </span><span style="color: red">ID</span><span style="color: blue">=&quot;ReportViewer1&quot; </span><span style="color: red">runat</span><span style="color: blue">=&quot;server&quot; </span><span style="color: red">Font-Names</span><span style="color: blue">=&quot;Verdana&quot;
            </span><span style="color: red">Font-Size</span><span style="color: blue">=&quot;8pt&quot; </span><span style="color: red">Height</span><span style="color: blue">=&quot;400px&quot; </span><span style="color: red">Width</span><span style="color: blue">=&quot;100%&quot; </span><span style="color: red">ProcessingMode</span><span style="color: blue">=&quot;Remote&quot;&gt;
            &lt;</span><span style="color: #a31515">ServerReport </span><span style="color: red">ReportPath</span><span style="color: blue">=&quot;/Admin Report&quot;
                </span><span style="color: red">ReportServerUrl</span><span style="color: blue">=&quot;http://dit3074lt2:8080/ReportServer_SQL2008R2&quot; /&gt;
        &lt;/</span><span style="color: #a31515">rsweb</span><span style="color: blue">:</span><span style="color: #a31515">ReportViewer</span><span style="color: blue">&gt;

    &lt;/</span><span style="color: #a31515">div</span><span style="color: blue">&gt;
    &lt;/</span><span style="color: #a31515">form</span><span style="color: blue">&gt;
&lt;/</span><span style="color: #a31515">body</span><span style="color: blue">&gt;
&lt;/</span><span style="color: #a31515">html</span><span style="color: blue">&gt;
</span></pre>
<p>If you run the application right now, it looks like it all works! That’s because you are running a local web server under your own account. Your credentials are passed to the report server. We want to pass the logged-in user’s credentials to Report Server, so he can only access the reports to which he has been given permission.</p>
<p><strong>Provide credentials to report Server</strong></p>
<p>To pass credentials to Report Server, we set the ReportViewer.ServerReport.ReportServerCredentials property to an IReportServerCredentials. There are many ways to implement this interface. The simplest way is to provide a NetworkCredentials object.</p>
</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">NetworkReportServerCredentials </span>: <span style="color: #2b91af">IReportServerCredentials
</span>{
    <span style="color: blue">private string </span>_userName;
    <span style="color: blue">private string </span>_password;
    <span style="color: blue">private string </span>_domain;

    <span style="color: blue">public </span>NetworkReportServerCredentials(<span style="color: blue">string </span>userName, <span style="color: blue">string </span>password, <span style="color: blue">string </span>domain)
    {
        _userName = userName;
        _password = password;
        _domain = domain;
    }

    <span style="color: blue">public bool </span>GetFormsCredentials(<span style="color: blue">out </span><span style="color: #2b91af">Cookie </span>authCookie, <span style="color: blue">out string </span>userName, <span style="color: blue">out string </span>password, <span style="color: blue">out string </span>authority)
    {
        authCookie = <span style="color: blue">null</span>;
        userName = <span style="color: blue">null</span>;
        password = <span style="color: blue">null</span>;
        authority = <span style="color: blue">null</span>;
        <span style="color: blue">return false</span>;
    }

    <span style="color: blue">public </span><span style="color: #2b91af">WindowsIdentity </span>ImpersonationUser
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return null</span>; }
    }

    <span style="color: blue">public </span><span style="color: #2b91af">ICredentials </span>NetworkCredentials
    {
        <span style="color: blue">get </span>{ <span style="color: blue">return new </span><span style="color: #2b91af">NetworkCredential</span>(_userName, _password, _domain); }
    }
}</pre>
<p>This implementation only provides a meaningful implementation to the NetworkCredentials property. It just returns the credentials that it was given. We have to get the user’s credentials into this object when we access the report. We captured the user’s credentials when he logged in, but we didn’t save them anywhere. We need to save them during login so we can access them while viewing the report.</p>
<p>During login, we have the opportunity to populate a FormsAuthenticationTicket. This is the object that gets stored in the user’s Forms Authorization cookie. This class holds the user’s name, but not their password. However, it does have a UserData property that we can use however we want.</p>
<p><strong>Cryptography required</strong></p>
<p>Now, we could just put the plaintext password into UserData. But we aren’t going to do that. This object is cached as a cookie in the user’s browser. Storing their plaintext password in a cookie would reveal it to anyone who had access to their machine. Even without direct access to the machine, a cross-site scripting attack could compel the browser to give up its cookie. We will not expose the user to that kind of vulnerability.</p>
<p>Instead, we are going to encrypt the password using a secret key that we store on the server. An attacker would need access to this key if they were going to pull the user’s password from their cookie. First, we create some useful crypto helpers:</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">Crypto
</span>{
    <span style="color: blue">public static byte</span>[] EncryptMessage(
        <span style="color: blue">string </span>messageIn,
        <span style="color: #2b91af">SymmetricAlgorithm </span>symmetricAlgorithm,
        <span style="color: blue">byte</span>[] key,
        <span style="color: blue">byte</span>[] initializationVector)
    {
        <span style="color: #2b91af">MemoryStream </span>memoryStream = <span style="color: blue">new </span><span style="color: #2b91af">MemoryStream</span>();
        <span style="color: blue">using </span>(<span style="color: #2b91af">StreamWriter </span>cryptoWriter = <span style="color: blue">new </span><span style="color: #2b91af">StreamWriter</span>(
            <span style="color: blue">new </span><span style="color: #2b91af">CryptoStream</span>(
                memoryStream,
                symmetricAlgorithm.CreateEncryptor(key, initializationVector),
                <span style="color: #2b91af">CryptoStreamMode</span>.Write)))
        {
            cryptoWriter.Write(messageIn);
        }

        <span style="color: blue">return </span>memoryStream.ToArray();
    }

    <span style="color: blue">public static string </span>DecryptMessage(
        <span style="color: blue">byte</span>[] encryptedMessage,
        <span style="color: #2b91af">SymmetricAlgorithm </span>symmetricAlgorithm,
        <span style="color: blue">byte</span>[] key,
        <span style="color: blue">byte</span>[] initializationVector)
    {
        <span style="color: #2b91af">MemoryStream </span>memoryStream = <span style="color: blue">new </span><span style="color: #2b91af">MemoryStream</span>(encryptedMessage);
        <span style="color: blue">using </span>(<span style="color: #2b91af">StreamReader </span>cryptoReader = <span style="color: blue">new </span><span style="color: #2b91af">StreamReader</span>(
            <span style="color: blue">new </span><span style="color: #2b91af">CryptoStream</span>(
                memoryStream,
                symmetricAlgorithm.CreateDecryptor(key, initializationVector),
                <span style="color: #2b91af">CryptoStreamMode</span>.Read)))
        {
            <span style="color: blue">return </span>cryptoReader.ReadToEnd();
        }
    }

    <span style="color: blue">public static byte</span>[] ComputeStringHash(<span style="color: blue">string </span>message, <span style="color: #2b91af">HashAlgorithm </span>hashAlgorith)
    {
        <span style="color: blue">byte</span>[] messageBytes = <span style="color: #2b91af">ASCIIEncoding</span>.ASCII.GetBytes(message);
        <span style="color: blue">return </span>hashAlgorith.ComputeHash(messageBytes);
    }
}</pre>
<p>The first two methods encrypt and decrypt a string using a symmetrical algorithm. The encrypted message is binary, so it is represented as a byte array. I found it exceedingly difficult to get these steps right, even though the code turned out to be almost trivial. The third method hardly deserves to be included with the others, but it comes in handy.</p>
<p>Let’s see how these methods are used.</p>
<pre class="code">[<span style="color: #2b91af">TestClass</span>]
<span style="color: blue">public class </span><span style="color: #2b91af">CryptoStreamTest
</span>{
    <span style="color: blue">private const string </span>PreGeneratedKey = <span style="color: #a31515">@&quot;s03UsP/dHD0=&quot;</span>;
    <span style="color: blue">private </span><span style="color: #2b91af">SymmetricAlgorithm </span>_symmetricAlgorithm = <span style="color: blue">new </span><span style="color: #2b91af">DESCryptoServiceProvider</span>();
    <span style="color: blue">private </span><span style="color: #2b91af">HashAlgorithm </span>_hashAlgorith = <span style="color: blue">new </span><span style="color: #2b91af">MD5CryptoServiceProvider</span>();
    <span style="color: blue">private </span><span style="color: #2b91af">RandomNumberGenerator </span>_randomNumberGenerator = <span style="color: blue">new </span><span style="color: #2b91af">RNGCryptoServiceProvider</span>();
    <span style="color: blue">private static byte</span>[] _key = <span style="color: #2b91af">Convert</span>.FromBase64String(PreGeneratedKey);

    <span style="color: blue">public </span><span style="color: #2b91af">TestContext </span>TestContext { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    [<span style="color: #2b91af">TestMethod</span>]
    <span style="color: blue">public void </span>GenerateKey()
    {
        <span style="color: blue">byte</span>[] key = <span style="color: blue">new byte</span>[_symmetricAlgorithm.KeySize / 8];
        _randomNumberGenerator.GetBytes(key);
        <span style="color: blue">string </span>encodedKey = <span style="color: #2b91af">Convert</span>.ToBase64String(key);
        <span style="color: #2b91af">Assert</span>.AreNotEqual(PreGeneratedKey, encodedKey);
        <span style="color: #2b91af">Console</span>.WriteLine(encodedKey);
    }

    [<span style="color: #2b91af">TestMethod</span>]
    <span style="color: blue">public void </span>EncryptAndDecryptStream()
    {
        <span style="color: blue">byte</span>[] initializationVector = <span style="color: blue">new byte</span>[_symmetricAlgorithm.KeySize / 8];
        _randomNumberGenerator.GetBytes(initializationVector);
        <span style="color: blue">byte</span>[] encryptedMessage = <span style="color: #2b91af">Crypto</span>.EncryptMessage(<span style="color: #a31515">&quot;plaintext&quot;</span>, _symmetricAlgorithm, _key, initializationVector);
        <span style="color: blue">string </span>messageOut = <span style="color: #2b91af">Crypto</span>.DecryptMessage(encryptedMessage, _symmetricAlgorithm, _key, initializationVector);

        <span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: #a31515">&quot;plaintext&quot;</span>, messageOut);
    }

    [<span style="color: #2b91af">TestMethod</span>]
    <span style="color: blue">public void </span>InitializationVectorIsImportant()
    {
        <span style="color: blue">byte</span>[] initializationVector1 = <span style="color: blue">new byte</span>[_symmetricAlgorithm.KeySize / 8];
        _randomNumberGenerator.GetBytes(initializationVector1);
        <span style="color: blue">byte</span>[] initializationVector2 = <span style="color: blue">new byte</span>[_symmetricAlgorithm.KeySize / 8];
        _randomNumberGenerator.GetBytes(initializationVector2);
        <span style="color: blue">byte</span>[] encryptedMessage = <span style="color: #2b91af">Crypto</span>.EncryptMessage(<span style="color: #a31515">&quot;plaintext&quot;</span>, _symmetricAlgorithm, _key, initializationVector1);
        <span style="color: blue">string </span>messageOut = <span style="color: #2b91af">Crypto</span>.DecryptMessage(encryptedMessage, _symmetricAlgorithm, _key, initializationVector2);

        <span style="color: #2b91af">Assert</span>.AreNotEqual(<span style="color: #a31515">&quot;plaintext&quot;</span>, messageOut);
    }

    [<span style="color: #2b91af">TestMethod</span>]
    <span style="color: blue">public void </span>HashMessage()
    {
        <span style="color: blue">byte</span>[] hash = <span style="color: #2b91af">Crypto</span>.ComputeStringHash(<span style="color: #a31515">&quot;This is the string that we intend to sign.&quot;</span>, _hashAlgorith);
        <span style="color: blue">string </span>encodedHash = <span style="color: #2b91af">Convert</span>.ToBase64String(hash);
        <span style="color: #2b91af">Assert</span>.AreEqual(<span style="color: #a31515">@&quot;04fj0UWULE9imGTrHRUw5g==&quot;</span>, encodedHash);
    }
}</pre>
<p>To generate a key, we use the cryptographic random number generator RNGCryptoServiceProvider. This produces a binary array of the key length required by our symmetrical encryption algorithm. Convert the binary array to a base 64 string for easy portability. I generated one ahead of time for use with the remaining tests.</p>
<p>To encrypt and decrypt a string, we must provide not only a key but also an initialization vector. The initialization vector is a starting point for the symmetrical algorithm. Encryption and decryption must both start at the same point. The trick is that we don’t want to use the same initialization vector every time, because that would mean we always produce the same cyphertext for a given plaintext. An attacker could simply create an account with a common password (say, “password”), and then look for other users with the same cyphertext as he has. Bingo! He knows that their password is “password”!</p>
<p>Finally, we test computing the hash of a string. This is usually used to digitally sign a message, but we have another use for it.</p>
<p><strong>Encrypt the user’s password</strong></p>
<p>We want to encrypt the user’s password. For that we’ll need a key; you can generate one with the first unit test above. But we will also need an initialization vector. Remember, we need to use the same initialization vector for encrypting as well as decrypting. And we’ll also need it to be different for each user. The simple solution: use the hash of the username.</p>
<pre class="code"><span style="color: blue">protected void </span>Login1_Authenticate(<span style="color: blue">object </span>sender, <span style="color: #2b91af">AuthenticateEventArgs </span>e)
{
    <span style="color: blue">string </span>username = Login1.UserName;
    <span style="color: blue">string </span>password = Login1.Password;

    <span style="color: green">// MLP: Encrypt the password.
    </span><span style="color: blue">byte</span>[] usernameHash = <span style="color: #2b91af">Crypto</span>.ComputeStringHash(username, _hashAlgorith);
    <span style="color: blue">byte</span>[] encryptedMessage = <span style="color: #2b91af">Crypto</span>.EncryptMessage(password, _symmetricAlgorithm, _key, usernameHash);
    <span style="color: blue">string </span>encryptedPassword = <span style="color: #2b91af">Convert</span>.ToBase64String(encryptedMessage);

    <span style="color: blue">if </span>(<span style="color: #2b91af">Membership</span>.ValidateUser(username, password))
    {
        e.Authenticated = <span style="color: blue">true</span>;

        <span style="color: #2b91af">FormsAuthenticationTicket </span>ticket = <span style="color: blue">new </span><span style="color: #2b91af">FormsAuthenticationTicket</span>(
            1,
            username,
            <span style="color: #2b91af">DateTime</span>.Now,
            <span style="color: #2b91af">DateTime</span>.Now.AddMinutes(30),
            <span style="color: blue">false</span>,
            encryptedPassword,
            <span style="color: #2b91af">FormsAuthentication</span>.FormsCookiePath);

        <span style="color: green">// MLP: This method should be called &quot;Encode&quot;, not &quot;Encrypt&quot;.
        </span><span style="color: blue">string </span>encTicket = <span style="color: #2b91af">FormsAuthentication</span>.Encrypt(ticket);

        <span style="color: green">// Create the cookie.
        </span>Response.Cookies.Add(<span style="color: blue">new </span><span style="color: #2b91af">HttpCookie</span>(<span style="color: #2b91af">FormsAuthentication</span>.FormsCookieName, encTicket));

        <span style="color: green">// Redirect back to original URL.
        </span>Response.Redirect(<span style="color: #2b91af">FormsAuthentication</span>.GetRedirectUrl(username, <span style="color: blue">false</span>));
    }
    <span style="color: blue">else
    </span>{
        e.Authenticated = <span style="color: blue">false</span>;
    }
}</pre>
<p>Hold on a second. If we are calling FormsAuthentication.Encrypt(), why are we bothering to encrypt the password first? Unfortunately, Encrypt() is not secure. It doesn’t take a key. That means that anyone with access to the .NET Framework can simply call Decrypt() to get back the ticket. I would prefer if the method was called Encode().</p>
<p><strong>Decrypt the user’s password</strong></p>
<p>The last step is to access the encrypted password, decrypt it, and pass the credentials to Report Server. We accomplish this with a minimum of code:</p>
<pre class="code"><span style="color: blue">protected void </span>Page_Load(<span style="color: blue">object </span>sender, <span style="color: #2b91af">EventArgs </span>e)
{
    <span style="color: green">// MLP: Get the user's credentials from forms auth.
    </span><span style="color: #2b91af">IIdentity </span>identity = <span style="color: #2b91af">HttpContext</span>.Current.User.Identity;
    <span style="color: #2b91af">FormsIdentity </span>formsIdentity = (<span style="color: #2b91af">FormsIdentity</span>)identity;
    <span style="color: blue">string </span>username = formsIdentity.Name;
    <span style="color: blue">string </span>encryptedPassword = formsIdentity.Ticket.UserData;

    <span style="color: green">// MLP: Decrypt the password.
    </span><span style="color: blue">byte</span>[] usernameHash = <span style="color: #2b91af">Crypto</span>.ComputeStringHash(username, _hashAlgorith);
    <span style="color: blue">byte</span>[] encryptedMessage = <span style="color: #2b91af">Convert</span>.FromBase64String(encryptedPassword);
    <span style="color: blue">string </span>password = <span style="color: #2b91af">Crypto</span>.DecryptMessage(encryptedMessage, _symmetricAlgorithm, _key, usernameHash);

    <span style="color: #2b91af">IReportServerCredentials </span>credentials = <span style="color: blue">new </span><span style="color: #2b91af">NetworkReportServerCredentials</span>(username, password, <span style="color: #a31515">&quot;ABSG&quot;</span>);
    ReportViewer1.ServerReport.ReportServerCredentials = credentials;
}</pre>
<p>And so we have passed the user’s network credentials on to Report Server. They were authenticated against Active Directory, which is the identity provider that SSRS prefers. However, we did all this in forms authentication so that our web application works better with users on the Internet.</p>
<p><strong>Next steps</strong></p>
<p>Next we are going to provide a menu of reports to the user. The business administrator should be able to define new reports without requiring any change to our application.</p>

				
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on Tuesday, July 27th, 2010 at 3:52 pm						and is filed under <a href="index363a.html?cat=45" title="View all posts in Reports" rel="category">Reports</a>.
						You can follow any responses to this entry through the <a href='indexdd56.html?feed=rss2&amp;p=539'>RSS 2.0</a> feed.

													You can skip to the end and leave a response. Pinging is currently not allowed.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->

	<h3 id="comments">4 Responses to &#8220;Forward network credentials to Report Server&#8221;</h3>

	<ol class="commentlist">

	
		<li class="alt" id="comment-85482">
			<cite><a href='http://www.warnes.com/' rel='external nofollow'>tootoomike</a></cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-85482" title="">September 17th, 2010 at 5:21 am</a> </small>

			<p>Michael, thanks very much for this excellent article, amazingly this is the only good, clear and simple explanation of consuming SRSS from an asp.net web app (I couldn't find anything on MSDN for example), if the SRSS is on a different unconnected domain. The example of the NetworkReportServerCredentials class is excellent, and has enabled me to use a SRSS web reference ReportingService2010 class to retrieve reportlisting to enable user selection...(is this something you've considered?), something like this...</p>
<p>        internal static ReportingService2010WebReference.CatalogItem[] GetNavBarGroupForReportFolder(string reportDir, string groupTitle)<br />
        {<br />
            ReportingService2010WebReference.CatalogItem[] result = null;</p>
<p>            ReportingService2010WebReference.ReportingService2010 rs = new ReportingService2010WebReference.ReportingService2010();<br />
            rs.Credentials = new NetworkReportServerCredentials("username", "password", "domain").NetworkCredentials;<br />
            result = rs.ListChildren(reportDir, false);</p>
<p>            return result;<br />
        }</p>
<p>cheers mate, great work<br />
Mike</p>

		</li>

	
	
		<li class="" id="comment-85570">
			<cite>Michael L Perry</cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-85570" title="">September 17th, 2010 at 5:20 pm</a> </small>

			<p>Funny you should mention that. Check out the follow up posts:<br />
<a href="index0d79.html?p=542" rel="nofollow">http://adventuresinsoftware.com/blog/?p=542</a><br />
<a href="index7cc7.html?p=547" rel="nofollow">http://adventuresinsoftware.com/blog/?p=547</a><br />
<a href="indexbcc1.html?p=549" rel="nofollow">http://adventuresinsoftware.com/blog/?p=549</a></p>
<p>Glad it helped.</p>

		</li>

	
	
		<li class="alt" id="comment-151212">
			<cite>Graham</cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-151212" title="">May 10th, 2011 at 4:29 am</a> </small>

			<p>This is an absolutely brilliant article and exactly what I've been looking for!<br />
Spent an entire day Googling, came back into work the next day and came across this page after a few clicks.<br />
Many thanks for publishing this - it is something that should definitely be on MSDN by default.</p>

		</li>

	
	
		<li class="" id="comment-153687">
			<cite><a href='http://www.bakojohn.com/' rel='external nofollow'>Bakos</a></cite> Says:
						<br />

			<small class="commentmetadata"><a href="#comment-153687" title="">May 18th, 2011 at 9:35 am</a> </small>

			<p>Great article. Thnx a lot. I was looking for hours to understand the mechanism. However in visual studio 2010, I had to check whether it is a postback or not, in order to see the report, otherwise it was trying to load in an infinite loop. For more info, one can read also here <a href="http://blogs.msdn.com/b/brianhartman/archive/2010/03/21/reports-never-stop-loading-with-vs-2010.aspx" rel="nofollow">http://blogs.msdn.com/b/brianhartman/archive/2010/03/21/reports-never-stop-loading-with-vs-2010.aspx</a></p>
<p>Thnx again for the great article.</p>
<p>Bakos</p>

		</li>

	
	
	</ol>

 


<h3 id="respond">Leave a Reply</h3>

<p>You must be <a href="wp-loginc69d.html?redirect_to=http://adventuresinsoftware.com/blog/?p=539">logged in</a> to post a comment.</p>


	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 21 queries. 0.336 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?p=539 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:34 GMT -->
</html>
