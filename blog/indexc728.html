<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?cat=7 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software   &raquo; Databases</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

		
		 		<h2 class="pagetitle">Archive for the &#8216;Databases&#8217; Category</h2>

 	  

		<div class="navigation">
			<div class="alignleft"><a href="index7d66.html?cat=7&amp;paged=2">&laquo; Previous Entries</a></div>
			<div class="alignright"></div>
		</div>

				<div class="post">
				<h3 id="post-576"><a href="indexaa4f.html?p=576" rel="bookmark" title="Permanent Link to A non-relational database for Windows Phone 7">A non-relational database for Windows Phone 7</a></h3>
				<small>Monday, November 1st, 2010</small>

				<div class="entry">
					<p>The Windows Phone 7 development platform shipped with no built-in database. This is a surprising departure from Windows CE and Windows Mobile, both of which had on-device database support. Several open-source relational database projects are currently porting their codebases. But perhaps this is a good time to reevaluate the needs of the platform. Do you really want a relational database on a phone?</p>
<p><a href="http://correspondence.codeplex.com/">Correspondence</a> is a non-relational database for occasionally-connected clients. The new build of Correspondence has project templates for Windows Phone 7. It is a natural fit for the platform. After all, what client is more occasionally-connected than a phone?</p>
<h3>What can you do with a non-relational database?</h3>
<p>Relational databases are optimized for ad-hoc queries, such as those required for data analysis and business intelligence. Relational databases are fantastic at reporting, and very efficient at processing large numbers of records. Your typical phone application requires none of these things.</p>
<p>There are several flavors of non-relational database (document, associative array, network, etc.) Each offers different sets of features. In general, however, non-relational databases are good at:</p>
<ul>
<li>Quickly locating related entities.</li>
<li>Representing hierarchical data.</li>
<li>Searching or sorting by application-defined attributes.</li>
<li>Mapping to object-oriented code.</li>
</ul>
<p>These are typically the features most desired by mobile application developers.</p>
<h3>Where does Correspondence fit in?</h3>
<p>Correspondence is a historical database. It is closely related to a network database, but with one significant difference: all entities are immutable. This is how historical databases gain their uncanny ability to synchronize.</p>
<p>Both historical and network databases directly connect entities with their neighbors. A phone application requires quick access to related entities. Starting at one point, the user of the application selects items to drill through a network of objects. They want the application to start up quickly, and they want the phone to be responsive. These phones generally do not have powerful processors or a great deal of memory. So a database that links entities directly to one another rather than indexing them is a win in this situation.</p>
<p>But historical and network databases differ in that network databases allow entities to change over time. This is the way we typically think about object-oriented systems. But historical databases do not allow entities to change. The only way to alter an entity is to append another that changes its meaning. The entity itself is immutable.</p>
<p>The reason for modeling data historically is to support synchronization. Things that change are hard to synchronize. Things that don’t are easy. A phone is only a small part of a person’s life. If their data was only on the device, it would be of limited value. A database that is optimized for synchronizing with the desktop and the Web is much more compelling.</p>
<h3>How do you model changing data with immutable entities?</h3>
<p>Consider a chess board. During the course of the game, the board position changes dramatically. We could model a chess game in an object-oriented system as an 8-by-8 grid of squares whose values change over time.</p>
<p>But the chess game is actually a sequence of discrete moves. Once a move is made, it cannot be changed. By observing that history of moves, we can determine the current position of the board. In fact, we can reconstruct the board position at any point in time. The mutable chess board is modeled with a sequence of immutable moves.</p>
<p>An application based on a historical database works the same way. Rather than capturing the current state of the system, the database captures all of the decisions that led to that state. These decisions have been made in the past, and are now considered historical facts. By querying related facts, the application can quickly determine the state of the system.</p>
<p>Take a contact manager application, for example. Add a person with the name “Mike”. You will have a Person fact and a Name fact.</p>
<p><a href="wp-content/uploads/2010/11/contacts.jpg"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="Contacts" border="0" alt="Contacts" src="wp-content/uploads/2010/11/contacts-thumb.jpg" width="157" height="155" /></a></p>
<p>Now let’s change the name. We do that by introducing a new Name fact. This one not only references the Person, but also the prior name.</p>
<p><a href="wp-content/uploads/2010/11/contacts1.jpg"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="Contacts" border="0" alt="Contacts" src="wp-content/uploads/2010/11/contacts-thumb1.jpg" width="227" height="251" /></a></p>
<p>We don’t have to replay all of the historical facts to determine the current name of a contact. We can quickly query a Person for the related Name that has not been replaced. In the modeling language of Correspondence, the query looks like this:</p>
<pre><span style="color: blue">fact</span> <span style="color: #2b91af">Person</span> {
    <span style="color: blue">unique</span>;

    <span style="color: #2b91af">Name</span>* currentNames {
        <span style="color: #2b91af">Name</span> n : n.person = <span style="color: blue">this</span>
            <span style="color: blue">where</span> n.isCurrent
    }
}

<span style="color: blue">fact</span> <span style="color: #2b91af">Name</span> {
    <span style="color: #2b91af">Person</span> person;
    <span style="color: #2b91af">Name</span>* prior;
    <span style="color: blue">string</span> value;

    <span style="color: blue">bool</span> isCurrent {
        <span style="color: blue">not</span> <span style="color: blue">exists</span> <span style="color: #2b91af">Name</span> next : next.prior = <span style="color: blue">this</span>
    }
}</pre>
<p>The currentNames query appears as a collection in code. You can make it look like a mutable property like this:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">partial</span> <span style="color: blue">class</span> <span style="color: #2b91af">Person</span> {
    <span style="color: blue">string</span> <span style="color: #2b91af">Name</span>
    {
        <span style="color: blue">get</span>
        {
            <span style="color: blue">return</span> <span style="color: #2b91af">CurrentNames</span>
                .Select(name =&gt; name.Value)
                .FirstOrDefault();
        }
        <span style="color: blue">set</span>
        {
            <span style="color: #2b91af">Community</span>.AddFact(<span style="color: blue">new</span> <span style="color: #2b91af">Name</span>(<span style="color: blue">this</span>, <span style="color: #2b91af">CurrentNames</span>, value));
        }
    }
}</pre>
<p>The getter pulls the value of the Name matching the query. The setter creates a new name. It passes CurrentNames to the new fact as the value of “prior”, thus ensuring that it replaces the current value.</p>
<h3>What next?</h3>
<p>Please download the latest build of <a href="http://correspondence.codeplex.com/">Correspondence</a> from CodePlex. On that site, you will also find some walkthroughs that take you through building your first Correspondence application in WPF. Once you are comfortable thinking historically, try it on Windows Phone 7. You can find more patterns like the one above on <a href="http://histiricalmodeling.com/">Historical Modeling</a>.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index38d0.html?cat=46" title="View all posts in Correspondence" rel="category">Correspondence</a>,  <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="indexaa4f.html?p=576#respond" title="Comment on A non-relational database for Windows Phone 7">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-563"><a href="index03c9.html?p=563" rel="bookmark" title="Permanent Link to Historical Trees">Historical Trees</a></h3>
				<small>Friday, October 1st, 2010</small>

				<div class="entry">
					<p>In developing Correspondence for the Windows Phone 7, I’ve uncovered a need for a new data structure. I’m calling this data structure a Historical Tree, since it is designed specifically for historical modeling.</p>
<p>Correspondence allows for interchangeable storage strategies. The storage strategies currently implemented are:</p>
<ul>
<li>SSCE (.NET)</li>
<li>SQL Server (.NET)</li>
<li>SQL Azure (.NET)</li>
<li>Postgres (Java)</li>
<li>Memory (both)</li>
</ul>
<p>Most of these are built on a relational database, with the obvious exception of the memory storage strategy. Memory storage was originally intended for unit testing, but can sometimes be useful for small clients. It is not optimized for large data sets.</p>
<p>Windows Phone 7 does not have an out-of-the-box relational database. The storage strategy that you see in the videos is a modified memory strategy. It loads all of the facts from isolated storage into memory on startup. This is incredibly inefficient, and not the way that I’m going to ship. Instead, I’m going to rewrite the isolated storage storage strategy to use a historical tree.</p>
<h3>Operations</h3>
<p>The operations that a Correspondence storage strategy must support are:</p>
<ul>
<li>Insert a fact having data and references to predecessors.</li>
<li>Given a fact reference, load its data and predecessor references.</li>
<li>Given a hash code, load a fact reference.</li>
<li>Given a predecessor reference, find all successor references.</li>
</ul>
<p>Update and delete are not valid operations on a Correspondence store. When a fact is created, all of its predecessors are known. Successors are all of the facts that reference a predecessor.</p>
<h3>Append only</h3>
<p><a href="wp-content/uploads/2010/10/image.png"><img src="wp-content/uploads/2010/10/image-thumb.png" style="border-width: 0px; display: inline; margin-left: 0px; margin-right: 0px" title="image" alt="image" align="left" border="0" width="101" height="190" /></a><a href="wp-content/uploads/2010/10/historicaltreeexample.png"><img src="wp-content/uploads/2010/10/image-thumb1.png" style="border-width: 0px; display: inline; margin-left: 0px; margin-right: 0px" title="image" alt="image" align="right" border="0" width="244" height="176" /></a> This set of operations suggests an append-only data structure.</p>
<p>You can add new facts to the end of the structure, but you cannot insert or remove them from the middle. Furthermore, all predecessor references are fixed and known at the time of insert. These will necessarily be references to facts earlier in the structure.</p>
<p>The only part of the data structure that changes is the list of successors. When a new fact is appended, it has to insert itself into the lists of each of its predecessors. To support this, a fact will participate in one linked list per predecessor.</p>
<p>Each fact has a pointer to the head of its linked list of successors. This is the fact most recently appended that references this fact as a predecessor.</p>
<p>Then, for each predecessor, the fact identifies the role that the predecessor plays, the reference to the predecessor, and the reference to the next successor of that predecessor. To traverse the list of successors, first follow the head. Then find the matching predecessor reference and follow its next pointer. This will visit successors from most recent to least recent.</p>
<p>Finally, the fact has a payload of data. This includes the type, the version, and values of all fields. The data appears last because it is not used while traversing the tree.</p>
<p>The only field of a record that can change is the head pointer (highlighted in red). All other fields are immutable. To protect against corruption, the head is redundant. Each record holds two pointers and an A/B switch. The switch determines which of the two pointers is active. During modification, the new pointer is written to the inactive area, and then the switch is flipped.</p>
<h3>Insertion</h3>
<p>To insert into this structure, a new record is appended to the file. Initially, the head pointer is null. The next pointers are copies of the head pointers of each predecessor.</p>
<p>Then for each predecessor, the new record’s position is stored as their head. This operation is done using the A/B switch so that the new pointer does not overwrite the active one.</p>
<p>If a fact references the same predecessor twice (possibly in two different roles), then both of the next pointers contain a copy of the previous head. Traversal will follow only the first of them, so the successor will appear only once in the linked list.</p>
<h3>Traversal</h3>
<p>References to all predecessors are immediately available from any record. References to successors, on the other hand, follow the linked list from the head.</p>
<p>When following the linked list, the predecessor sub-records are scanned for the one matching the desired fact. The next pointer of the first match is followed. If that pointer is null, then traversal is complete.</p>
<h3></h3>
<h3>Hash code</h3>
<p>The historical tree supports all but one required operation: hash code to fact reference. This operation is instead supported by a parallel index data structure. A red-black tree seems the best fit for this operation.</p>
<p>When a fact is inserted, its hash code is calculated. That hash code is inserted into a red-black tree, with a reference back to the fact’s position in the historical tree.</p>
<p>Facts are written to the historical tree before being added to the red-black index tree. If the index becomes corrupted, then in the worst case it can be rebuilt from the historical tree. In the best case, the corruption can be repaired by re-adding facts from the end of the historical tree.</p>
<h3>Complexity</h3>
<p>The complexity of an insert or traversal is not affected by the total size of the data set. Insertion complexity is proportional to the number of predecessors, which is fixed and based on the design of the model. Traversal of predecessors is similarly proportional to the number of predecessors. A well-designed model will limit the number of predecessors.</p>
<p>Traversal of successors is proportional to the number of successors times the average number of predecessors that each predecessor has. It requires walking a linked list, which is O(n). But at each node, the list of predecessors is scanned to find the next pointer. Because of this, we multiply the average number of predecessors. Based on the design of the model, this number is assumed to be limited.</p>
<p>Insertion and traversal of the index is O(log(n)), where n is the number of facts in the store. Indexing becomes slower over time, but not rapidly so. Still, it is recommended that the store be turned over periodically, both to keep the index performant and to release resources on the device.</p>
<h3>Turning over the store</h3>
<p>Correspondence supports the idea of turning over a fact store. Two stores are kept at any time. One is read-only and the other is read-write. The read-write store collects new facts, and takes a copy of all relevant facts. The read-only store is frozen. It is consulted during queries, and its results merged with the results from the read-write store.</p>
<p>Over time, all of the relevant facts are copied to the read-write store, and the read-only store provides no additional value. After this point, the read-only store is archived and the read-write store becomes read-only. A new empty read-write store is created.</p>
<p>On a mobile device, the old store is destroyed rather than archived. All of its facts have been pushed to a server. It is assumed that any facts that the user still cares about were already copied to the next store.</p>
<p>I am currently working on push notifications to the phone. But when that is finished, I will implement historical trees in isolated storage. This data structure is specifically designed for Correspondence, so I expect it to perform extremely well. In fact, I’m considering porting it back to the desktop as an alternative to SSCE.</p>
<p style="padding: 0px; margin: 0px; display: inline; float: none" id="scid:8eb9d37f-1541-4f29-b6f4-1eea890d4876:cc2abc73-aff1-44e3-b864-8d985e5fee7b" class="wlWriterEditableSmartContent"><a href="wp-content/uploads/2010/10/historicaltreeexample.png" target="_self">Historical tree example.png</a></p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index03c9.html?p=563#respond" title="Comment on Historical Trees">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-488"><a href="indexfaa1.html?p=488" rel="bookmark" title="Permanent Link to Map IDs during data import">Map IDs during data import</a></h3>
				<small>Thursday, March 25th, 2010</small>

				<div class="entry">
					<p>It’s always best to develop against realistic data. No data is more realistic than production data. If you can legally and ethically import production data to development, you should definitely do so.</p>
<p>We’re developing a new rebate program for pharmaceuticals. Rather than creating a dummy product catalog, we would rather import the actual catalog from production.</p>
<p>The problem is the auto-incrementing IDs. We’re not just pulling in a flat structure; we’re maintaining relationships in a tree structure. When we insert rows into the dev database, these rows get different IDs than the production rows. As a result, the foreign key relationships get broken.</p>
<p>One solution to this problem is to drop all of the data and do an identity insert. Temporarily turn off the auto-incrementing behavior of the primary key so that you can specify exactly what it should be. This brings all of the production IDs into dev, so the foreign key relationships still line up.</p>
<p>The problem with that solution is that you have to drop all of the existing dev data in order to import. We have other structures that are loosely related to the product catalog. Dropping the product catalog would require us to drop some of the tables used by these other systems. All of the test data we loaded for those systems would be lost.</p>
<p><strong>Here’s my solution</strong>     <br />Instead of enforcing that the development IDs are equal to the production IDs, we can instead record a map. By joining to this map, we can insert the development IDs into foreign key columns, preserving the relationships from production. Here’s how we do it.</p>
<p><strong>Step 1:</strong> Restore a backup of production data into a new database on the development server. You might also use replication for this, if you already have a subscription. Be sure that you get only the subset that you are legally and ethically permitted to use. In our case, the product catalog is what we need, but we do not restore any tables containing patient information.</p>
<p><strong>Step 2:</strong> Identify the natural key. The ID that you are mapping is the surrogate key. The natural key is the set of columns that tell you that this is conceptually the same row. In our case, we are using the drug class name and the product group name.</p>
<p><strong>Step 3:</strong> Copy rows that do not already exist based on the natural key. Use INSERT … SELECT … WHERE NOT EXISTS for this operation. For example:</p>
<pre><span style="color: blue">INSERT</span> <span style="color: blue">INTO</span> [<span style="color: black">Dev</span>].<span style="color: black">dbo</span>.[<span style="color: black">DrugClass</span>]
           ([<span style="color: black">Name</span>])
<span style="color: blue">SELECT</span> [<span style="color: black">Name</span>]
  <span style="color: blue">FROM</span> [<span style="color: black">Prod</span>].<span style="color: black">dbo</span>.[<span style="color: black">DrugClass</span>] <span style="color: black">s</span>
  <span style="color: blue">WHERE</span> <span style="color: silver">NOT</span> <span style="color: silver">EXISTS</span> (<span style="color: blue">SELECT</span> * <span style="color: blue">FROM</span> [<span style="color: black">Dev</span>].<span style="color: black">dbo</span>.[<span style="color: black">DrugClass</span>] <span style="color: black">t</span> <span style="color: blue">WHERE</span> <span style="color: black">t</span>.<span style="color: black">Name</span> = <span style="color: black">s</span>.<span style="color: black">Name</span>)
<span style="color: blue">GO</span></pre>
<p><strong>Step 4:</strong> Create a temp table to map surrogate keys. Populate this table by joining the natural keys.</p>
<pre><span style="color: blue">DROP</span> <span style="color: blue">TABLE</span> #<span style="color: black">DrugClassMap</span>
<span style="color: blue">GO</span>

<span style="color: blue">SELECT</span> <span style="color: black">s</span>.<span style="color: black">DrugClassId</span> <span style="color: blue">as</span> <span style="color: black">SourceDrugClassId</span>, <span style="color: black">t</span>.<span style="color: black">DrugClassId</span> <span style="color: blue">as</span> <span style="color: black">TargetDrugClassId</span>
  <span style="color: blue">INTO</span> #<span style="color: black">DrugClassMap</span>
  <span style="color: blue">FROM</span> [<span style="color: black">Prod</span>].<span style="color: black">dbo</span>.[<span style="color: black">DrugClass</span>] <span style="color: black">s</span>
  <span style="color: blue">JOIN</span> [<span style="color: black">Dev</span>].<span style="color: black">dbo</span>.[<span style="color: black">DrugClass</span>] <span style="color: black">t</span> <span style="color: blue">ON</span> <span style="color: black">s</span>.<span style="color: black">Name</span> = <span style="color: black">t</span>.<span style="color: black">Name</span>
<span style="color: blue">GO</span></pre>
<p><strong>Step 5:</strong> Use the temp table to import related tables. Join to the source table by source ID, and insert by target ID.</p>
<pre><span style="color: blue">INSERT</span> <span style="color: blue">INTO</span> [<span style="color: black">Dev</span>].<span style="color: black">dbo</span>.[<span style="color: black">ProductGroup</span>]
           ([<span style="color: black">DrugClassId</span>]
           ,[<span style="color: black">Name</span>])
<span style="color: blue">SELECT</span> <span style="color: black">m</span>.[<span style="color: black">TargetDrugClassId</span>]
      ,<span style="color: black">s</span>.[<span style="color: black">Name</span>]
  <span style="color: blue">FROM</span> [<span style="color: black">Prod</span>].<span style="color: black">dbo</span>.[<span style="color: black">ProductGroup</span>] <span style="color: black">s</span>
  <span style="color: blue">JOIN</span> #<span style="color: black">DrugClassMap</span> <span style="color: black">m</span> <span style="color: blue">ON</span> <span style="color: black">m</span>.<span style="color: black">SourceDrugClassId</span> = <span style="color: black">s</span>.<span style="color: black">DrugClassId</span>
  <span style="color: blue">WHERE</span> <span style="color: silver">NOT</span> <span style="color: silver">EXISTS</span> (<span style="color: blue">SELECT</span> * <span style="color: blue">FROM</span> [<span style="color: black">Dev</span>].<span style="color: black">dbo</span>.[<span style="color: black">ProductGroup</span>] <span style="color: black">t</span> <span style="color: blue">WHERE</span> <span style="color: black">t</span>.<span style="color: black">Name</span> = <span style="color: black">s</span>.<span style="color: black">Name</span> <span style="color: blue">AND</span> <span style="color: black">t</span>.<span style="color: black">DrugClassId</span> = <span style="color: black">m</span>.<span style="color: black">TargetDrugClassId</span>)
<span style="color: blue">GO</span></pre>
<p>Now you can run the script anytime you need to import data. You won’t destroy existing data in the process.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="indexfaa1.html?p=488#respond" title="Comment on Map IDs during data import">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-443"><a href="indexe0b1.html?p=443" rel="bookmark" title="Permanent Link to Table as queue">Table as queue</a></h3>
				<small>Wednesday, September 30th, 2009</small>

				<div class="entry">
					<p>To play along at home, please download the <a href="wp-content/uploads/2009/09/queues.mp3" title="queues.sql">script</a> for SQL Server 2005. It may work on earlier versions, but I haven't tried it.</p>
<p>Yesterday I said that <a href="index6c6e.html?p=442">the data is the queue</a>. It is a mistake to separate the processing of data from the data itself. I proposed an architecture in which there is no workflow orchestration, there are only autonomous worker processes. These processes pick up work based on attributes of the objects on which they act, not based on any external queue.</p>
<p>There are a small number of database patterns that make this possible. One that I often use is Table as Queue.</p>
<p><strong>Setup a test environment</strong><br />
I created a test database called "Queues" to test this pattern. You can find the script attached. As it is now, this script is incorrect. We will correct it as we go along.</p>
<p>The database has two tables. The Order table holds orders that we want to process. If the order hasn't been processed, it has no confirmation number. If it has, it does. The Log table holds a log of all the steps the order processor has gone through. This will help us see how well we are doing.</p>
<p>There are three stored procedures that we'll use. The InsertLoop stored procedure generates some test data. Run this one first. The ProcessLoop stored procedure simulates the ERP process. You'll want to open two query windows and enter "EXEC ProcessLoop" in both of them. Finally, the ViewLog procedure lets us see how we did.</p>
<p><strong>Anatomy of a queue procedure</strong><br />
The ProcessLoop stored procedure begins by selecting one order to process. It returns only the ID of this order.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order]
	WHERE ConfirmationNumber IS NULL)</pre>
<p>This ID has to be the primary key of the table. This is necessary for correct queuing behavior. If it is not the primary key, we will not get the correct locks later.</p>
<p>To process the order, other details about that record will be required. These should be fetched separately by the returned ID. Do not try to combine these steps.</p>
<p><strong>Default isolation level</strong><br />
Right now, the ProcessLoop stored procedure uses the default transaction isolation level (read committed). It starts a transaction, gets an order from the queue, processes it, and updates the confirmation number.</p>
<p>Hit F5 on both of your ProcessLoop query windows. While this is running, run ViewLog. You'll see something like this:</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">89</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 12:51:18.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:18.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.163</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">89</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.337</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:19.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:19.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 12:51:20.663</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">90</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 12:51:20.837</td>
</tr>
</table>
<p>Both of the SPIDs are processing all of the orders. This is clearly not what we want. We want only one SPID to process each order.</p>
<p><strong>Higher isolation level</strong><br />
The other process is able to sneak in between the SELECT and the UPDATE and perform an UPDATE of its own. We want to ensure that the row that the process UPDATEs is the same version it SELECTed. The way to do this is to raise the isolation level to REPEATABLE READ. As the name implies, it ensures that two SELECTs within the same transaction will read the same data. What it also means is that an UPDATE in the same transaction will update the same version of the row. No intermediate UPDATEs will be allowed.</p>
<p>Make the following change to the ProcessLoop procedure:</p>
<pre>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ</pre>
<p>Then start the two ProcessLoops again. Before long you will get the error "Transaction (Process ID 53) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction." The other process will still be running.</p>
<p>Kill the remaining process. Close the window so that you can commit the transactions that got left open. Then open a new window and type "EXEC ProcessLoop" again to prepare for the next step.</p>
<p>If you look at the log, you'll see only one of the SPIDs represented. The logs from the other one were rolled back with its transaction.</p>
<p>What happened is that both SPIDs SELECTed the same record. The first one UPDATEd it, which prevented the second from doing so. When it tried to UPDATE, SQL recognized the deadlock and rolled it back.</p>
<p><strong>Update lock</strong><br />
What we want to do is lock the record so that the first one to SELECT it is the one to process it. We'll do this by escalating our read lock to an update lock.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] <strong>WITH (UPDLOCK)</strong>
	WHERE ConfirmationNumber IS NULL)</pre>
<p>Now run the two processes and see what happens.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">138</td>
<td class="xl65" style="width: 66pt" width="80">Processing</td>
<td class="xl65" style="width: 31pt" width="41">52</td>
<td class="xl65" style="width: 132pt" width="166">2009-09-29 14:05:26.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">138</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:27.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">139</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:28.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.173</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" width="55" height="20">140</td>
<td class="xl65" width="80">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:05:29.377</td>
</tr>
</table>
<p>At first glance this looks good. Each order is processed by just one SPID. But look closely at the times. The two processes are taking turns. Each one enters SELECT, but then waits for the other one to commit its transaction before SELECT returns.</p>
<p>Since we've requested an update lock, the higher transaction isolation level makes no difference. We can turn it back down to the default.</p>
<p><strong>Read past</strong><br />
We want each process to skip over locked rows. We do this by specifying the READPAST query hint.</p>
<pre>-- Get a work item
SET @orderId =
  (SELECT TOP <span style="color: maroon">1</span>
	OrderId
	FROM [Order] WITH (UPDLOCK, <strong>READPAST</strong>)
	WHERE ConfirmationNumber IS NULL)</pre>
<p>With this hint in place, we get some good behavior.</p>
<table style="width: 258pt; border-collapse: collapse" border="0" cellpadding="0" cellspacing="0" width="344">
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="55" height="20">OrderID</td>
<td class="xl65" style="width: 66pt" width="80">Action</td>
<td class="xl65" style="width: 31pt" width="41">SPID</td>
<td class="xl65" style="width: 132pt" width="166">Date/Time</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="width: 29pt; height: 15pt" width="39" height="20">583</td>
<td class="xl65" style="width: 66pt" width="88">Processing</td>
<td class="xl65" style="width: 31pt" width="41">53</td>
<td class="xl65" style="width: 132pt" width="176">2009-09-29 14:37:21.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Processing</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:22.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Updating</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">583</td>
<td class="xl65">Finished</td>
<td class="xl65">53</td>
<td class="xl65">2009-09-29 14:37:22.740</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Updating</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
<tr style="height: 15pt" height="20">
<td class="xl65" style="height: 15pt" height="20">584</td>
<td class="xl65">Finished</td>
<td class="xl65">52</td>
<td class="xl65">2009-09-29 14:37:23.020</td>
</tr>
</table>
<p>Now the two processes are running concurrently. Each order is handled by only one process. There are no deadlocks.</p>
<p>With this pattern, the data itself can be used as a queue. But you have to remember the details:</p>
<ul>
<li>SELECT TOP 1 just the primary key of the queue table.</li>
<li>Use both the UPDLOCK and READPAST query hints on the SELECT.</li>
<li>Fetch additional information by ID in a separate query.</li>
<li>After operating on the data, update the record to exclude it from the original WHERE clause.</li>
<li>Perform both the SELECT and the UPDATE within the same transaction.</li>
</ul>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb0b7.html?cat=6" title="View all posts in Patterns" rel="category">Patterns</a> |   <a href="indexe0b1.html?p=443#respond" title="Comment on Table as queue">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-368"><a href="index5ee4.html?p=368" rel="bookmark" title="Permanent Link to SQL injection attack via email address">SQL injection attack via email address</a></h3>
				<small>Thursday, May 28th, 2009</small>

				<div class="entry">
					<p>Here's a perfect example of the wrong way to defend against SQL injection attacks.</p>
<p>I am trying to obtain a license for <a href="http://www.ndepend.com/NDependDownload.aspx">NDepend</a> for use in my open source project Update Controls. Their download form asks for an email address. So I provided the email address I use for that project. The form didn't like it:</p>
<p align="center"><a href="wp-content/uploads/2009/05/sqlinjection.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="78" alt="SQLinjection" src="wp-content/uploads/2009/05/sqlinjection-thumb.png" width="521" border="0"></a></p>
<p><a href="http://xkcd.com/327/">XKCD</a> warns us to "sanitize our database inputs". That is completely wrong. Honor the user's input, but treat it as text, not code.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index5ee4.html?p=368#comments" title="Comment on SQL injection attack via email address">2 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-362"><a href="indexe4db.html?p=362" rel="bookmark" title="Permanent Link to Queries are dependent; records are independent">Queries are dependent; records are independent</a></h3>
				<small>Tuesday, May 26th, 2009</small>

				<div class="entry">
					<p>I just requested a change to a use case that will save the project two man-weeks.</p>
<p><strong>eCommerce users and accounts</strong><br />In the ABSG eCommerce system, a user shops on behalf of an account. Some users can shop on behalf of more than one account, so they get to choose at the beginning of their shopping experience. We populate their list of choices from all of the accounts to which they have access.</p>
<p>Employees of ABSG log on to the eCommerce system to help people. Some of these employees are sales representatives for certain accounts. Every account as one sales rep.</p>
<p>Not all users are employees, and not all employees are users. We enter an employee ID in the user profile to relate the two.</p>
<p><strong>The UserAccount table</strong><br /><a href="wp-content/uploads/2009/05/useraccountaccesserd.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="248" alt="UserAccountAccessERD" src="wp-content/uploads/2009/05/useraccountaccesserd-thumb.png" width="441" align="right" border="0"></a> We have an associative table that relates users with the accounts that they have access to. This is the table that we use to present the list of choices at the beginning of the user's shopping experience.</p>
<p>I'm sure at one point the BA asked me how a user is granted access to an account. I told her about the UserAccount table. It was probably that conversation that led to the Automatic Account Access use case.</p>
<p><strong>Automatic account access</strong><br />Use case 1019: Automatic Account Access stated that the system shall periodically check for changes:</p>
<ul>
<li>An account is created or deleted.</li>
<li>A user is created or deleted.</li>
<li>The sales representative for an account is changed to a different employee.</li>
<li>The employee ID of a user is changed.</li>
</ul>
<p>When one of these changes happens, it will:</p>
<ul>
<li>Identify the sales rep user for each affected account.</li>
<li>If there is no existing UserAccount record for that sales rep, insert it.</li>
<li>If there is an existing UserAccount record for a prior sales rep, delete it.</li>
</ul>
<p>This to be accomplished via an impressive combination of replication, triggers, and cursors.</p>
<p><strong>The problems</strong><br />There are a number of problems with this approach.</p>
<ul>
<li>It would take a DBA a couple of weeks to build and test it.</li>
<li>Testing cannot be easily automated.</li>
<li>It has too many moving parts (a.k.a. degrees of freedom), each one of which would have to be monitored.</li>
<li>It is difficult to determine whether a UserAccount record was created automatically or intentionally. We could either delete UserAccount records that a human created, or fail to delete UserAccount records that a program created.</li>
<li>It does not take effect immediately. People could be diagnosing a failure of the system, only to learn that the process hasn't yet run.</li>
</ul>
<p>These are all symptomatic problems. Each one could be addressed individually. But here are the two big systemic problems:</p>
<ul>
<li>The use case dictated a solution.</li>
<li>The solution treated dependent behavior as independent behavior.</li>
</ul>
<p><strong>Here's my solution</strong><br />Use case 1019 has been deleted, and replaced with a single business rule in use case 1020: User Account Selection. This rule reads "A user may select any account for which their employee ID matches the accounts sales representative employee ID." No mention of how this is accomplished. That solves one problem.</p>
<p>To solve the other, we simply change the query that fetches the list of accounts at the beginning of the shopping experience. Instead of just getting UserAccount records, we also include accounts where account.SalesRepEmployeeID = user.EmployeeID. One small change to a query, instead of a rats nest of triggers.</p>
<p>The basic flaw in the Rube Goldberg reasoning that produced the original design was that it treated dependent behavior (which accounts the user could select) as independent behavior (UserAccount records). Changes to independent behavior (INSERTs, UPDATEs, and DELETEs) are permanent. Changes to dependent behavior (SELECTs) are not. It is therefore harder to code, test, monitor, and troubleshoot independent behavior. It is easier to do all of those things with dependent behavior.</p>
<p>Records are independent. Queries are dependent. Never use independent behavior when dependent behavior is sufficient.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="index2d79.html?cat=26" title="View all posts in dof" rel="category">dof</a> |   <a href="indexe4db.html?p=362#respond" title="Comment on Queries are dependent; records are independent">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-333"><a href="indexf604.html?p=333" rel="bookmark" title="Permanent Link to Returning the autoincrement ID of the last row inserted">Returning the autoincrement ID of the last row inserted</a></h3>
				<small>Friday, April 17th, 2009</small>

				<div class="entry">
					<p>It's a common scenario. You've defined an autoincrement primary key on a table. After you insert a row into this table, you need the ID. Maybe you need to insert related rows into a child table. Maybe you need to redirect the user to a page displaying the new data. It's easy to imagine reasons for needing this ID. In fact, it's hard to imagine <em>not</em> needing it.</p>
<p>Why, then, is it so hard to get it?</p>
<p>Well, now it's easy add this class to your project:</p>
<pre>using System;
using System.Data;

namespace AdventuresInSoftware.Data
{
    <span style="color: green">/// &lt;summary&gt;</span>
    <span style="color: green">/// Create a ConnectionScope inside of a using to open and close a</span>
    <span style="color: green">/// database connection. Also offers a convenient LastId method.</span>
    <span style="color: green">/// &lt;/summary&gt;</span>
    <span style="color: blue">public</span> <span style="color: blue">class</span> ConnectionScope : IDisposable
    {
        <span style="color: blue">private</span> IDbConnection _connection;

        <span style="color: green">/// &lt;summary&gt;</span>
        <span style="color: green">/// Wrap a database connection inside of a ConnectionScope in</span>
        <span style="color: green">/// a using statement.</span>
        <span style="color: green">/// &lt;/summary&gt;</span>
        <span style="color: green">/// &lt;param name="connection"&gt;The connection to open and close.&lt;/param&gt;</span>
        <span style="color: blue">public</span> ConnectionScope(IDbConnection connection)
        {
            _connection = connection;
            connection.Open();
        }

        <span style="color: green">/// &lt;summary&gt;</span>
        <span style="color: green">/// Get the autoincrement key generated by the last insert.</span>
        <span style="color: green">/// &lt;/summary&gt;</span>
        <span style="color: green">/// &lt;returns&gt;The ID of the last row inserted.&lt;/returns&gt;</span>
        <span style="color: blue">public</span> <span style="color: blue">int</span> LastId()
        {
            using (IDbCommand command = _connection.CreateCommand())
            {
                command.CommandText = <span style="color: maroon">"SELECT @@IDENTITY"</span>;
                command.CommandType = CommandType.Text;
                <span style="color: blue">return</span> (<span style="color: blue">int</span>)(decimal)command.ExecuteScalar();
            }
        }

        <span style="color: green">/// &lt;summary&gt;</span>
        <span style="color: green">/// Closes the connection. Intended to be called automatically</span>
        <span style="color: green">/// by the using statement.</span>
        <span style="color: green">/// &lt;/summary&gt;</span>
        <span style="color: blue">public</span> <span style="color: blue">void</span> Dispose()
        {
            _connection.Close();
        }
    }
}</pre>
<p>Then write code like this:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">int</span> SaveVendor(string vendorName)
{
    VendorTableAdapter vendorTableAdapter = <span style="color: blue">new</span> VendorTableAdapter();
    using (var scope = <span style="color: blue">new</span> ConnectionScope(vendorTableAdapter.Connection))
    {
        <span style="color: green">// Insert the vendor and return the new ID.</span>
        vendorTableAdapter.Insert(vendorName);
        <span style="color: blue">return</span> scope.LastId();
    }
}</pre>
<p>As you can see, the above code uses a typed TableAdapter. This is a convenient class generated by ADO .NET to give you strongly typed objects and methods for accessing tables. TableAdapters have been largely obsoleted by ORMs and Entity Framework, but they are still handy for smaller client-side projects. This code is from a smart-client project built on SQL CE.</p>
<p>A typed TableAdapter has a method called Insert which returns an integer. Oh boy! It must be returning the ID of the new row! After all, what else could I possibly want out of an Insert?</p>
<p>No, sorry. Insert returns a row count. That's right. The Insert method, which inserts a row, returns a row count.</p>
<p>Let me say that again. This method who's only reason for existing is to <strong>insert <em>one</em> row</strong> returns the number of rows it inserted. Did you get that? It always returns the number 1! By design!</p>
<p>Inane, yes, I know. But there it is. Enjoy.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index8e7f.html?cat=19" title="View all posts in C#" rel="category">C#</a>,  <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="indexf604.html?p=333#respond" title="Comment on Returning the autoincrement ID of the last row inserted">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-316"><a href="index258b.html?p=316" rel="bookmark" title="Permanent Link to Business logic in the database">Business logic in the database</a></h3>
				<small>Friday, April 3rd, 2009</small>

				<div class="entry">
					<p>It's a common refrain among the DBAs that I've worked with. We talk about a new feature, and they describe how it can be done in the database. They could write a stored procedure, a calculated column, a view, and a series of triggers to get exactly the behavior required. Their toolset is not limited to tables and indexes. They want to do more than just storage.</p>
<p>I respect that. I see what databases are capable of, and I want to take advantage of those capabilities where appropriate. On the other hand, I sympathize with arguments about separation of concerns. View logic is in the view, business logic is in the middle tier, and data access logic is in the database. Putting view logic or business logic into the data tier leads to trouble.</p>
<p><strong>Calculating privileges</strong><br /><a href="wp-content/uploads/2009/04/privilegeerd.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="192" alt="PrivilegeERD" src="wp-content/uploads/2009/04/privilegeerd-thumb.png" width="244" align="right" border="0"></a> The business has asked for a rich security model for our eCommerce system. They've identified several privileges that map to features of the site. They want an admin user to create roles containing those privileges. The admin user can then assign those roles to other users of the system.</p>
<p>Occasionally, there will be a one-off privilege that you want to explicitly grant or deny to a user. So after assigning a user some roles, the admin should be able to specify overrides. The ERD appears on the right.</p>
<p>The UI for managing roles and privileges is somewhat complex. The admin user searches for a user, and is presented with a list of roles. The admin clicks checkboxes next to the roles to assign them to the user.</p>
<p>Then the admin can navigate to another page where they are presented with a list of privileges. A green icon indicates default privileges -- the privileges that are part of a role to which the user is assigned. A checkbox indicates whether the user is granted that privilege. If there are no overrides, the green icons and the checkboxes agree. By checking and unchecking the privileges, the admin can create overrides.</p>
<p>In more formal notation, here is the dependent behavior that interprets the tables.</p>
<ul>
<li>user_in_role(User u, Role r) = there exists UserRole ur where ur.user = u and ur.role = r</li>
<li>privilege_in_role(Privilege p, Role r) = there exists RolePrivilege rp where rp.privilege = p and rp.role = r</li>
<li>is_default_privilege(User u, Privilege p) = there exists Role r such that user_in_role(u, r) and privilege_in_role(p, r)</li>
<li>user_has_privilege(User u, Privilege p) =<br />there exists Override o such that o.user = u and o.privilege = p -&gt; o.isGranted<br />else -&gt; is_default_privilege(u, p)</li>
</ul>
<p>The green icon reflects is_default_privilege, and the checkbox reflects user_has_privilege.</p>
<p><strong>Calculating privileges in a view</strong><br />The DBA, upon seeing these requirements, designed a view that calculates privileges for a user. Each row is a privilege. One bit column indicates whether the privilege is a default for the user, and another indicates whether the privilege is granted to the user. Looking at the formal notation, you can see that SQL is a natural language in which to describe this behavior.</p>
<p>But what happens when the user checks a checkbox? We want to either create or delete an Override. If the application code consumes the view, why should it need to also know about this logic?</p>
<p>The DBA also took care of this. He created an INSTEAD-OF UPDATE trigger on the view. When user_has_privilege is updated, an Override is either created or deleted. Now all of the logic for interpreting this table structure is encapsulated in a view. The view is the contract with the database.</p>
<p><strong>Appropriate for our architecture?</strong><br />This solution would be appropriate for a two-tier application. The page could bind directly to the view. But we have chosen a three-tier architecture. Between the page and the database is application logic. This approach is less desirable when a middle-tier is available.</p>
<p>The view combines all of the information into one result set, which takes away the ability for the application tier to cache privileges. Privileges do not change, unless we deploy a new version of the code. So caching them indefinitely is appropriate. The combined result set is bigger than the source data that could change, so it is less efficient.</p>
<p>The view is not a complete contract. The application still needs the ability to create and delete roles as individual entities. While this view encapsulates some of the business logic, it cannot encapsulate all of it. It is a leaky abstraction.</p>
<p>What is your opinion? Is this a data access contract? Is it business logic? Or is it perhaps UI logic? Which tier should handle this behavior?</p>
				</div>

				<p class="postmetadata">Posted in <a href="index1cd2.html?cat=10" title="View all posts in Contracts" rel="category">Contracts</a>,  <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a> |   <a href="index258b.html?p=316#respond" title="Comment on Business logic in the database">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-311"><a href="index2e31.html?p=311" rel="bookmark" title="Permanent Link to The status anti-pattern">The status anti-pattern</a></h3>
				<small>Thursday, March 19th, 2009</small>

				<div class="entry">
					<p>State transition diagrams have their place. They are useful for interpreting limited sets of well-defined inputs: for example parsing text, recognizing mouse gestures, or negotiating network protocols. But state or status in the large is rigid, hard to synchronize, and information poor. History is much more useful.</p>
<p>Business objects tend to accrete status fields. In our eCommerce system, for example, we have a status on a shopping cart, a status on an order, and a status on a line item. Each status means something different. The word "status" means nothing without knowing what statuses are available and when they change.</p>
<p><a href="wp-content/uploads/2009/03/orderstatus.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="244" alt="OrderStatus" src="wp-content/uploads/2009/03/orderstatus-thumb.png" width="236" align="right" border="0"></a> Status can sometimes refer to several independent degrees of freedom simultaneously. An order can be invoiced, and it can be shipped. One does not necessarily happen before the other. In order to capture information accurately, we need a Cartesian product of statuses: neither invoiced nor shipped (confirmed), invoiced but not shipped (invoiced), shipped but not invoiced (shipped), and both invoiced and shipped (completed). Add a third degree of freedom, and the product explodes into an unmanageable mess.</p>
<p>Many status changes need to capture additional information. When an order is shipped, we need to store a tracking number. Since we have to capture this information anyway, we could just look at the tracking number field to see if it is populated, rather than checking the status. Keeping this information in two fields means that we have more degrees of freedom than the problem calls for, and therefore more validation and testing.</p>
<p><strong>An alternative: historic modeling</strong><br />Historic modeling is the practice of modeling object behavior based on its history, not its state. A historic modeling approach is to capture the historical events, and then determine the status. For example, invoicing an order is one event, and shipping is another. The status of the order is "confirmed" if neither of these events has been recorded, "completed" if both have, or "invoiced" or "shipped" if one exists but not the other.</p>
<p>Historical events carry information. The shipping event carries the tracking number, for example. This eliminates nullable fields by moving them away from the entity. And since the tracking number and shipped status cannot vary individually anymore, we have only the degrees of information that the problem demands.</p>
<p>The names of events tend to be much more informative than the word "status". Glancing at the data model, someone can see what events could happen with any given entity. If they only see the word "status", they don't have a clue.</p>
<p><strong>Status is dependent upon history</strong><br /><a href="wp-content/uploads/2009/03/ordererd.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="163" alt="OrderERD" src="wp-content/uploads/2009/03/ordererd-thumb.png" width="244" align="right" border="0"></a> To model this system historically, we would create three tables: Order, Invoice, and Shipment. We allow only inserts into these tables. No updates. No deletes. (Yes, we allow data to be archived, but application logic never deletes information.)</p>
<p>We determine the status of an order based on predicates. The order is "submitted" if neither an Invoice nor a Shipment exists. It is "invoiced" if an Invoice exists but no Shipment. It is "Shipped" if a Shipment exists but no Invoice. And it is "completed" if both exist. This status can be encoded in a view for easy reporting.</p>
<p>Capturing this information historically, we can easily make sense of the model. It can only change in the ways we expect it to change. For example, in order to transition the order from "submitted" to "shipped", we have to enter a tracking number. The database can translate historic events into status. Status is dependent behavior, and history is independent.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index2e31.html?p=311#respond" title="Comment on The status anti-pattern">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-306"><a href="indexf167.html?p=306" rel="bookmark" title="Permanent Link to Lookup tables should not be modeled as related entities in Entity Framework">Lookup tables should not be modeled as related entities in Entity Framework</a></h3>
				<small>Monday, March 16th, 2009</small>

				<div class="entry">
					<p><a href="wp-content/uploads/2009/03/orderstatusedmx.png"><img src="wp-content/uploads/2009/03/orderstatusedmx-thumb.png" style="border: 0px none " alt="OrderStatusEDMX" align="right" border="0" width="244" height="134" /></a> I am tracking the status of an order in an eCommerce system. In the database, I have a table called OrderStatus that lists all of the statuses that an order can be in. Lookup table like this are useful for populating combo-boxes and running reports. And a foreign key constraint on the status column ensures the status of each order is within the set.</p>
<p>But within code, the lookup table is not necessary. I created an enumeration for the status values. The IDs were well-known. I didn't care about the descriptions.</p>
<p>I brought both the Order entity and the OrderStatus entity into the EDMX. The Order entity so I could create orders, and the OrderStatus entity to populate a combo-box. Since the Order table has a foreign key constraint relating it to OrderStatus, Entity Framework created a relationship. This caused problems.</p>
<p>When inserting an Order, I needed to set its status. So I created an OrderStatus and set its ID:</p>
<pre>order.OrderStatus = <span style="color: blue">new</span> <font color="#2c92af">OrderStatus</font>() { OrderStatusId = <font color="#2c92af">OrderStatusEnum</font>.Submitted };</pre>
<p>Entity Framework did not see this as setting the foreign key. Instead, it saw this as inserting both an Order and an OrderStatus. The result was a uniqueness constraint violation. The correct way to do this is to query for the existing order status, and then set the reference in the new order.</p>
<pre><font color="#2c92af">OrderContainer</font> container = <span style="color: blue">new</span> <font color="#2c92af">OrderContainer</font>();
order.OrderStatus =
  container.OrderStatus
    .Where(s =&gt; s.OrderStatusId == (<span style="color: blue">byte</span>)<font color="#2c92af">OrderStatusEnum</font>.Submitted)
    .First();</pre>
<p>That just seems like too much work to set a foreign key in a row that I'm inserting. I decided instead to delete the relationship that EF had created between Order and OrderStatus. Upon doing so, I received this error validating the model.</p>
<blockquote><p>Foreign key constraint 'FK_Order_OrderStatus' from table Orders (OrderStatusId) to table OrderStatus (OrderStatusId):: Insufficient mapping: Foreign key must be mapped to some AssociationSet on the conceptual side.</p></blockquote>
<p>Entity Framework had pulled the foreign key constraint in from the database schema, and it needed to be mapped. I just deleted the association on the "conceptual side" (i.e. the EDMX designer surface) that represented that constraint.</p>
<p><strong>Here's my solution</strong><br />
I actually have three. First, I could go back to my database and delete the foreign key constraint. This would make EF happy, but it would also remove the extra check on order status. It would take away some information that could be used by reporting tools. The foreign key constraint is the correct model, relationally, and I did not want to violate that model to satisfy EF. So I didn't do it.</p>
<p>Next, I could move OrderStatus to its own EDMX. I took this approach on other parts of the system that had several lookup tables, creating one single Lookup.EDMX file for all of them. This would prevent EF from importing the related tables in the same context, and would prevent it from creating the relationship. This seemed a bit much in this case, since I didn't have any other lookups, so I didn't do it.</p>
<p>Finally, I could remove the imported foreign key constraint. This requires hand-editing the XML, since the model browser doesn't allow you to delete any of the constraints that it has imported. To edit the XML, right-click on the EDMX file in solution explorer, select "Open With..." and then "XML Editor".</p>
<p>Find the AssociationSet element that refers to the foreign key that's giving you trouble. I deleted this chunk of XML:</p>
<pre><span style="color: blue">&lt;</span><span style="color: maroon">AssociationSet</span> <span style="color: red">Name</span>="<span style="color: blue">FK_Order_OrderStatus</span>" <span style="color: red">Association</span>="<span style="color: blue">Order.Store.FK_Order_OrderStatus</span>"<span style="color: blue">&gt;</span>
  <span style="color: blue">&lt;</span><span style="color: maroon">End</span> <span style="color: red">Role</span>="<span style="color: blue">OrderStatus</span>" <span style="color: red">EntitySet</span>="<span style="color: blue">OrderStatus</span>" /<span style="color: blue">&gt;</span>
  <span style="color: blue">&lt;</span><span style="color: maroon">End</span> <span style="color: red">Role</span>="<span style="color: blue">Orders</span>" <span style="color: red">EntitySet</span>="<span style="color: blue">Orders</span>" /<span style="color: blue">&gt;</span>
<span style="color: blue">&lt;</span>/<span style="color: maroon">AssociationSet</span><span style="color: blue">&gt;</span></pre>
<p>After cleaning that up, my EDMX validated again. Finally, to set the foreign key myself, I added a scalar property and mapped it to the column in the table.</p>
<p>This is another case of the tool trying too hard to help you out. It can't tell based on the relational model that this is a lookup table, and that it is not supposed to insert rows. Entity Framework tries very hard to keep you from managing foreign keys yourself. But the database <em>is</em> relational, and you <em>do</em> need to know about constraints and foreign keys. You have to be incredibly forceful to get the tool to move out of your way and let you see the model as it truly is.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexe8fb.html?cat=39" title="View all posts in Entity Framework" rel="category">Entity Framework</a> |   <a href="indexf167.html?p=306#comments" title="Comment on Lookup tables should not be modeled as related entities in Entity Framework">4 Comments &#187;</a></p>

			</div>

		
		<div class="navigation">
			<div class="alignleft"><a href="index7d66.html?cat=7&amp;paged=2">&laquo; Previous Entries</a></div>
			<div class="alignright"></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 17 queries. 0.465 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?cat=7 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:12 GMT -->
</html>
