<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?p=485 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software  &raquo; Blog Archive   &raquo; Expression of Intent</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="widecolumn">

	
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="index4c50.html?p=484">Ignite video online</a></div>
			<div class="alignright"><a href="index2807.html?p=486">A better Ignite Dallas video</a> &raquo;</div>
		</div>
		<br/>

		<div class="post" id="post-485">
			<h1>Expression of Intent</h1>

			<div class="entry">
				<p>This weekend I worked on the <a href="http://historicmodeling.com/book/factual" target="_blank">Factual</a> language parser. I started with a brute-force recursive descent parser, but ended up with something more elegant. The final product expresses the intent better than the original code did. It is easier to maintain, and easier to extend. You can follow along with the <a href="http://correspondence.codeplex.com/SourceControl/list/changesets">changesets on Codeplex</a>. Here’s how I did it.</p>
<p><strong>Step 1: Make it work</strong>     <br />The goal was to create a parser for a known language. It was not to create a framework for any language that you could throw at it. My constraints were well defined:</p>
<ul>
<li>Parse the Factual language </li>
<li>Produce an Abstract Syntax Tree </li>
<li>Work within an open source license </li>
</ul>
<p>These constraints defined my solution. Since I am working on an open source project, I did not want to take a dependency upon a proprietary parser generator. And since I knew the language that I was parsing, I was able to choose parser patterns that fit that language.</p>
<p>It would be foolish to take on this project without knowing the theory of compiler design. I have seen too many ad-hoc parsers created by people who did not do their research. The mistakes that they made could have easily been avoided. “Make it work” does not mean throwing together the simplest thing that would work. It means think it through, but go straight at the problem. Persistence is no substitute for understanding.</p>
<p>Knowing the theory, I knew that my language as defined was LL(4). It is unambiguous with a lookahead of only 4 tokens. I also knew that with a slight modification, I could transform it into an LL(1) grammar. This kind of grammar is easily parsable using recursive descent.</p>
<p>I started with this unit test:</p>
<pre>[<span style="color: #2b91af">TestMethod</span>]
<span style="color: blue">public</span> <span style="color: blue">void</span> WhenNamespaceHasNoDot_NamepaceIsRecognized()
{
    <span style="color: #2b91af">Parser</span> parser = <span style="color: blue">new</span> <span style="color: #2b91af">Parser</span>(<span style="color: blue">new</span> <span style="color: #2b91af">StringReader</span>(<span style="color: maroon">&quot;namespace GameModel;&quot;</span>));
    <span style="color: #2b91af">Namespace</span> result = parser.Parse();
    <span style="color: #2b91af">Pred</span>.Assert(result.Identifier, <span style="color: #2b91af">Is</span>.EqualTo(<span style="color: maroon">&quot;GameModel&quot;</span>));
    <span style="color: #2b91af">Pred</span>.Assert(result.LineNumber, <span style="color: #2b91af">Is</span>.EqualTo(<span style="color: maroon">1</span>));
}</pre>
<p>I did not write this code, as some proponents of TDD would recommend:</p>
<pre><span style="color: blue">public</span> <span style="color: #2b91af">Namespace</span> Parse()
{
    <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">Namespace</span>(<span style="color: maroon">&quot;GameModel&quot;</span>, <span style="color: maroon">1</span>);
}</pre>
<p>Instead, I wrote this:</p>
<pre><span style="color: blue">public</span> <span style="color: #2b91af">Namespace</span> Parse()
{
    <span style="color: #2b91af">Consume</span>();
    <span style="color: #2b91af">Namespace</span> namespaceNode = MatchNamespace();
    <span style="color: blue">return</span> namespaceNode;
}

<span style="color: blue">private</span> <span style="color: #2b91af">Namespace</span> MatchNamespace()
{
    <span style="color: #2b91af">Token</span> namespaceToken = Expect(<span style="color: #2b91af">Symbol</span>.Namespace, <span style="color: maroon">&quot;Add a 'namespace' declaration.&quot;</span>);

    <span style="color: blue">if</span> (Lookahead.Symbol != <span style="color: #2b91af">Symbol</span>.Identifier)
        <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">FactualException</span>(<span style="color: maroon">&quot;Provide a dotted identifier for the namespace.&quot;</span>, <span style="color: #2b91af">Lookahead</span>.LineNumber);
    <span style="color: blue">string</span> namespaceIdentifier = MatchDottedIdentifier();

    Expect(<span style="color: #2b91af">Symbol</span>.Semicolon, <span style="color: maroon">&quot;Terminate the namespace declaration with a semicolon.&quot;</span>);

    <span style="color: blue">return</span> <span style="color: blue">new</span> <span style="color: #2b91af">Namespace</span>(namespaceIdentifier, namespaceToken.LineNumber);
}</pre>
<p>That first method would have made the test pass, but it represents none of the understanding of the problem space. I find it better to capture that understanding in code as soon as possible, rather than writing a foolish method that I will throw away later.</p>
<p>After getting it working, I had a suite of unit tests. Each subsequent step was performed while keeping that same test suite passing.</p>
<p><strong>Step 2: Clean up the working code</strong> </p>
<p>It bothered me that MatchNamespace knew that MatchDottedIdentifier expected an Identifier. So I did a quick refactoring to move that knowledge closer to the right place.</p>
<pre><span style="color: blue">private</span> <span style="color: #2b91af">Namespace</span> MatchNamespace()
{
    ...

    <span style="color: blue">if</span> (<strong>!StartOfDottedIdentifier()</strong>)
        <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">FactualException</span>(<span style="color: maroon">&quot;Provide a dotted identifier for the namespace.&quot;</span>, Lookahead.LineNumber);
    <span style="color: blue">string</span> namespaceIdentifier = MatchDottedIdentifier();

    ...
}

<span style="color: blue">private</span> <span style="color: blue">bool</span> StartOfDottedIdentifier()
{
    <span style="color: blue">return</span> Lookahead.Symbol == <span style="color: #2b91af">Symbol</span>.Identifier;
}

<span style="color: blue">private</span> <span style="color: blue">string</span> MatchDottedIdentifier()
{
    <span style="color: #2b91af">StringBuilder</span> result = <span style="color: blue">new</span> <span style="color: #2b91af">StringBuilder</span>();

    <span style="color: #2b91af">Token</span> idenifier = Expect(<span style="color: #2b91af">Symbol</span>.Identifier, <span style="color: maroon">&quot;Begin with an identifier.&quot;</span>);
    result.Append(idenifier.Value);

    ...
}</pre>
<p><strong>Step 3: Find the patterns</strong> </p>
<p>After cleaning the code in a similar way in several places, I noticed that there were Start and Match pairs for almost every rule. I compared this with my knowledge of parsers, and found that it is a valid generalization.</p>
<p>In an LL(1) grammar, you can calculate the First and Follow sets of every production. The First set is the set of tokens that could appear at the beginning of the production. The Follow set is the set that could appear after the production has been reduced. I recognized that Start represented the First set. The Follow set is useful for generating the First set (First includes Follow if the production could be empty), but was not strictly required for my grammar.</p>
<p>Having discovered that pattern, I extracted a common interface (actually an abstract base class).</p>
<pre><span style="color: blue">public</span> <span style="color: blue">abstract</span> <span style="color: blue">class</span> <span style="color: #2b91af">Rule</span>&lt;T&gt;
{
    <span style="color: blue">public</span> <span style="color: blue">abstract</span> <span style="color: blue">bool</span> Start(<span style="color: #2b91af">Symbol</span> symbol);
    <span style="color: blue">public</span> <span style="color: blue">abstract</span> T Match(<span style="color: #2b91af">TokenStream</span> tokenStream);
}</pre>
<p>I implemented this interface with one derived class per production.</p>
<p><strong>Step 4: Find the common intent</strong> </p>
<p>Several of the rules had a common structure. They each called a sequence of other rules in turn. Each time, they would check the Start, and then call Match. This commonality was not accidental. Each of these rules intended to represent a sequence. They only differed in which sequence, and what was done with it. So I factored out that intent.</p>
<pre><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">RuleSequence3</span>&lt;<span style="color: #2b91af">T1</span>, <span style="color: #2b91af">T2</span>, <span style="color: #2b91af">T3</span>, <span style="color: #2b91af">T</span>&gt; : <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T</span>&gt;
{
    <span style="color: blue">private</span> <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T1</span>&gt; _rule1;
    <span style="color: blue">private</span> <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T2</span>&gt; _rule2;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _error2;
    <span style="color: blue">private</span> <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T3</span>&gt; _rule3;
    <span style="color: blue">private</span> <span style="color: blue">string</span> _error3;
    <span style="color: blue">private</span> <span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">T1</span>, <span style="color: #2b91af">T2</span>, <span style="color: #2b91af">T3</span>, <span style="color: #2b91af">T</span>&gt; _reduce;

    <span style="color: blue">public</span> <span style="color: #2b91af">RuleSequence3</span>(<span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T1</span>&gt; rule1, <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T2</span>&gt; rule2, <span style="color: blue">string</span> error2, <span style="color: #2b91af">Rule</span>&lt;<span style="color: #2b91af">T3</span>&gt; rule3, <span style="color: blue">string</span> error3, <span style="color: #2b91af">Func</span>&lt;<span style="color: #2b91af">T1</span>, <span style="color: #2b91af">T2</span>, <span style="color: #2b91af">T3</span>, <span style="color: #2b91af">T</span>&gt; reduce)
    {
        _rule1 = rule1;
        _rule2 = rule2;
        _error2 = error2;
        _rule3 = rule3;
        _error3 = error3;
        _reduce = reduce;
    }

    <span style="color: blue">public</span> <span style="color: blue">override</span> <span style="color: blue">bool</span> Start(<span style="color: #2b91af">Symbol</span> symbol)
    {
        <span style="color: blue">return</span> _rule1.Start(symbol);
    }

    <span style="color: blue">public</span> <span style="color: blue">override</span> <span style="color: #2b91af">T</span> Match(<span style="color: #2b91af">TokenStream</span> tokenStream)
    {
        <span style="color: #2b91af">T1</span> value1 = _rule1.Match(tokenStream);

        <span style="color: blue">if</span> (!_rule2.Start(tokenStream.Lookahead.Symbol))
            <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">FactualException</span>(_error2, tokenStream.Lookahead.LineNumber);
        <span style="color: #2b91af">T2</span> value2 = _rule2.Match(tokenStream);

        <span style="color: blue">if</span> (!_rule3.Start(tokenStream.Lookahead.Symbol))
            <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">FactualException</span>(_error3, tokenStream.Lookahead.LineNumber);
        <span style="color: #2b91af">T3</span> value3 = _rule3.Match(tokenStream);

        <span style="color: blue">return</span> _reduce(value1, value2, value3);
    }
}</pre>
<p><strong>Step 5: Express the intent<br />
    <br /></strong>Now that rules can be built from the outside rather than coded from within, I had the opportunity to create a fluent interface. The code that uses this interface expresses the grammar of the language, rather than the steps required to parse it. The resulting code reads like a specification rather than an implementation.</p>
<pre><span style="color: green">// dotted_identifier -&gt; identifier (&quot;.&quot; identifier)*</span>
<span style="color: green">// namespace_declaration -&gt; &quot;namespace&quot; dotted_identifier &quot;;&quot;</span>
var dottedIdentifier = Separated(
    Terminal(<span style="color: #2b91af">Symbol</span>.Identifier),
    <span style="color: #2b91af">Symbol</span>.Dot,
    identifier =&gt; <span style="color: blue">new</span> <span style="color: #2b91af">StringBuilder</span>().Append(identifier.Value),
    (stringBuilder, identifier) =&gt; stringBuilder.Append(<span style="color: maroon">&quot;.&quot;</span>).Append(identifier.Value));
var namespaceRule = Sequence(
    Terminal(<span style="color: #2b91af">Symbol</span>.Namespace),
    dottedIdentifier, <span style="color: maroon">&quot;Provide a dotted identifier for the namespace.&quot;</span>,
    Terminal(<span style="color: #2b91af">Symbol</span>.Semicolon), <span style="color: maroon">&quot;Terminate the namespace declaration with a semicolon.&quot;</span>,
    (namespaceToken, identifier, ignored) =&gt; <span style="color: blue">new</span> <span style="color: #2b91af">Namespace</span>(identifier.ToString(), namespaceToken.LineNumber));</pre>
<p>I find that this code is much easier to maintain and extend. The engineering of getting the parser right has been done once. Additional productions can take advantage of that engineering, so that simple mistakes are avoided. The goal was no reuse, but in the end I had created a reusable parser generator.</p>
<p>I might have been able to go straight there, but only at the risk of over engineering the solution. By refactoring my way from a working system toward an expression of intent, I was able to bring in just the theory that this particular problem requires. I know the limitations of my parser, and I can live within them.</p>

				
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on Monday, March 8th, 2010 at 12:30 pm						and is filed under <a href="index54cb.html?cat=23" title="View all posts in Processes" rel="category">Processes</a>.
						You can follow any responses to this entry through the <a href='index2386.html?feed=rss2&amp;p=485'>RSS 2.0</a> feed.

													You can skip to the end and leave a response. Pinging is currently not allowed.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->


			<!-- If comments are open, but there are no comments. -->

	 


<h3 id="respond">Leave a Reply</h3>

<p>You must be <a href="wp-login22ea.html?redirect_to=http://adventuresinsoftware.com/blog/?p=485">logged in</a> to post a comment.</p>


	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 21 queries. 0.300 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?p=485 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 12:55:52 GMT -->
</html>
