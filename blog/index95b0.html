<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">


<!-- Mirrored from adventuresinsoftware.com/blog/?cat=27&paged=2 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:03:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Adventures in Software   &raquo; Historic Modeling</title>

<meta name="generator" content="WordPress 2.3.3" /> <!-- leave this for stats -->

<link rel="stylesheet" href="wp-content/themes/ais2/style.css" type="text/css" media="screen" />
<link rel="alternate" type="application/rss+xml" title="Adventures in Software RSS Feed" href="indexd784.html?feed=rss2" />
<link rel="pingback" href="xmlrpc.html" />
    <script type="text/javascript">
        function onSilverlightError(sender, args) {
            var appSource = "";
            if (sender != null && sender != 0) {
              appSource = sender.getHost().Source;
            }
            
            var errorType = args.ErrorType;
            var iErrorCode = args.ErrorCode;

            if (errorType == "ImageError" || errorType == "MediaError") {
              return;
            }

            var errMsg = "Unhandled Error in Silverlight Application " +  appSource + "\n" ;

            errMsg += "Code: "+ iErrorCode + "    \n";
            errMsg += "Category: " + errorType + "       \n";
            errMsg += "Message: " + args.ErrorMessage + "     \n";

            if (errorType == "ParserError") {
                errMsg += "File: " + args.xamlFile + "     \n";
                errMsg += "Line: " + args.lineNumber + "     \n";
                errMsg += "Position: " + args.charPosition + "     \n";
            }
            else if (errorType == "RuntimeError") {           
                if (args.lineNumber != 0) {
                    errMsg += "Line: " + args.lineNumber + "     \n";
                    errMsg += "Position: " +  args.charPosition + "     \n";
                }
                errMsg += "MethodName: " + args.methodName + "     \n";
            }

            throw new Error(errMsg);
        }
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc0db0.php?rsd" />
 <link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes/wlwmanifest.xml" /> <style type='text/css'>
<!--#header { background: url('wp-content/themes/ais2/images/header-imgae03.html?upper=A7A73F&amp;lower=77773F') no-repeat bottom center; }
--></style>
</head>
<body>
<div id="page">

<div class="aisTopBar">
	<form method="get" id="searchform" action="http://adventuresinsoftware.com/blog/">
<div>
<a href="indexd784.html?feed=rss2"><img src="../images/feed-icon-28x28.png" border="0"></a>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>
</div>

<div class="aisHeaderImageRight">
	<div class="aisHeaderImage">
	<div class="aisHeaderCornerRight">
	<div class="aisHeaderCornerLeft">
	<div class="aisImageBar">
	<div class="aisSubSites">
		<a href="index.html" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			home</span></span></span></a>
		<a class="aisSubSiteLink" href="indexb60a.html?cat=27"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			historic modeling</span></span></span></a>
		<a class="aisSubSiteLink" href="indexa88f.html?cat=36"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			update controls</span></span></span></a>
		<a href="index2d79.html?cat=26" class="aisSubSiteLink"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			degrees of freedom</span></span></span></a>
		<a class="aisSubSiteLink" href="indexba53.html?page_id=2"><span class="aisSiteTabRight"><span class="aisSiteTabLeft"><span class="aisSiteTab">
			about us</span></span></span></a>

	</div>
	</div>
	</div>
	</div>
	</div>
</div>

<table style="width: 100%" cellspacing="0" cellpadding="0">
	<tr valign="top">
		<td width="210px">
<div id="sidebar">
<div class="aisLeftColumnFill">
<div class="aisLeftColumnBottom">
<div class="aisLeftColumnTop">
<div id="twitter_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Updates</h2>
<ul id="twitter_update_list"></ul>
<a href="http://twitter.com/michaellperry" id="follow">Follow me</a>
</div>
<div id="twitter_reply_div" class="aisLeftNav">
<h2 class="sidebar-title">Twitter Replies</h2>
<ul id="twitter_reply_list"></ul>
</div>

<div class="aisLeftNav">
<a href='http://ineta.org/Speakers/SearchCommunitySpeakers.aspx?SpeakerId=c5110e21-9243-461b-a464-a6548524e885'><img alt='INETA Community Speakers Program' border='0' src='../../www.ineta.org/images/OfficialLogos/InetaCommunitySpeakersRequestMe.html' /></a>
</div>

<div class="aisLeftNav">
	<li class="pagenav"><h2>Pages</h2><ul><li class="page_item page-item-2"><a href="indexba53.html?page_id=2" title="About Us">About Us</a></li>
<li class="page_item page-item-210"><a href="index6ae3.html?page_id=210" title="Templates">Templates</a></li>
</ul></li></div>

<div class="aisLeftNav">
<h2>Archives</h2>
<ul>
	<li><a href='indexb4d5.html?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='indexc61a.html?m=201106' title='June 2011'>June 2011</a></li>
	<li><a href='indexa80d.html?m=201105' title='May 2011'>May 2011</a></li>
	<li><a href='index512b.html?m=201104' title='April 2011'>April 2011</a></li>
	<li><a href='index08fb.html?m=201103' title='March 2011'>March 2011</a></li>
	<li><a href='index52f4.html?m=201102' title='February 2011'>February 2011</a></li>
	<li><a href='index74f1.html?m=201101' title='January 2011'>January 2011</a></li>
	<li><a href='index8956.html?m=201012' title='December 2010'>December 2010</a></li>
	<li><a href='indexa1aa.html?m=201011' title='November 2010'>November 2010</a></li>
	<li><a href='indexe3d5.html?m=201010' title='October 2010'>October 2010</a></li>
	<li><a href='index9ab9.html?m=201009' title='September 2010'>September 2010</a></li>
	<li><a href='index1ff0.html?m=201008' title='August 2010'>August 2010</a></li>
	<li><a href='index9f11.html?m=201007' title='July 2010'>July 2010</a></li>
	<li><a href='index31f0.html?m=201006' title='June 2010'>June 2010</a></li>
	<li><a href='indexd189.html?m=201005' title='May 2010'>May 2010</a></li>
	<li><a href='indexb5c0.html?m=201004' title='April 2010'>April 2010</a></li>
	<li><a href='indexf258.html?m=201003' title='March 2010'>March 2010</a></li>
	<li><a href='index6e30.html?m=201002' title='February 2010'>February 2010</a></li>
	<li><a href='index6b19.html?m=201001' title='January 2010'>January 2010</a></li>
	<li><a href='index5c0a.html?m=200912' title='December 2009'>December 2009</a></li>
	<li><a href='index8f62.html?m=200911' title='November 2009'>November 2009</a></li>
	<li><a href='index451d.html?m=200910' title='October 2009'>October 2009</a></li>
	<li><a href='index3e04.html?m=200909' title='September 2009'>September 2009</a></li>
	<li><a href='index425a.html?m=200908' title='August 2009'>August 2009</a></li>
	<li><a href='index9907.html?m=200907' title='July 2009'>July 2009</a></li>
	<li><a href='index3104.html?m=200906' title='June 2009'>June 2009</a></li>
	<li><a href='indexc36d.html?m=200905' title='May 2009'>May 2009</a></li>
	<li><a href='index17e8.html?m=200904' title='April 2009'>April 2009</a></li>
	<li><a href='index10a5.html?m=200903' title='March 2009'>March 2009</a></li>
	<li><a href='index8988.html?m=200902' title='February 2009'>February 2009</a></li>
	<li><a href='index1419.html?m=200901' title='January 2009'>January 2009</a></li>
	<li><a href='index7866.html?m=200812' title='December 2008'>December 2008</a></li>
	<li><a href='index55f6.html?m=200811' title='November 2008'>November 2008</a></li>
	<li><a href='indexa7bc.html?m=200810' title='October 2008'>October 2008</a></li>
	<li><a href='indexe77c.html?m=200809' title='September 2008'>September 2008</a></li>
	<li><a href='indexcffc.html?m=200808' title='August 2008'>August 2008</a></li>
	<li><a href='index0e62.html?m=200807' title='July 2008'>July 2008</a></li>
	<li><a href='indexfda7.html?m=200806' title='June 2008'>June 2008</a></li>
	<li><a href='index7d64.html?m=200805' title='May 2008'>May 2008</a></li>
	<li><a href='index94dd.html?m=200804' title='April 2008'>April 2008</a></li>
	<li><a href='index9631.html?m=200803' title='March 2008'>March 2008</a></li>
	<li><a href='indexdd52.html?m=200802' title='February 2008'>February 2008</a></li>
	<li><a href='index21ee.html?m=200801' title='January 2008'>January 2008</a></li>
	<li><a href='index363c.html?m=200712' title='December 2007'>December 2007</a></li>
	<li><a href='index7493.html?m=200711' title='November 2007'>November 2007</a></li>
	<li><a href='index93a7.html?m=200710' title='October 2007'>October 2007</a></li>
	<li><a href='index4ca8.html?m=200709' title='September 2007'>September 2007</a></li>
	<li><a href='index6124.html?m=200708' title='August 2007'>August 2007</a></li>
	<li><a href='index6013.html?m=200707' title='July 2007'>July 2007</a></li>
	<li><a href='index2ab6.html?m=200706' title='June 2007'>June 2007</a></li>
	<li><a href='index44f0.html?m=200705' title='May 2007'>May 2007</a></li>
	<li><a href='indexf0b4.html?m=200704' title='April 2007'>April 2007</a></li>
	<li><a href='index481d.html?m=200703' title='March 2007'>March 2007</a></li>
	<li><a href='indexcbea.html?m=200702' title='February 2007'>February 2007</a></li>
	<li><a href='index9cdc.html?m=200701' title='January 2007'>January 2007</a></li>
	<li><a href='index3ea4.html?m=200612' title='December 2006'>December 2006</a></li>
	<li><a href='index67ca.html?m=200611' title='November 2006'>November 2006</a></li>
	<li><a href='indexff49.html?m=200610' title='October 2006'>October 2006</a></li>
	<li><a href='index611c.html?m=200609' title='September 2006'>September 2006</a></li>
	<li><a href='index9a21.html?m=200608' title='August 2006'>August 2006</a></li>
	<li><a href='index3ee9.html?m=200607' title='July 2006'>July 2006</a></li>
	<li><a href='indexe13a.html?m=200606' title='June 2006'>June 2006</a></li>
</ul>
</div>

<div class="aisLeftNav">
	</div>

<div class="aisLeftNav">
<h2>Books</h2>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0764526413&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I5" id="I5"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0201633612&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I6" id="I6"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=0136291554&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I7" id="I7"></iframe>
<br/>
<iframe src="http://rcm.amazon.com/e/cm?t=adventures0d2-20&amp;o=1&amp;p=8&amp;l=as1&amp;asins=1888009195&amp;fc1=000000&amp;IS2=1&amp;lt1=_blank&amp;lc1=0000ff&amp;bc1=000000&amp;bg1=ffffff&amp;f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" name="I8" id="I8"></iframe>
</div>
<div class="aisLeftNav">
<h2>Meta</h2>
<ul>
		<li><a href="wp-login.html">Login</a></li>
	<li><a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional">Valid <abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a></li>
	<li><a href="http://gmpg.org/xfn/"><abbr title="XHTML Friends Network">XFN</abbr></a></li>
	<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress</a></li>
	</ul>
</div>
<div class="aisLeftContent">
<h2>Community</h2>
<ul>
	<script type="text/javascript" src="../../localhost/embed/92q2bbma.js"></script>
</ul>
</div>

</div></div></div>
</div>		</td>
		<td>

	<div id="content" class="narrowcolumn">

		
		 		<h2 class="pagetitle">Archive for the &#8216;Historic Modeling&#8217; Category</h2>

 	  

		<div class="navigation">
			<div class="alignleft"><a href="index6991.html?cat=27&amp;paged=3">&laquo; Previous Entries</a></div>
			<div class="alignright"><a href="indexb60a.html?cat=27">Next Entries &raquo;</a></div>
		</div>

				<div class="post">
				<h3 id="post-408"><a href="index43fc.html?p=408" rel="bookmark" title="Permanent Link to Greg Young on a solution to CRUD">Greg Young on a solution to CRUD</a></h3>
				<small>Thursday, July 30th, 2009</small>

				<div class="entry">
					<p>Greg Young gave a talk at QCon last year entitled <a title="http://www.infoq.com/presentations/greg-young-unshackle-qcon08" href="http://www.infoq.com/presentations/greg-young-unshackle-qcon08">Unshackle Your Domain</a>. In it, he offers a solution to <a href="index4efb.html?p=405">CRAPpy</a> -- sorry I mean CRUDdy -- services.</p>
<p>CRUD services expose a set of objects. A client gets an object (Read), makes changes to it, and puts it back (Update, or Alter). One big problem with CRUD is that it is not auditable. There is no record of the change. Sure, you can keep a parallel audit history, but if your system does not rely upon that history, how can you trust it?</p>
<p>Greg points out that accountants don't make changes to objects. They keep histories. They never Update (Alter) records, and they never Delete (Purge). Their work is completely auditable. Their legers have a running total, but that current state is always based on history. <strong>Changes, not objects, are the foundation of their domain.</strong></p>
<p><strong>Record changes, not state</strong><br />Greg proposes that a service can be modeled as a series of changes, rather than a collection of objects. In many domains, the set of changes is just as important as the set of objects. This is the only way to truly trust your audit log.</p>
<blockquote><p>State transitions are an important part of our problem space and should be modeled within our domain.<br /> - Greg Young</p>
</blockquote>
<p>In addition to making a system auditable, this solves a whole host of validation and consistency problems. For example, in a CRUD service, we would model a customer as:</p>
<pre><span style="color: blue">class</span> Customer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}</pre>
<p>As a domain object, it would have validation. For example, the City must be within the State. But what if the customer moves from Dallas, Texas to Tulsa, Oklahoma? There is no method to get us there in one step. We either have to transition through Tulsa, Texas or Dallas, Oklahoma. We have to allow our object to be in an invalid state.</p>
<p>More subtle is the FirstName/LastName pair. There is no validation here, but it is just as incorrect to change one without the other.</p>
<p>Now consider the CRUD operations:</p>
<pre>CreateCustomer(Customer c);
UpdateCustomer(Customer c);
DeleteCustomer(Customer c);
List&lt;Customer&gt; GetCustomersByCity(<span style="color: blue">string</span> city, <span style="color: blue">string</span> state);</pre>
<p>Suppose one client gets a customer and changes their name. At the same time, another client gets the same customer and changes their address. How does the server reconcile these two changes? There should be no conflict: the two clients performed two independent operations. But because we funnel all of the changes through UpdateCustomer, we cannot easily separate them.</p>
<p><strong>A change-oriented service model</strong><br />Greg proposes that the service should model the changes as first-class citizens. For example:</p>
<pre>change AddCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}

change RenameCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> FirstName;
  <span style="color: blue">string</span> LastName;
}

change MoveCustomer
{
  identity CustomerId;
  <span style="color: blue">string</span> City;
  <span style="color: blue">string</span> State;
}

change RemoveCustomer
{
  identity CustomerId;
}</pre>
<p>Each of these changes is a command object that is routed through the system. They are stored in a sequential log on the server. The current state of a customer is driven exclusively from this set of command objects. Since there is no other way to change a customer, the audit log can be trusted.</p>
<p><strong>Command/query separation</strong><br />A command changes the state of the system, and a query examines it.</p>
<p>Queries tend to be synchronous, since the server returns results. Some patterns such as AJAX perform queries asynchronously by providing a callback method to capture the results. Even so, the client is in a waiting state until the results are delivered, so the query is synchronous in essence if not in actual fact.</p>
<p>Commands tend to be asynchronous, since the server returns no results. The client only needs a guarantee that the server has received the command. Message queues are often used for commands.</p>
<p>A query can be retried with no ill effects. But this is not always true with a command. if a command is not idempotent, then we must ensure that it is executed once and only once.</p>
<p>Queries and commands are two very different things. Because they have different requirements, they should be handled with separate mechanisms. RPC-based systems, unfortunately, provide onlyl one mechanism for all messaging. There is no enforcement that queries have no side effects, or that commands return no results. As a consequence, queries and commands tend to be intermingled within a single RPC.</p>
<p>Greg proposes a different architecture. When commands are treated as first-class citizens, the separation between commands and queries is easy. Commands are sent to an audit log, and queries are processed out of a reporting database. Don't let the term <em>reporting database</em> confuse you; to Greg any query is a report.</p>
<p><a href="wp-content/uploads/2009/07/command-query.jpg"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="487" alt="command_query" src="wp-content/uploads/2009/07/command-query-thumb.jpg" width="596" border="0"></a> </p>
<p><strong>Eventual consistency</strong><br />The client workstation, the audit log, and the reporting database are three separate bounded contexts. Each has its own storage schema, its own transaction boundary, and its own interface. The three environments are isolated from one another. The only way for them to reach an agreement is for them to communicate.</p>
<p>Communication takes time. We must allow our distributed systems to be out-of-sync for that time. We cannot guarantee consistency across these bounded contexts at all times. The best we can do is to guarantee that they will become consistent eventually.</p>
<blockquote>
<p>Most bounded contexts can interact with relaxed consistency.<br /> - Greg Young</p>
</blockquote>
<p>It will take time for data to flow through the system. Sometimes that time is not important. But sometimes decisions must be made with the most up-to-date data possible. Only a domain expert can tell us the difference.</p>
<p>When we acknowledge the fact that communication takes time, we open up a whole new set of discussions with the domain experts. Now we can ask how long is too long. We can start defining service level agreements at the command level. And we can start measuring those times to see when the SLA is violated.</p>
<p>Don't take consistency as a given. Don't automatically define a CRUD service. Take the time to model the changes in your domain. Make those changes part of your discussion with the domain experts. Make them part of your solution.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index43fc.html?p=408#respond" title="Comment on Greg Young on a solution to CRUD">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-405"><a href="index4efb.html?p=405" rel="bookmark" title="Permanent Link to Alter and Purge">Alter and Purge</a></h3>
				<small>Tuesday, July 28th, 2009</small>

				<div class="entry">
					<p>You are aware of the CRUD operations:</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Update</li>
<li>Delete</li>
</ul>
<p>Two of these operations are perfectly safe. The other two are destructive.</p>
<p>When you update state, you destroy what used to be there. The old information is lost, overwritten with the new. An audit cannot see beyond the update into the past.</p>
<p>When you delete state, you destroy it outright. I'm referring to a hard delete. A soft delete does not destroy information. But a soft delete is not really a delete.</p>
<p><strong>Make things more explicit</strong><br />I propose new names for these last two operations, in order to emphasize their destructive nature. Instead of Update, let's call it <strong>Alter</strong>. An update sounds like your adding fresh data. What you are really doing is altering what was there.</p>
<p>Instead of Delete, let's call it <strong>Purge</strong>. When you purge something, it no longer exists. It's as if it never was. While you might confuse Delete with a soft delete, you cannot mistake the meaning of Purge.</p>
<p><strong>Auditability</strong><br />Armed with our new language, let's think about how to audit our systems. Can explain to your legal department how you are Altering records? Can you convince your IT staff that it's OK to Purge data? Don't use terms that sugar-coat the facts. Tell it like it is.</p>
<p><strong>Synchronization</strong><br />Discrete machines in a distributed system need to exchange information in order to keep each other up to date. If they have each Altered the same data, how do they know which is the correct version? How do they even know that there has been a conflict. The prior version upon which they both agreed is lost.</p>
<p>If one Purges data, should the other Purge it as well? Or should the first Create it again? How can they tell the difference?</p>
<p>Post an article in an RSS feed, then change it. See what happens to the feed aggregators. Create a contact in Outlook and then delete it from your iPhone. See if it goes away.</p>
<p>The data destroyed by Altering and Purging records is precisely the data required to synchronize discrete systems. Retain it.</p>
<ul>
<li>Create</li>
<li>Read</li>
<li>Alter</li>
<li>Purge</li>
</ul>
<p>I think that's more explicit.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index4efb.html?p=405#comments" title="Comment on Alter and Purge">2 Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-391"><a href="index64d4.html?p=391" rel="bookmark" title="Permanent Link to A kindergarten example of historic modeling">A kindergarten example of historic modeling</a></h3>
				<small>Tuesday, June 9th, 2009</small>

				<div class="entry">
					<p>Historic Modeling may be a new concept, but you are probably already familiar with a popular example.</p>
<p>A person is a fact. The person exists. Time may pass, and perhaps she'll die, but the fact that she existed will always be true.</p>
<p><a href="wp-content/uploads/2009/06/old-lady-1.png"><img src="wp-content/uploads/2009/06/old-lady-1-thumb.png" style="border: 0px none " alt="Old Lady 1" width="113" border="0" height="63" /></a></p>
<p>The same is true of an animal.</p>
<p><a href="wp-content/uploads/2009/06/old-lady-2.png"><img src="wp-content/uploads/2009/06/old-lady-2-thumb.png" style="border: 0px none " alt="Old Lady 2" width="236" border="0" height="63" /></a></p>
<p>A person might consume an animal. Usually the reason is sustenance, but we can't be sure. We can document the fact that a person swallowed an animal for a reason.</p>
<p><a href="wp-content/uploads/2009/06/old-lady-3.png"><img src="wp-content/uploads/2009/06/old-lady-3-thumb.png" style="border: 0px none " alt="Old Lady 3" width="364" border="0" height="159" /></a></p>
<p>Any of a number of reasons can be given. Maybe we just don't know. Or maybe the person swallowed the animal to catch an animal that they had previously swallowed. The fact that they swallowed an animal in the past is a prerequisite for the reason to swallow another. The prior swallow must come before the reason.</p>
<p><a href="wp-content/uploads/2009/06/old-lady-4.png"><img src="wp-content/uploads/2009/06/old-lady-4-thumb.png" style="border: 0px none " alt="Old Lady 4" width="483" border="0" height="255" /></a></p>
<p><strong>From model to instance</strong><br />
To demonstrate the model, let's create some instances of these facts.</p>
<ul>
<li>There was an old lady.</li>
<li>There was a fly.</li>
<li>There was an old lady who swallowed a fly. I don't know why she swallowed the fly.</li>
<li>There was an old lady who swallowed a spider. She swallowed the spider to catch the fly.</li>
</ul>
<p>Continuing in this manner, we construct a graph of fact instances.</p>
<p><img src="wp-content/uploads/2009/06/old-lady-5.png" alt="old-lady-5.png" /></p>
<p>This recitation of facts could go on. Until she dies, of course.</p>
				</div>

				<p class="postmetadata">Posted in <a href="index6c5d.html?cat=18" title="View all posts in Fun" rel="category">Fun</a>,  <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index64d4.html?p=391#respond" title="Comment on A kindergarten example of historic modeling">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-317"><a href="index4ef8.html?p=317" rel="bookmark" title="Permanent Link to Historic Modeling site launched">Historic Modeling site launched</a></h3>
				<small>Tuesday, April 7th, 2009</small>

				<div class="entry">
					<p>I've started a new site specifically about <a href="http://historicmodeling.com/">Historic Modeling</a>. The historic modeling content on AiS will remain here, but new content will be posted there. Adventures in Software will continue to be about lessons learned on the road to quality computing. Historic Modeling will be dedicated to the theory and practice of the technique, and the tools and processes I'm developing to support it.</p>
<p>The first series of posts is complete. It takes you step-by-step through the creation of a historic model. This example is drawn from real-life experience, and includes just enough complexity to demonstrate how the technique applies to real-world problems. Please enjoy.</p>
<ul>
<li><a href="http://historicmodeling.com/book/node/4">Step One: Identify Changes</a>
<li><a href="http://historicmodeling.com/book/node/5">Step Two: Refine Changes</a>
<li><a href="http://historicmodeling.com/book/node/6">Step Three: Query the Model</a>
<li><a href="http://historicmodeling.com/book/node/7">Step Four: Repeat</a> </li>
</ul>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index4ef8.html?p=317#comments" title="Comment on Historic Modeling site launched">1 Comment &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-311"><a href="index2e31.html?p=311" rel="bookmark" title="Permanent Link to The status anti-pattern">The status anti-pattern</a></h3>
				<small>Thursday, March 19th, 2009</small>

				<div class="entry">
					<p>State transition diagrams have their place. They are useful for interpreting limited sets of well-defined inputs: for example parsing text, recognizing mouse gestures, or negotiating network protocols. But state or status in the large is rigid, hard to synchronize, and information poor. History is much more useful.</p>
<p>Business objects tend to accrete status fields. In our eCommerce system, for example, we have a status on a shopping cart, a status on an order, and a status on a line item. Each status means something different. The word "status" means nothing without knowing what statuses are available and when they change.</p>
<p><a href="wp-content/uploads/2009/03/orderstatus.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="244" alt="OrderStatus" src="wp-content/uploads/2009/03/orderstatus-thumb.png" width="236" align="right" border="0"></a> Status can sometimes refer to several independent degrees of freedom simultaneously. An order can be invoiced, and it can be shipped. One does not necessarily happen before the other. In order to capture information accurately, we need a Cartesian product of statuses: neither invoiced nor shipped (confirmed), invoiced but not shipped (invoiced), shipped but not invoiced (shipped), and both invoiced and shipped (completed). Add a third degree of freedom, and the product explodes into an unmanageable mess.</p>
<p>Many status changes need to capture additional information. When an order is shipped, we need to store a tracking number. Since we have to capture this information anyway, we could just look at the tracking number field to see if it is populated, rather than checking the status. Keeping this information in two fields means that we have more degrees of freedom than the problem calls for, and therefore more validation and testing.</p>
<p><strong>An alternative: historic modeling</strong><br />Historic modeling is the practice of modeling object behavior based on its history, not its state. A historic modeling approach is to capture the historical events, and then determine the status. For example, invoicing an order is one event, and shipping is another. The status of the order is "confirmed" if neither of these events has been recorded, "completed" if both have, or "invoiced" or "shipped" if one exists but not the other.</p>
<p>Historical events carry information. The shipping event carries the tracking number, for example. This eliminates nullable fields by moving them away from the entity. And since the tracking number and shipped status cannot vary individually anymore, we have only the degrees of information that the problem demands.</p>
<p>The names of events tend to be much more informative than the word "status". Glancing at the data model, someone can see what events could happen with any given entity. If they only see the word "status", they don't have a clue.</p>
<p><strong>Status is dependent upon history</strong><br /><a href="wp-content/uploads/2009/03/ordererd.png"><img style="border-right: 0px; border-top: 0px; border-left: 0px; border-bottom: 0px" height="163" alt="OrderERD" src="wp-content/uploads/2009/03/ordererd-thumb.png" width="244" align="right" border="0"></a> To model this system historically, we would create three tables: Order, Invoice, and Shipment. We allow only inserts into these tables. No updates. No deletes. (Yes, we allow data to be archived, but application logic never deletes information.)</p>
<p>We determine the status of an order based on predicates. The order is "submitted" if neither an Invoice nor a Shipment exists. It is "invoiced" if an Invoice exists but no Shipment. It is "Shipped" if a Shipment exists but no Invoice. And it is "completed" if both exist. This status can be encoded in a view for easy reporting.</p>
<p>Capturing this information historically, we can easily make sense of the model. It can only change in the ways we expect it to change. For example, in order to transition the order from "submitted" to "shipped", we have to enter a tracking number. The database can translate historic events into status. Status is dependent behavior, and history is independent.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index2e31.html?p=311#respond" title="Comment on The status anti-pattern">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-280"><a href="index90dd.html?p=280" rel="bookmark" title="Permanent Link to Correspondence preview drop">Correspondence preview drop</a></h3>
				<small>Thursday, December 4th, 2008</small>

				<div class="entry">
					<p>It is with pride (and not a little fear) that I release a preview of Correspondence. Please <a href="../bin/bugtracker.zip">download</a> and follow along with the discussion.</p>
<p>The preview drop includes the bug tracker sample model that we've been building over the past month. It also includes a unit test that exercises that model using the Postgres storage strategy. I have not yet decided on a license model for the Correspondence library itself. As it is now, it is not yet suitable for production use. So the library is provided for demonstration purposes only, without warrantee, and without license for use in any product or derived work.</p>
<p>The contents of the zip file are an Eclipse project. My preferred distribution of Eclipse is <a href="http://eclipse.org/ganymede">Ganymede</a>, which is ideally suited to building web applications. If you are not an Eclipse user, you can port the project to your environment of choice. I have not included an Ant script, but feel free to do so if that's how you work.</p>
<p>You will have to install <a href="http://www.postgresql.org/">Postgres</a> to run the test. Please drop the postgresql jar file in the lib folder and update the reference in bugtracker_model_test. You will then need to run the correspondence.sql script to build the Correspondence database. I could have used the in-memory storage strategy, but I thought you would get more out of seeing an actual working database.</p>
<p>Please give this preview a try and let me know how it goes. This will allow us to continue the conversation about Correspondence by exchanging working source code. Enjoy!</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index90dd.html?p=280#respond" title="Comment on Correspondence preview drop">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-279"><a href="index45c8.html?p=279" rel="bookmark" title="Permanent Link to Correspondence storage strategy provider model">Correspondence storage strategy provider model</a></h3>
				<small>Sunday, November 30th, 2008</small>

				<div class="entry">
					<p>The Correspondence library synchronizes object models between memory and storage. Eventually, it will synchronize object models between machines. But for right now, let's talk about storage.</p>
<p>The storage mechanism for Correspondence is not relational. Correspondence is not an ORM. But it is sometimes useful to implement Correspondence storage on top of a relational container. For one thing, relational databases already exist and are easy to use. For another, Correspondence can interface with relational data. It would be beneficial to have one transactional boundary around both the Correspondence data and the relational data.</p>
<p>The storage mechanism used to persist Correspondence objects is isolated from the core library itself. This allows you to select the most appropriate storage mechanism for your application. A provider for storage implements the StorageStrategy interface. You select a storage strategy when you configure your Community.</p>
<p><strong>Mementos and IDs</strong><br />A StorageStrategy does not deal directly with CorrespondenceObjects. It is isolated from your code by dealing with Mementos. A Memento stores the immutable state of a Correspondence object. This includes the type name and version number, the predecessors, and the fields. Successors are not immutable, so they are not part of the Memento.</p>
<p>A Memento's size is strictly limited to 1024 bytes. If you create a CorrespondenceObject whose fields contain more than 1K of data, you have to break it up. This hard limit is there to protect the memory, storage, and network components. It prevents buffer overrun attacks, helps ensure scalability, and makes the system more performant.</p>
<p>A Memento calculates a hash code, which is used as a first check to see if two Correspondence objects are equal. Remember that a Correspondence object's identity relies upon its predecessors and fields. If these are the same, then it is the same object. A Memento contains only these identifying attributes, so its hash code is used for identity checks.</p>
<p>But the hash code itself is not sufficient. We know that a hash is not unique. So in addition, the StorageStrategy deals with ObjectIDs. An ObjectID is nothing more than a wrapper for a 64 bit integer. These integers are unique only within a given database. Since the Memento uses ObjectIDs, a Memento is also specific to a database. Mementos and ObjectIDs do not make sense in application code. In fact, unless you create your own StorageStrategy, you will only encounter the Memento type in the constructors of your objects. These constructors are used to load a Correspondence object from storage.</p>
<p><strong>The StorageStrategy interface</strong><br />The StorageStrategy interface has very few methods. The most interesting ones are described here:</p>
<pre><span style="color: blue">public</span> <span style="color: blue">interface</span> StorageStrategy {

	Memento load(ObjectID id) <span style="color: blue">throws</span> CorrespondenceException;
	ObjectID save(Memento memento) <span style="color: blue">throws</span> CorrespondenceException;
	ObjectID findExistingObject(Memento memento) <span style="color: blue">throws</span> CorrespondenceException;
	Iterable&lt;Pair&lt;ObjectID, Memento&gt;&gt; executeQuery(QueryDefinition queryDefinition, ObjectID id) <span style="color: blue">throws</span> CorrespondenceException;

}
</pre>
<p>The <strong>load</strong> and <strong>save</strong> methods are the workhorses of the strategy. Given an ObjectID, the strategy needs to load a Memento. Or given a Memento, it needs to save it and return its ObjectID. If a matching Memento is already in storage, the ObjectID of that Memento will be returned instead.</p>
<p>Like save, <strong>findExistingObject</strong> will return the ObjectID of a matching Memento. But unlike save, it will not store the Memento if it doesn't already exist. This method is used for getObject, whereas save is used for addObject.</p>
<p>The last method is the most interesting. A Query is a collection of joins. Each join is either to a successor or a predecessor. When a Query is observed, it calls <strong>executeQuery</strong> and sends its QueryDefinition to the storage strategy. The storage strategy returns the collection of objects that satisfy that query. The storage strategy is free to use whatever means necessary to execute the query, including dynamically generating SQL.</p>
<p><strong>Not relational</strong><br />It's pretty easy to see from this interface that Correspondence does not offer all of the features of a relational database. The only relationships allowed between objects are predecessor/successor relationships. And predecessors can't change. There is (currently) no arbitrary lookup by field, like you have with a relational query by column. Correspondence works by its own limited set of rules.</p>
<p>But that limitation is also a strength. Because relational databases have to deliver on so many difficult promises, they cannot synchronize as easily as a Correspondence model. The set of operations that Correspondence allows was specifically selected to make it easy to share data from memory, to storage, across the network, and with other users. It's a different programming model, but one that you will eventually come to find as natural as relational or OO.</p>
<p><strong>Existing and future storage strategies</strong><br />I currently have Correspondence libraries written in C# and Java. In the Java version, I have implemented the Postgres storage strategy. In .NET, I have implemented SQL Server, SQL CE, and Access. I also have an in-memory version in both platforms strictly for unit testing. In the future, I plan to support MySQL, and to port storage strategies between .NET and Java. In addition, I'll create stand-alone strategies based on flat files or memory-mapped files.</p>
<p>But for now, I'm releasing the Java version of Correspondence with the Postgres storage strategy. Check back later this week for a download and instructions.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexc728.html?cat=7" title="View all posts in Databases" rel="category">Databases</a>,  <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index45c8.html?p=279#respond" title="Comment on Correspondence storage strategy provider model">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-277"><a href="index9076.html?p=277" rel="bookmark" title="Permanent Link to The Correspondence Community">The Correspondence Community</a></h3>
				<small>Thursday, November 20th, 2008</small>

				<div class="entry">
					<p>Correspondence is about agreement. Every person, every application, every machine involved in the correspondence network comes to agree upon the history of the objects that they share. This set of people, applications, and machines is collectively known as the Community.</p>
<p><strong>The Community object</strong><br />In code, the Community is represented by a Community proxy object. This proxy is the center of all Correspondence operations. We've already seen the addObject method, which puts a Correspondence object into the system. Here's a complete list of methods:</p>
<ul>
<li>addObject(T prototype) : T {where T extends CorrespondenceObject}</li>
<li>getObject(T prototype) : T {where T extends CorrespondenceObject}</li>
<li>setModules(List&lt;Module&gt; modules)</li>
<li>addType(Class correspondenceObjectClass) : Community</li>
<li>addFieldSerializer(Class fieldType, FieldSerializer fieldSerializer) : Community</li>
</ul>
<p>The addObject method is by far the most used. It shares an object with the rest of the community. It places it in the database, attaches it to related objects (via queries), and sends it out over the network.</p>
<p>The addObject method takes a prototype. An object's predecessors and fields define its identity. So if an object matching the prototype is already in the Community, that existing object is returned. If no matching object is in the Community, the new object is added and returned.</p>
<p>The getObject method also takes a prototype and returns an object. The difference is that getObject will return null if the object is not currently in the Community. AddObject is used to express intent, whereas getObject is used just to look something up.</p>
<p><strong>Initializing the Community</strong><br />The other three fields are used to initialize the Community. SetModules assigns a list of Module objects. A Module is an interface with only one method: registerTypes. RegisterTypes takes the Community object and calls the other two methods: addType and addFieldSerializer. This pattern allows collections of Correspondence object types to be grouped together as reusable components.</p>
<p>The addType method registers a Correspondence object type with the Community. In order for addObject, getObject, and Query to work properly, a type must be registered with the Community. AddType is typically called from within a Module. This method returns the Community itself, so that it can be chained with other calls to addType.</p>
<p>The addFieldSerializer method is used less often. It registers a strategy object that reads and writes fields to binary streams. The common data types (int, float, string, date, UUID, etc.) are registered by default. You can define a custom data type, implement the FieldSerializer interface, and register it within a Module. Most of the time, however, the predefined field types are sufficient.</p>
<p><strong>The getCommunity method</strong><br />Every Correspondence object has direct access to its Community. Call the getCommunity method within a Correspondence object any time you want to perform an action. The typical pattern (as we've seen with mutable properties) is to call getCommunity().addObject( new ChildObject(this, more parameters)).</p>
<p>Adding an object to the Community causes it to be returned from relevant Queries. If that Query is used to get a list of children, then the object appears in that collection. If it is used to get the value of a mutable property, that new value appears. If it is used to cause the exists method to return false, the appropriate object is deleted. All of these changes take place automatically. Queries are dependent behavior; adding an object to the Community is independent behavior.</p>
<p><strong>Coming soon</strong><br />I realize that this is a lot of talk about code without being able to compile any of it. I'm getting the Java version of Correspondence ready to share with you. Within a week or two, you will be able to download a JAR file and sample code. The C# version is about a month behind. In the mean time, there is one last concept I'd like to present, so the next post will talk about the StorageStrategy interface.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index9076.html?p=277#respond" title="Comment on The Correspondence Community">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-276"><a href="index44be.html?p=276" rel="bookmark" title="Permanent Link to Coding mutable properties">Coding mutable properties</a></h3>
				<small>Wednesday, November 12th, 2008</small>

				<div class="entry">
					<p><a href="../../www.adventuresinsoftware.com/blog/wp-content/uploads/2008/10/image5.png"><img height="177" alt="image" src="../../www.adventuresinsoftware.com/blog/wp-content/uploads/2008/10/image-thumb3.png" width="244" align="right" border="0"></a>
<p>Fields in a Correspondence object are immutable. To represent a mutable property, you create a new object for each change. The object not only records the new value of the property, it also records the prior objects that it replaces. These become predecessors of the new object, and form a tree of version history. Only the leaves of the tree have not been replaced, and therefore contribute to the current value of the property.</p>
<p>This pattern requires five steps to code. You define:</p>
<ul>
<li>A <strong>class</strong> to represent the property.</li>
<li>A <strong>predecessor set</strong> to represent prior versions.</li>
<li>An <strong>exists method</strong> to hide prior versions.</li>
<li>A <strong>query</strong> to get the current version (or versions, in case of a conflict).</li>
<li><strong>Get and set</strong> methods.</li>
</ul>
<p>Let's walk through these five steps in the bug tracker example.</p>
<p><strong>The property class</strong><br />We want to add a mutable property to the Project class. This property will be the project name. We will therefore create a new class called <strong>ProjectName</strong>.</p>
<p>Every time the project name changes, an instance of ProjectName is created. One predecessor is, of course, the Project. In addition, ProjectName stores the name as a field.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> ProjectName <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: blue">private</span> PredecessorObj&lt;Project&gt; project;

	<span style="color: blue">private</span> @Field String name;

	<span style="color: blue">public</span> ProjectName(Project project, String name) {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, project);

		<span style="color: blue">this</span>.name = name;
	}

	<span style="color: blue">public</span> ProjectName(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, memento);
	}

	<span style="color: blue">public</span> String getName() {
		<span style="color: blue">return</span> name;
	}

}
</pre>
<p>Every time a ProjectName is created, we want to record the current knowledge about the project name. This helps us piece together the history and later determine which names were replaced by another. We add a predecessor set to record all prior ProjectNames. By convention, these predecessors use the role name "next".</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> ProjectName <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: blue">private</span> PredecessorObj&lt;Project&gt; project;
	<strong><span style="color: blue">private</span> PredecessorSet&lt;ProjectName&gt; prior;</strong>

	<span style="color: blue">private</span> @Field String name;

	<span style="color: blue">public</span> ProjectName(Project project, ObjectList&lt;ProjectName&gt; prior, String name) {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, project);
		<strong><span style="color: blue">this</span>.prior = <span style="color: blue">new</span> PredecessorSet&lt;ProjectName&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"next"</span>, prior);</strong>

		<span style="color: blue">this</span>.name = name;
	}

	<span style="color: blue">public</span> ProjectName(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, memento);
		<strong><span style="color: blue">this</span>.prior = <span style="color: blue">new</span> PredecessorSet&lt;ProjectName&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"next"</span>, memento);</strong>
	}

	<span style="color: blue">public</span> String getName() {
		<span style="color: blue">return</span> name;
	}

}
</pre>
<p><strong>The exists method</strong><br />A ProjectName replaces its predecessors. Those predecessors cease to exist. We add an exists method to ProjectName that returns true only when there are no successors. To find successors, we need a query.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> ProjectName <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: blue">private</span> PredecessorObj&lt;Project&gt; project;
	<span style="color: blue">private</span> PredecessorSet&lt;ProjectName&gt; prior;

	<strong><span style="color: blue">private</span> Query&lt;ProjectName&gt; next = <span style="color: blue">new</span> Query&lt;ProjectName&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"next"</span>);
</strong>
	<span style="color: blue">private</span> @Field String name;

	<span style="color: blue">public</span> ProjectName(Project project, ObjectList&lt;ProjectName&gt; prior, String name) {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, project);
		<span style="color: blue">this</span>.prior = <span style="color: blue">new</span> PredecessorSet&lt;ProjectName&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"next"</span>, prior);

		<span style="color: blue">this</span>.name = name;
	}

	<span style="color: blue">public</span> ProjectName(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_name"</span>, memento);
		<span style="color: blue">this</span>.prior = <span style="color: blue">new</span> PredecessorSet&lt;ProjectName&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"next"</span>, memento);
	}

<strong>	@Override
	<span style="color: blue">protected</span> <span style="color: blue">boolean</span> exists() {
		<span style="color: blue">return</span> next.isVoid();
	}
</strong>
	<span style="color: blue">public</span> String getName() {
		<span style="color: blue">return</span> name;
	}

}
</pre>
<p>Notice that the exists method uses <strong>isVoid</strong> rather than <strong>isEmpty</strong>. The difference is significant. An empty query is one that currently returns no objects. A void query is one that never has. Objects that return false from exists are not included in query results. So if a successor is created and then "destroyed", the query will again be empty. It will not, however, be void.</p>
<p>When the project began, its name was first set to "WSE". Later, the name was changed to "Indigo". The ProjectName "Indigo" replaced "WSE" and caused its next query to return an empty result set. Some time later, the ProjectName "WCF" was created. It caused "Indigo" exists to return false, which in turn caused the "WSE" next query to return a non-empty result set. If exists was based on isEmpty, then "WSE" would again show up as a project name. That's not what we want, so we use isVoid instead. Once isVoid is true, it can never go back to being false.</p>
<p><strong>The property query</strong><br />The Project needs to know about its ProjectName successors to determine its current name. So we add a query to the Project class to find them. This query will only return the ProjectNames that still exist. Because of their exists method, this will only be the leaves of the tree. Any ProjectName that has been replaced will have a successor and therefore no longer exist.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> Project <span style="color: blue">extends</span> CorrespondenceObject {

<strong>	<span style="color: blue">private</span> Query&lt;ProjectName&gt; name = <span style="color: blue">new</span> Query&lt;ProjectName&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"project_name"</span>);
</strong>	<span style="color: blue">private</span> Query&lt;Issue&gt; issue = <span style="color: blue">new</span> Query&lt;Issue&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"project_issue"</span>);

	<span style="color: blue">private</span> @Field UUID id;

	<span style="color: blue">public</span> Project() {
		id = UUID.randomUUID();
	}

	<span style="color: blue">public</span> Project(Memento memento) {
	}

	<span style="color: blue">public</span> Iterable&lt;Issue&gt; getIssues() {
		<span style="color: blue">return</span> issue;
	}

}
</pre>
<p><strong>The getter and setter</strong><br />The property query gives us all the information we need to get and set the property value. The current value of the property is based on the leaves of the version history tree, which is precisely what the query returns. If there is no conflict, then there is only one leaf. If there is a conflict, then we can resolve it. For now, we'll take the easy way out and return the most recent conflicting version. Other strategies are possible.</p>
<p>When setting the property, we want to replace all current versions of it. The predecessors of the new ProjectName are all of the leaves of the version history tree. This technique allows the user to resolve a conflict by entering the correct value of the property. All of the conflicting versions are replaced by the one correct version. The branches of the tree are grafted together and we end up with just one leaf. No more conflict.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> Project <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: blue">private</span> Query&lt;ProjectName&gt; name = <span style="color: blue">new</span> Query&lt;ProjectName&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"project_name"</span>);
	<span style="color: blue">private</span> Query&lt;Issue&gt; issue = <span style="color: blue">new</span> Query&lt;Issue&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"project_issue"</span>);

	<span style="color: blue">private</span> @Field UUID id;

	<span style="color: blue">public</span> Project() {
		id = UUID.randomUUID();
	}

	<span style="color: blue">public</span> Project(Memento memento) {
	}

<strong>	<span style="color: blue">public</span> String getName() {
		<span style="color: green">// Get the most recent leaf.</span>
		ProjectName leaf = name.getLast();
		<span style="color: blue">if</span> (leaf == <span style="color: blue">null</span>)
			<span style="color: blue">return</span> <span style="color: maroon">"&lt;New Project&gt;"</span>;
		<span style="color: blue">else</span>
			<span style="color: blue">return</span> leaf.getName();
	}

	<span style="color: blue">public</span> <span style="color: blue">void</span> setName(String name) {
		getCommunity().addObject(<span style="color: blue">new</span> ProjectName(<span style="color: blue">this</span>, <span style="color: blue">this</span>.name.getObjectList(), name));
	}
</strong>
	<span style="color: blue">public</span> Iterable&lt;Issue&gt; getIssues() {
		<span style="color: blue">return</span> issue;
	}

}
</pre>
<p>By following these five steps, we define a mutable property for a Correspondence object. Instead of allowing mutation to be a primitive of the system, we implement mutation as a pattern. This allows the core system to remain synchronization friendly while giving us the behavior that users expect.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index44be.html?p=276#respond" title="Comment on Coding mutable properties">No Comments &#187;</a></p>

			</div>

				<div class="post">
				<h3 id="post-275"><a href="index0b1f.html?p=275" rel="bookmark" title="Permanent Link to How to delete a Correspondence object">How to delete a Correspondence object</a></h3>
				<small>Wednesday, November 5th, 2008</small>

				<div class="entry">
					<p>A Correspondence object records the fact that an atomic operation has taken place. No matter what happens in the future, the fact remains that that operation occurred. No action can truly expunge an object.</p>
<p>But one atomic operation can negate the effect of another. It can leave the system as a whole in a state equivalent to one in which the first operation never happened. At least from an application point-of-view.</p>
<p>So the way to delete a Correspondence object is to create a successor that negates it.</p>
<p><strong>The exists method</strong><br />
The CorrespondenceObject base class defines a method called <strong>exists</strong>. A derived class overrides this method to return true if the object exists, or false if it does not. This test must be performed by examining the results of queries. So the method returns true if the query for negating objects returns an empty set.</p>
<p>Suppose we want the ability to delete an issue in our bug tracking system. To do so, we have to define a new class called <strong>IssueDelete</strong> that causes the issue not to exist. We'll start with this simple definition.</p>
<pre>@Correspondence<span style="color: blue">
public</span> <span style="color: blue">class</span> IssueDelete <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: green">// Issue that was deleted.</span>
	<span style="color: blue">private</span> PredecessorObj&lt;Issue&gt; issue;

	<span style="color: blue">public</span> IssueDelete(Issue issue) {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, issue);
	}

	<span style="color: blue">public</span> IssueDelete(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, memento);
	}
}</pre>
<p>The Issue class is modified to query for <strong>IssueDelete</strong> successors and to cease to exist when one is found.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> Issue <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: green">// The project to which this issue belogs.</span>
	<span style="color: blue">private</span> PredecessorObj&lt;Project&gt; project;

<strong>	<span style="color: green">// Query for deletion of this issue.</span>
	<span style="color: blue">private</span> Query&lt;IssueDelete&gt; delete = <span style="color: blue">new</span> Query&lt;IssueDelete&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"issue_delete"</span>);
</strong>
	<span style="color: green">// Identity.</span>
	<span style="color: blue">private</span> @Field UUID id;

	<span style="color: blue">public</span> Issue(Project project) {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_issue"</span>, project);
		<span style="color: blue">this</span>.id = UUID.randomUUID();
	}

	<span style="color: blue">public</span> Issue(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.project = <span style="color: blue">new</span> PredecessorObj&lt;Project&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"project_issue"</span>, memento);
	}

	<span style="color: blue">public</span> Project getProject() {
		<span style="color: blue">return</span> project.getObject();
	}

<strong>	@Override
	<span style="color: blue">protected</span> <span style="color: blue">boolean</span> exists() {
		<span style="color: blue">return</span> delete.isEmpty();
	}

	<span style="color: blue">public</span> <span style="color: blue">void</span> delete() {
		getCommunity().addObject(<span style="color: blue">new</span> IssueDelete(<span style="color: blue">this</span>));
	}
</strong>}</pre>
<p>The <strong>delete</strong> query looks for successors in the "issue_delete" role of the type <strong>IssueDelete</strong>. If any such objects are created, the results of this query will no longer be empty. That will cause the <strong>exists</strong> method to return false. Just such an object is created in the <strong>delete</strong> method. Notice that the object is added to the <strong>Community</strong>, which is the repository for all Correspondence objects. We'll have a lot more to say about the Community in later posts.</p>
<p><strong>Restore a deleted object</strong><br />
But this feature is not finished. While the <strong>IssueDelete</strong> class makes it possible to delete an issue, that deletion cannot be undone. Just like any other atomic operation, the fact that the deletion occurred cannot be expunged. In order to undo the deletion, we need to delete <strong>IssueDelete</strong>.</p>
<p>We do this by creating a class called <strong>IssueRestore</strong>.</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> IssueRestore <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: green">// The deletion to undo.</span>
	<span style="color: blue">private</span> PredecessorObj&lt;IssueDelete&gt; delete;

	<span style="color: blue">public</span> IssueRestore(IssueDelete delete) {
		<span style="color: blue">this</span>.delete = <span style="color: blue">new</span> PredecessorObj&lt;IssueDelete&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"undo"</span>, delete);
	}

	<span style="color: blue">public</span> IssueRestore(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.delete = <span style="color: blue">new</span> PredecessorObj&lt;IssueDelete&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"undo"</span>, memento);
	}
}</pre>
<p>And then we modify <strong>IssueDelete</strong> to exist only when there are no such successors:</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> IssueDelete <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: green">// Issue that was deleted.</span>
	<span style="color: blue">private</span> PredecessorObj&lt;Issue&gt; issue;

<strong>	<span style="color: green">// Query for restore.</span>
	<span style="color: blue">private</span> Query&lt;IssueRestore&gt; restore = <span style="color: blue">new</span> Query&lt;IssueRestore&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"undo"</span>);
</strong>
	<span style="color: blue">public</span> IssueDelete(Issue issue) {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, issue);
	}

	<span style="color: blue">public</span> IssueDelete(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, memento);
	}

<strong>	@Override
	<span style="color: blue">protected</span> <span style="color: blue">boolean</span> exists() {
		<span style="color: blue">return</span> restore.isEmpty();
	}
</strong>}</pre>
<p><strong>Uniqueness of a deletion</strong><br />
We are almost done. There's just one last problem. Delete an issue, and it disappears. Restore it, and it comes back. But if we delete it a second time, nothing happens. Why?</p>
<p>The set of an object's predecessors and fields is its identity. If you create an instance of the same class with the same predecessors and fields, you will get the same object. The second time we attempt to delete an issue, we only succeed in reasserting the existence of the first deletion. For this system to work, deletions must be unique.</p>
<p>To make an object unique, we give it a unique field. We add a UUID to <strong>IssueDelete</strong>:</p>
<pre>@Correspondence
<span style="color: blue">public</span> <span style="color: blue">class</span> IssueDelete <span style="color: blue">extends</span> CorrespondenceObject {

	<span style="color: green">// Issue that was deleted.</span>
	<span style="color: blue">private</span> PredecessorObj&lt;Issue&gt; issue;

	<span style="color: green">// Query for restore.</span>
	<span style="color: blue">private</span> Query&lt;IssueRestore&gt; restore = <span style="color: blue">new</span> Query&lt;IssueRestore&gt;(<span style="color: blue">this</span>)
		.joinSuccessors(<span style="color: maroon">"undo"</span>);

<strong>	<span style="color: green">// Identity.</span>
	<span style="color: blue">private</span> @Field UUID id;
</strong>
	<span style="color: blue">public</span> IssueDelete(Issue issue) {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, issue);
<strong>		id = UUID.randomUUID();
</strong>	}

	<span style="color: blue">public</span> IssueDelete(Memento memento) <span style="color: blue">throws</span> CorrespondenceException {
		<span style="color: blue">this</span>.issue = <span style="color: blue">new</span> PredecessorObj&lt;Issue&gt;(<span style="color: blue">this</span>, <span style="color: maroon">"issue_delete"</span>, memento);
	}

	@Override
	<span style="color: blue">protected</span> <span style="color: blue">boolean</span> exists() {
		<span style="color: blue">return</span> restore.isEmpty();
	}
}</pre>
<p>And so with this pattern a Correspondence object can be deleted, restored, and deleted again. Deletion and restoration both represent atomic operations, and are therefore both recorded as new objects. Although they represent modifications of the object graph from an application point-of-view, these Correspondence objects adhere to the law that an object is immutable. As we've discussed in previous posts, this is the law that makes synchronization possible.</p>
				</div>

				<p class="postmetadata">Posted in <a href="indexb60a.html?cat=27" title="View all posts in Historic Modeling" rel="category">Historic Modeling</a> |   <a href="index0b1f.html?p=275#respond" title="Comment on How to delete a Correspondence object">No Comments &#187;</a></p>

			</div>

		
		<div class="navigation">
			<div class="alignleft"><a href="index6991.html?cat=27&amp;paged=3">&laquo; Previous Entries</a></div>
			<div class="alignright"><a href="indexb60a.html?cat=27">Next Entries &raquo;</a></div>
		</div>

	
	</div>
		</td>
	</tr>
</table>

<hr />
<div id="footer">
<!-- If you'd like to support WordPress, having the "powered by" link someone on your blog is the best way, it's our only promotion or advertising. -->
	<p>
		Adventures in Software is proudly powered by 
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="indexd784.html?feed=rss2">Entries (RSS)</a>
		and <a href="indexa6da.html?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 17 queries. 0.823 seconds. -->
	</p>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-389401-3");
pageTracker._trackPageview();
} catch(err) {}</script></div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<div id="sk2-footer" style="color:#FFF; background-color:#444; padding: 3px 2px 3px 2px; border-top: #888 solid 1px;">This blog is protected by <a href="http://unknowngenius.com/blog/" title="Dave">dr Dave</a>'s <strong><a href="http://unknowngenius.com/blog/wordpress/spam-karma/" title="SK2">Spam Karma 2</a></strong>: <strong>274531</strong>  Spams eaten and counting...</div><script type="text/javascript" src="replies.js"></script>
<script type="text/javascript" src="blogger.js"></script>
<script type="text/javascript" src="http://twitter.com/statuses/user_timeline/michaellperry.json?callback=twitterCallback2&amp;count=5"></script>
<script type="text/javascript" src="http://search.twitter.com/search.json?q=@michaellperry&amp;callback=twitterCallbackReplies&amp;rpp=5"></script>
</body>

<!-- Mirrored from adventuresinsoftware.com/blog/?cat=27&paged=2 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Jan 2017 13:03:01 GMT -->
</html>
